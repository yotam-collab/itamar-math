<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>תרגול כפל - איתמר</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&family=Orbitron:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* ====== CSS Custom Properties - SPACE THEME ====== */
        :root {
            --color-primary: #6C63FF;
            --color-primary-light: #8B83FF;
            --color-primary-dark: #5046E5;
            --color-success: #00E676;
            --color-success-light: #69F0AE;
            --color-error: #FF5252;
            --color-error-light: #FF8A80;
            --color-warning: #FFD740;
            --color-star: #FFD700;
            --color-coin: #FFC107;
            --color-neon-blue: #00E5FF;
            --color-neon-pink: #FF4081;
            --color-neon-green: #76FF03;
            --color-neon-purple: #E040FB;

            --gradient-nebula: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-aurora: linear-gradient(135deg, #00E5FF 0%, #E040FB 100%);
            --gradient-solar: linear-gradient(135deg, #FF6D00 0%, #FFD740 100%);
            --gradient-cosmic: linear-gradient(135deg, #6C63FF 0%, #00E5FF 100%);
            --gradient-plasma: linear-gradient(135deg, #FF4081 0%, #FF9100 100%);
            --gradient-void: linear-gradient(135deg, #1a1a3e 0%, #2d1b69 100%);

            --bg-main: #0a0a1a;
            --bg-card: rgba(15, 15, 40, 0.92);
            --bg-card-solid: #0f0f28;
            --text-primary: #E8E8FF;
            --text-secondary: #9090C0;
            --text-on-primary: #FFFFFF;

            --space-border: 2px solid rgba(108, 99, 255, 0.4);
            --space-border-glow: 2px solid rgba(108, 99, 255, 0.7);

            --radius-sm: 8px;
            --radius-md: 14px;
            --radius-lg: 18px;
            --radius-xl: 24px;

            --shadow-sm: 0 0 10px rgba(108, 99, 255, 0.2);
            --shadow-md: 0 0 20px rgba(108, 99, 255, 0.25);
            --shadow-lg: 0 0 30px rgba(108, 99, 255, 0.3), 0 0 60px rgba(108, 99, 255, 0.1);
            --shadow-glow: 0 0 25px rgba(108, 99, 255, 0.6), 0 0 50px rgba(108, 99, 255, 0.2);
            --shadow-neon: 0 0 10px currentColor, 0 0 20px currentColor;

            --font-family: 'Assistant', 'Segoe UI', Tahoma, sans-serif;
            --font-display: 'Orbitron', 'Assistant', sans-serif;
        }

        /* ====== Reset & Base ====== */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; direction: rtl; }
        body {
            font-family: var(--font-family);
            background: var(--bg-main);
            background-image:
                radial-gradient(ellipse at 20% 50%, rgba(108, 99, 255, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(0, 229, 255, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, rgba(224, 64, 251, 0.05) 0%, transparent 50%);
            min-height: 100dvh;
            overflow-x: hidden;
            color: var(--text-primary);
            position: relative;
        }

        /* Twinkling stars background */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,0.6) 0%, transparent 100%),
                radial-gradient(1px 1px at 30% 65%, rgba(255,255,255,0.5) 0%, transparent 100%),
                radial-gradient(1px 1px at 55% 15%, rgba(255,255,255,0.7) 0%, transparent 100%),
                radial-gradient(1px 1px at 70% 40%, rgba(255,255,255,0.4) 0%, transparent 100%),
                radial-gradient(1px 1px at 85% 75%, rgba(255,255,255,0.6) 0%, transparent 100%),
                radial-gradient(2px 2px at 15% 80%, rgba(108,99,255,0.8) 0%, transparent 100%),
                radial-gradient(1px 1px at 45% 50%, rgba(255,255,255,0.5) 0%, transparent 100%),
                radial-gradient(1px 1px at 90% 10%, rgba(255,255,255,0.6) 0%, transparent 100%),
                radial-gradient(2px 2px at 60% 90%, rgba(0,229,255,0.6) 0%, transparent 100%),
                radial-gradient(1px 1px at 25% 35%, rgba(255,255,255,0.5) 0%, transparent 100%),
                radial-gradient(1px 1px at 75% 55%, rgba(255,255,255,0.4) 0%, transparent 100%),
                radial-gradient(1px 1px at 5% 50%, rgba(255,255,255,0.6) 0%, transparent 100%),
                radial-gradient(1px 1px at 95% 45%, rgba(255,255,255,0.5) 0%, transparent 100%),
                radial-gradient(1px 1px at 40% 85%, rgba(255,255,255,0.4) 0%, transparent 100%),
                radial-gradient(2px 2px at 50% 30%, rgba(224,64,251,0.5) 0%, transparent 100%);
            animation: twinkle 4s ease-in-out infinite alternate;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes twinkle {
            0% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* ====== Floating Background Decorations ====== */
        .bg-decorations {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        .bg-symbol {
            position: absolute;
            font-size: 2rem;
            opacity: 0.06;
            animation: floatSpace 12s ease-in-out infinite;
            color: var(--color-neon-blue);
            font-family: var(--font-display);
            text-shadow: 0 0 10px currentColor;
        }

        /* ====== Screen System ====== */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 1.5rem 1.5rem 3rem 1.5rem;
            min-height: 100dvh;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            overflow-y: scroll;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        .screen > * {
            flex-shrink: 0;
        }
        .screen.screen-active {
            display: flex;
        }
        .screen.screen-enter {
            animation: screenSlideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .screen.screen-exit {
            animation: screenSlideOut 0.3s ease-in forwards;
        }

        /* Staggered button entrance on welcome screen */
        #screen-welcome.screen-enter .flex-col > button:nth-child(1),
        #screen-welcome.screen-enter .flex-col > .btn:nth-child(1) { animation: btnPopIn 0.45s cubic-bezier(0.16, 1, 0.3, 1) 0.10s both; }
        #screen-welcome.screen-enter .flex-col > button:nth-child(2),
        #screen-welcome.screen-enter .flex-col > .btn:nth-child(2) { animation: btnPopIn 0.45s cubic-bezier(0.16, 1, 0.3, 1) 0.16s both; }
        #screen-welcome.screen-enter .flex-col > button:nth-child(3),
        #screen-welcome.screen-enter .flex-col > .btn:nth-child(3) { animation: btnPopIn 0.45s cubic-bezier(0.16, 1, 0.3, 1) 0.22s both; }
        #screen-welcome.screen-enter .flex-col > button:nth-child(4),
        #screen-welcome.screen-enter .flex-col > .btn:nth-child(4) { animation: btnPopIn 0.45s cubic-bezier(0.16, 1, 0.3, 1) 0.28s both; }
        #screen-welcome.screen-enter .flex-col > button:nth-child(5),
        #screen-welcome.screen-enter .flex-col > .btn:nth-child(5) { animation: btnPopIn 0.45s cubic-bezier(0.16, 1, 0.3, 1) 0.34s both; }
        #screen-welcome.screen-enter .flex-col > button:nth-child(6),
        #screen-welcome.screen-enter .flex-col > .btn:nth-child(6) { animation: btnPopIn 0.45s cubic-bezier(0.16, 1, 0.3, 1) 0.40s both; }
        #screen-welcome.screen-enter .flex-col > button:nth-child(7),
        #screen-welcome.screen-enter .flex-col > .btn:nth-child(7) { animation: btnPopIn 0.45s cubic-bezier(0.16, 1, 0.3, 1) 0.46s both; }
        #screen-welcome.screen-enter .flex-col > button:nth-child(8),
        #screen-welcome.screen-enter .flex-col > .btn:nth-child(8) { animation: btnPopIn 0.45s cubic-bezier(0.16, 1, 0.3, 1) 0.52s both; }
        #screen-welcome.screen-enter .flex-col > button:nth-child(n+9) { animation: btnPopIn 0.45s cubic-bezier(0.16, 1, 0.3, 1) 0.58s both; }

        /* Welcome screen profile entrance */
        #screen-welcome.screen-enter .itamar-photo-welcome { animation: profileBounce 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) 0.05s both; }
        #screen-welcome.screen-enter .welcome-title { animation: titleReveal 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.1s both; }
        #screen-welcome.screen-enter .mission-card { animation: btnPopIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.15s both; }

        /* ====== Card - Space Panel ====== */
        .card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: 2rem;
            border: var(--space-border);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 560px;
            position: relative;
            overflow: hidden;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--color-primary), var(--color-neon-blue), transparent);
            opacity: 0.6;
        }

        /* ====== Typography ====== */
        .title-hero {
            font-size: 2.4rem; font-weight: 900; text-align: center;
            font-family: var(--font-display); letter-spacing: 3px;
            background: linear-gradient(135deg, #fff, var(--color-neon-blue), var(--color-primary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
            filter: drop-shadow(0 0 10px rgba(108, 99, 255, 0.3));
        }
        .title-lg {
            font-size: 1.6rem; font-weight: 700; text-align: center;
            font-family: var(--font-display); letter-spacing: 2px;
            color: var(--text-primary);
        }
        .title-md {
            font-size: 1.2rem; font-weight: 700; text-align: center;
            font-family: var(--font-display); letter-spacing: 1px;
            color: var(--text-primary);
        }
        .subtitle { font-size: 1.05rem; font-weight: 600; color: var(--text-secondary); text-align: center; }

        /* ====== Buttons ====== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 2rem;
            border: var(--space-border);
            border-radius: var(--radius-md);
            font-family: var(--font-display);
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.25s cubic-bezier(0.16, 1, 0.3, 1), box-shadow 0.25s ease, filter 0.25s ease, background 0.25s ease, border-color 0.25s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            letter-spacing: 1px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }
        .btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            filter: brightness(1.12);
        }
        .btn:active { transform: scale(0.96); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            color: var(--text-on-primary);
            box-shadow: 0 0 20px rgba(108, 99, 255, 0.4);
            border-color: rgba(108, 99, 255, 0.6);
        }
        .btn-primary:hover:not(:disabled) {
            box-shadow: 0 0 30px rgba(108, 99, 255, 0.6), 0 8px 25px rgba(108, 99, 255, 0.3), inset 0 0 12px rgba(255,255,255,0.1);
            border-color: rgba(108, 99, 255, 0.9);
            transform: translateY(-4px) scale(1.03);
            filter: brightness(1.15);
        }

        .btn-success {
            background: linear-gradient(135deg, #00C853, #00E676);
            color: #0a0a1a;
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.3);
            border-color: rgba(0, 230, 118, 0.5);
        }

        .btn-outline {
            background: rgba(108, 99, 255, 0.08);
            color: var(--color-primary-light);
            border: var(--space-border);
        }
        .btn-outline:hover {
            background: rgba(108, 99, 255, 0.2);
            border-color: rgba(108, 99, 255, 0.6);
            box-shadow: 0 0 18px rgba(108, 99, 255, 0.25), inset 0 0 12px rgba(108, 99, 255, 0.08);
        }

        .btn-lg {
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            border-radius: var(--radius-lg);
        }

        .btn-block { width: 100%; }

        .btn-icon {
            width: 48px;
            height: 48px;
            padding: 0;
            border-radius: 50%;
            font-size: 1.3rem;
        }

        /* ====== Number Grid ====== */
        .number-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.8rem;
            margin: 1.5rem 0;
        }
        .number-btn {
            width: 100%;
            aspect-ratio: 1;
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: var(--radius-md);
            font-size: 1.6rem;
            font-weight: 900;
            font-family: var(--font-display);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
            overflow: hidden;
        }
        .number-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 60%);
            pointer-events: none;
        }
        .number-btn:active { transform: scale(0.93); }
        .number-btn.selected {
            box-shadow: 0 0 0 3px var(--color-neon-blue), 0 0 25px rgba(0, 229, 255, 0.4);
            transform: scale(1.06);
            border-color: var(--color-neon-blue);
        }
        .number-btn.selected::before {
            content: '\2713';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 22px;
            height: 22px;
            background: var(--color-neon-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: #0a0a1a;
            font-weight: 900;
            z-index: 2;
        }

        /* Number colors - space nebula gradients */
        .number-btn[data-num="1"] { background: linear-gradient(135deg, #FF1744, #D50000); }
        .number-btn[data-num="2"] { background: linear-gradient(135deg, #2979FF, #0D47A1); }
        .number-btn[data-num="3"] { background: linear-gradient(135deg, #00E676, #00C853); }
        .number-btn[data-num="4"] { background: linear-gradient(135deg, #FF9100, #FF6D00); }
        .number-btn[data-num="5"] { background: linear-gradient(135deg, #E040FB, #AA00FF); }
        .number-btn[data-num="6"] { background: linear-gradient(135deg, #00E5FF, #0091EA); }
        .number-btn[data-num="7"] { background: linear-gradient(135deg, #6C63FF, #4527A0); }
        .number-btn[data-num="8"] { background: linear-gradient(135deg, #FF4081, #C51162); }
        .number-btn[data-num="9"] { background: linear-gradient(135deg, #76FF03, #64DD17); }
        .number-btn[data-num="10"] { background: linear-gradient(135deg, #FFD740, #FFAB00); color: #1a1a2e; text-shadow: none; }
        .number-btn[data-num="11"] { background: linear-gradient(135deg, #18FFFF, #00B8D4); color: #1a1a2e; text-shadow: none; }
        .number-btn[data-num="12"] { background: linear-gradient(135deg, #FF6E40, #DD2C00); }

        /* ====== Answer Grid ====== */
        .answer-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.8rem;
            margin: 1.5rem 0;
        }
        .answer-btn {
            padding: 1.2rem;
            border: 2px solid rgba(108, 99, 255, 0.4);
            border-radius: var(--radius-md);
            font-size: 1.7rem;
            font-weight: 800;
            font-family: var(--font-display);
            background: rgba(20, 20, 55, 0.95);
            color: #FFFFFF;
            cursor: pointer;
            transition: all 0.25s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 70px;
            box-shadow: 0 0 15px rgba(108, 99, 255, 0.15);
            position: relative;
            overflow: hidden;
        }
        /* Scanning beam effect on hover */
        .answer-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(108, 99, 255, 0.15), rgba(0, 229, 255, 0.1), transparent);
            transition: left 0.4s ease;
            pointer-events: none;
        }
        .answer-btn:hover:not(.disabled)::before {
            left: 100%;
        }
        .answer-btn:hover:not(.disabled) {
            border-color: var(--color-neon-blue);
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.35), 0 0 60px rgba(108, 99, 255, 0.15), inset 0 0 20px rgba(108, 99, 255, 0.08);
            background: rgba(25, 25, 65, 0.98);
            transform: scale(1.03);
            color: var(--color-neon-blue);
            text-shadow: 0 0 12px rgba(0, 229, 255, 0.5);
        }
        .answer-btn:active:not(.disabled) { transform: scale(0.95); box-shadow: 0 0 15px rgba(108, 99, 255, 0.3); }
        .answer-btn.disabled { pointer-events: none; opacity: 0.7; }
        .answer-btn.correct {
            background: linear-gradient(135deg, #00C853, #00E676);
            border-color: var(--color-success);
            color: #FFFFFF;
            box-shadow: 0 0 30px rgba(0, 230, 118, 0.5);
            animation: correctGlow 0.5s ease;
        }
        .answer-btn.wrong {
            background: linear-gradient(135deg, #D50000, #FF1744);
            border-color: var(--color-error);
            color: #FFFFFF;
            box-shadow: 0 0 30px rgba(255, 82, 82, 0.5);
            animation: wrongShake 0.5s ease;
        }
        .answer-btn.reveal-correct {
            border-color: var(--color-success);
            background: rgba(0, 230, 118, 0.2);
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.3);
            color: var(--color-success);
        }

        /* ====== Progress Bar ====== */
        .progress-container {
            width: 100%;
            height: 10px;
            background: rgba(108, 99, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin: 0.75rem 0;
            border: 1px solid rgba(108, 99, 255, 0.2);
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-neon-blue));
            border-radius: 5px;
            transition: width 0.4s ease;
            box-shadow: 0 0 10px rgba(108, 99, 255, 0.5);
        }

        /* ====== Stats Bar ====== */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            padding: 0.5rem 0;
            flex-wrap: wrap;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .stat-icon { font-size: 1.3rem; }

        /* ====== Question Display ====== */
        .question-display {
            text-align: center;
            padding: 1.5rem 0;
        }
        .question-text {
            font-size: 2.8rem;
            font-weight: 900;
            font-family: var(--font-display);
            color: var(--text-primary);
            direction: ltr;
            unicode-bidi: bidi-override;
            text-shadow: 0 0 20px rgba(108, 99, 255, 0.4);
            letter-spacing: 4px;
        }
        .question-label {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-family: var(--font-display);
            letter-spacing: 1px;
        }

        /* ====== Timer Bar ====== */
        .timer-container {
            width: 100%;
            height: 6px;
            background: rgba(108, 99, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }
        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-neon-blue));
            border-radius: 3px;
            transition: width 1s linear;
            box-shadow: 0 0 8px rgba(108, 99, 255, 0.5);
        }
        .timer-fill.warning { background: linear-gradient(90deg, var(--color-warning), #FF9100); box-shadow: 0 0 8px rgba(255, 215, 64, 0.5); }
        .timer-fill.danger { background: linear-gradient(90deg, var(--color-error), #FF1744); box-shadow: 0 0 8px rgba(255, 82, 82, 0.5); animation: timerPulse 0.5s ease infinite; }
        .timer-display {
            text-align: center;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-family: var(--font-display);
            color: var(--color-neon-blue);
        }

        /* ====== Avatar Grid ====== */
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.8rem;
            margin: 1.5rem 0;
        }
        .avatar-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            padding: 0.75rem;
            border: var(--space-border);
            border-radius: var(--radius-md);
            background: rgba(108, 99, 255, 0.06);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-family);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .avatar-btn:active { transform: scale(0.95); }
        .avatar-btn.selected {
            border-color: var(--color-neon-blue);
            box-shadow: 0 0 0 2px rgba(0, 229, 255, 0.3), 0 0 20px rgba(0, 229, 255, 0.2);
            transform: scale(1.05);
            background: rgba(0, 229, 255, 0.08);
        }
        .avatar-emoji { font-size: 2.5rem; }
        .avatar-name { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); }

        /* ====== Difficulty Cards ====== */
        .difficulty-grid {
            display: grid;
            gap: 0.6rem;
            margin: 1.5rem 0;
        }
        .difficulty-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.2rem;
            border: var(--space-border);
            border-radius: var(--radius-md);
            background: rgba(108, 99, 255, 0.06);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-family);
            text-align: right;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .difficulty-btn:active { transform: scale(0.97); }
        .difficulty-btn:hover { border-color: var(--color-primary-light); box-shadow: var(--shadow-sm); }
        .difficulty-icon { font-size: 2rem; }
        .difficulty-info { flex: 1; }
        .difficulty-name { font-size: 1.05rem; font-weight: 700; font-family: var(--font-display); letter-spacing: 1px; color: var(--text-primary); }
        .difficulty-desc { font-size: 0.8rem; color: var(--text-secondary); }

        /* ====== Summary ====== */
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.8rem;
            margin: 1.5rem 0;
        }
        .summary-stat {
            text-align: center;
            padding: 1rem;
            border-radius: var(--radius-md);
            background: rgba(108, 99, 255, 0.08);
            border: 1px solid rgba(108, 99, 255, 0.2);
        }
        .summary-stat-value { font-size: 1.8rem; font-weight: 900; font-family: var(--font-display); }
        .summary-stat-label { font-size: 0.8rem; color: var(--text-secondary); }

        /* ====== Achievement Cards ====== */
        .achievement-list { display: grid; gap: 0.6rem; margin: 1rem 0; }
        .achievement-card {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            background: rgba(108, 99, 255, 0.06);
            border: var(--space-border);
        }
        .achievement-card.unlocked {
            border-color: rgba(255, 215, 0, 0.4);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.08), rgba(255, 171, 0, 0.05));
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.15);
        }
        .achievement-card.locked { opacity: 0.35; filter: grayscale(0.6); }
        .achievement-icon { font-size: 2rem; }
        .achievement-info { flex: 1; }
        .achievement-name { font-weight: 700; font-size: 0.95rem; color: var(--text-primary); }
        .achievement-desc { font-size: 0.75rem; color: var(--text-secondary); }

        /* ====== Weekly Calendar ====== */
        .week-calendar {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        .week-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }
        .week-day-name { font-size: 0.65rem; color: var(--text-secondary); font-weight: 600; }
        .week-day-dot {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            background: rgba(108, 99, 255, 0.1);
            border: 1px solid rgba(108, 99, 255, 0.2);
            font-family: var(--font-display);
            color: var(--text-secondary);
        }
        .week-day-dot.active { background: linear-gradient(135deg, var(--color-success), #00C853); color: #0a0a1a; box-shadow: 0 0 12px rgba(0, 230, 118, 0.3); border-color: var(--color-success); }
        .week-day-dot.today { border: 2px solid var(--color-neon-blue); box-shadow: 0 0 10px rgba(0, 229, 255, 0.3); }

        /* ====== Reward Popup ====== */
        .reward-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }
        .reward-overlay.visible { display: flex; }
        .reward-popup {
            background: var(--bg-card-solid);
            border-radius: var(--radius-xl);
            padding: 2.5rem 2rem;
            text-align: center;
            max-width: 400px;
            width: 100%;
            animation: warpIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            border: var(--space-border-glow);
            box-shadow: var(--shadow-lg);
        }
        .reward-popup-icon { font-size: 4rem; margin-bottom: 0.5rem; }
        .reward-popup-title { font-size: 1.3rem; font-weight: 800; margin-bottom: 0.5rem; font-family: var(--font-display); letter-spacing: 1px; color: var(--text-primary); }
        .reward-popup-desc { font-size: 0.95rem; color: var(--text-secondary); margin-bottom: 1.5rem; }

        /* ====== Confetti ====== */
        #confetti-container {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 200;
            overflow: hidden;
        }
        .confetti-piece {
            position: absolute;
            top: -20px;
            animation: confettiFall linear forwards;
        }

        /* ====== Star Float ====== */
        .float-reward {
            position: fixed;
            pointer-events: none;
            z-index: 50;
            font-size: 2rem;
            animation: starFloat 1.2s ease-out forwards;
        }

        /* ====== Level Bar ====== */
        .level-bar {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 1rem 0;
        }
        .level-badge {
            padding: 0.3rem 0.8rem;
            border-radius: var(--radius-sm);
            color: white;
            font-weight: 700;
            font-size: 0.75rem;
            white-space: nowrap;
            font-family: var(--font-display);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 0 10px rgba(108, 99, 255, 0.3);
            letter-spacing: 1px;
        }
        .level-progress {
            flex: 1;
            height: 10px;
            background: rgba(108, 99, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            border: 1px solid rgba(108, 99, 255, 0.2);
        }
        .level-progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
            box-shadow: 0 0 8px rgba(108, 99, 255, 0.4);
        }

        /* ====== Mistake Review Table ====== */
        .mistakes-list { margin: 1rem 0; }
        .mistake-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 0.5rem;
            background: rgba(108, 99, 255, 0.06);
            border: 1px solid rgba(108, 99, 255, 0.15);
        }
        .mistake-fact { font-size: 1.1rem; font-weight: 700; direction: ltr; display: inline-block; color: var(--text-primary); font-family: var(--font-display); }
        .mistake-accuracy {
            font-size: 0.85rem;
            font-weight: 700;
            padding: 0.2rem 0.6rem;
            border-radius: var(--radius-sm);
        }
        .mistake-accuracy.low { background: rgba(255, 82, 82, 0.15); color: var(--color-error); }
        .mistake-accuracy.mid { background: rgba(255, 215, 64, 0.15); color: var(--color-warning); }
        .mistake-accuracy.high { background: rgba(0, 230, 118, 0.15); color: var(--color-success); }

        /* ====== Spacing Helpers ====== */
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .gap-1 { gap: 0.75rem; }
        .flex-col { display: flex; flex-direction: column; }
        .flex-row { display: flex; flex-direction: row; align-items: center; }
        .text-center { text-align: center; }
        .w-full { width: 100%; }

        /* ====== Animations ====== */
        @keyframes warpIn {
            0% { transform: scale(0.8) translateY(20px); opacity: 0; filter: blur(5px); }
            100% { transform: scale(1) translateY(0); opacity: 1; filter: blur(0); }
        }
        @keyframes warpOut {
            0% { transform: scale(1); opacity: 1; filter: blur(0); }
            100% { transform: scale(0.9) translateY(-20px); opacity: 0; filter: blur(5px); }
        }
        @keyframes screenSlideUp {
            0% { transform: translateY(40px) scale(0.95); opacity: 0; filter: blur(6px); }
            50% { filter: blur(0); }
            100% { transform: translateY(0) scale(1); opacity: 1; filter: blur(0); }
        }
        @keyframes screenSlideOut {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-30px) scale(0.92); opacity: 0; filter: blur(4px); }
        }
        @keyframes btnPopIn {
            0% { transform: translateY(25px) scale(0.85); opacity: 0; }
            60% { transform: translateY(-4px) scale(1.02); opacity: 1; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes profileBounce {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(3deg); opacity: 1; }
            70% { transform: scale(0.95) rotate(-1deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        @keyframes titleReveal {
            0% { transform: translateY(15px); opacity: 0; letter-spacing: 8px; }
            100% { transform: translateY(0); opacity: 1; letter-spacing: inherit; }
        }
        /* keep old names as aliases */
        @keyframes slideIn {
            0% { transform: scale(0.8) translateY(20px); opacity: 0; filter: blur(5px); }
            100% { transform: scale(1) translateY(0); opacity: 1; filter: blur(0); }
        }
        @keyframes slideOut {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.9) translateY(-20px); opacity: 0; }
        }
        @keyframes correctGlow {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(0,230,118,0); }
            50% { transform: scale(1.06); box-shadow: 0 0 40px rgba(0,230,118,0.5); }
            100% { transform: scale(1); box-shadow: 0 0 25px rgba(0,230,118,0.4); }
        }
        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.06); }
            100% { transform: scale(1); }
        }
        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            60% { transform: translateX(-5px); }
            80% { transform: translateX(5px); }
        }
        @keyframes starFloat {
            0% { opacity: 1; transform: translateY(0) scale(0.5); }
            50% { opacity: 1; transform: translateY(-50px) scale(1.3); }
            100% { opacity: 0; transform: translateY(-100px) scale(0.8); }
        }
        @keyframes confettiFall {
            0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        @keyframes achievementSlideIn {
            0% { transform: scale(0.5) translateY(-40px); opacity: 0; filter: blur(5px); }
            60% { transform: scale(1.03) translateY(5px); opacity: 1; filter: blur(0); }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        @keyframes floatSpace {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.06; }
            33% { transform: translateY(-15px) rotate(5deg); opacity: 0.1; }
            66% { transform: translateY(8px) rotate(-3deg); opacity: 0.04; }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-15px) rotate(5deg); }
            66% { transform: translateY(8px) rotate(-3deg); }
        }
        @keyframes timerPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes bounceIn {
            0% { transform: scale(0); }
            60% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes streakFire {
            0%, 100% { filter: brightness(1); transform: scale(1); }
            50% { filter: brightness(1.4); transform: scale(1.15); }
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 15px rgba(108, 99, 255, 0.3); }
            50% { box-shadow: 0 0 30px rgba(108, 99, 255, 0.6); }
        }

        /* ====== Itamar Photo Styles ====== */
        .itamar-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--color-primary);
            box-shadow: 0 0 20px rgba(108, 99, 255, 0.4);
        }
        .itamar-photo-welcome {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--color-neon-blue);
            box-shadow: 0 0 25px rgba(0, 229, 255, 0.4), 0 0 50px rgba(0, 229, 255, 0.15);
            margin-bottom: 0.5rem;
            animation: pulseGlow 3s ease-in-out infinite;
        }
        .itamar-photo-practice {
            position: absolute;
            top: 12px;
            left: 12px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--color-primary-light);
            box-shadow: 0 0 10px rgba(108, 99, 255, 0.3);
            z-index: 5;
        }
        .itamar-photo-summary {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--color-neon-blue);
            box-shadow: 0 0 25px rgba(0, 229, 255, 0.4);
            margin: 0 auto 0.5rem auto;
            display: block;
            animation: summaryPhotoEntrance 0.6s ease-out;
        }
        @keyframes summaryPhotoEntrance {
            0% { transform: scale(0) rotate(-20deg); opacity: 0; }
            60% { transform: scale(1.15) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .practice-bubble {
            position: absolute;
            top: 8px;
            left: 65px;
            background: rgba(15, 15, 40, 0.9);
            border: 1px solid rgba(108, 99, 255, 0.3);
            border-radius: 12px 12px 12px 2px;
            padding: 4px 10px;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--color-neon-blue);
            white-space: nowrap;
            z-index: 5;
            animation: bounceIn 0.3s ease;
        }
        .feedback-photo-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 60;
            pointer-events: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .feedback-photo-container.visible { display: flex; }
        .feedback-photo-container.visible.correct-feedback {
            animation: feedbackZoomCorrect 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .feedback-photo-container.visible.wrong-feedback {
            animation: feedbackShakeWrong 0.7s ease;
        }
        .feedback-photo {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--color-neon-blue);
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.5);
        }
        .feedback-photo.wrong-photo {
            border-color: var(--color-error);
            box-shadow: 0 0 30px rgba(255, 82, 82, 0.5);
        }
        .feedback-text {
            margin-top: 12px;
            font-size: 1.6rem;
            font-weight: 800;
            font-family: var(--font-display);
            color: #0a0a1a;
            background: var(--color-success);
            padding: 8px 28px;
            border-radius: 8px;
            display: inline-block;
            border: none;
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.4);
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .feedback-text.wrong-text {
            background: var(--color-warning);
            color: #1a1a2e;
            box-shadow: 0 0 20px rgba(255, 215, 64, 0.4);
        }
        /* Energy rings behind correct photo */
        .feedback-starburst {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 2px solid rgba(0, 229, 255, 0.4);
            animation: energyRingExpand 0.6s ease-out forwards;
            pointer-events: none;
        }
        .feedback-starburst:nth-child(2) {
            animation-delay: 0.1s;
            border-color: rgba(108, 99, 255, 0.3);
        }
        @keyframes feedbackZoomCorrect {
            0% { transform: scale(0.1) rotate(-15deg); opacity: 0; }
            50% { transform: scale(1.15) rotate(5deg); opacity: 1; }
            70% { transform: scale(0.95) rotate(-2deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        @keyframes feedbackShakeWrong {
            0% { transform: scale(0.5); opacity: 0; }
            30% { transform: scale(1.05); opacity: 1; }
            40% { transform: translateX(-12px); }
            50% { transform: translateX(12px); }
            60% { transform: translateX(-8px); }
            70% { transform: translateX(8px); }
            80% { transform: translateX(-4px); }
            90% { transform: translateX(4px); }
            100% { transform: translateX(0); opacity: 1; }
        }
        @keyframes energyRingExpand {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }
        @keyframes starburstExpand {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(2.5); opacity: 0; }
        }

        /* ====== Mastery Board ====== */
        .mastery-container {
            width: 100%;
            max-width: 700px;
        }
        .mastery-legend {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }
        .mastery-legend-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .mastery-legend-dot {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        .mastery-filter-bar {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .mastery-filter-btn {
            padding: 0.35rem 0.8rem;
            border: 1px solid rgba(108, 99, 255, 0.2);
            border-radius: 20px;
            background: rgba(108, 99, 255, 0.06);
            font-family: var(--font-family);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            color: var(--text-secondary);
        }
        .mastery-filter-btn:active { transform: scale(0.95); }
        .mastery-filter-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
            box-shadow: 0 0 10px rgba(108, 99, 255, 0.3);
        }
        .mastery-grid-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 0.5rem;
        }
        .mastery-grid {
            display: grid;
            /* Default 12; overridden dynamically by JS for 10 */
            grid-template-columns: 36px repeat(12, 1fr);
            grid-template-rows: 36px repeat(12, 1fr);
            gap: 3px;
            min-width: 450px;
            direction: ltr;
        }
        .mastery-header {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 800;
            color: var(--text-secondary);
            background: rgba(108, 99, 255, 0.06);
            border-radius: 4px;
            font-family: var(--font-display);
        }
        .mastery-corner {
            background: transparent;
        }
        .mastery-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 700;
            font-family: var(--font-display);
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            min-width: 32px;
            min-height: 32px;
            border: 1px solid rgba(108, 99, 255, 0.15);
        }
        .mastery-cell:active { transform: scale(0.9); }
        .mastery-cell:hover { box-shadow: 0 0 12px rgba(108, 99, 255, 0.4); transform: scale(1.08); }
        .mastery-cell.mastery-none { background: rgba(108, 99, 255, 0.08); color: var(--text-secondary); }
        .mastery-cell.mastery-low { background: rgba(255, 82, 82, 0.25); color: #FF8A80; border-color: rgba(255, 82, 82, 0.3); }
        .mastery-cell.mastery-mid { background: rgba(255, 215, 64, 0.2); color: #FFD740; border-color: rgba(255, 215, 64, 0.3); }
        .mastery-cell.mastery-high { background: rgba(0, 230, 118, 0.2); color: #69F0AE; border-color: rgba(0, 230, 118, 0.3); }
        .mastery-cell.mastery-hidden { opacity: 0.1; pointer-events: none; }

        /* Mastery Detail Modal */
        .mastery-detail-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }
        .mastery-detail-overlay.visible { display: flex; }
        .mastery-detail-popup {
            background: var(--bg-card-solid);
            border-radius: var(--radius-xl);
            padding: 2rem;
            text-align: center;
            max-width: 340px;
            width: 100%;
            animation: achievementSlideIn 0.4s ease;
            border: var(--space-border-glow);
            box-shadow: var(--shadow-lg);
        }
        .mastery-detail-fact {
            font-size: 2.2rem;
            font-weight: 900;
            font-family: var(--font-display);
            margin-bottom: 0.5rem;
            direction: ltr;
            display: inline-block;
            letter-spacing: 3px;
            color: var(--color-neon-blue);
            text-shadow: 0 0 15px rgba(0, 229, 255, 0.4);
        }
        .mastery-detail-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin: 1rem 0;
        }
        .mastery-detail-stat {
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            background: rgba(108, 99, 255, 0.08);
        }
        .mastery-detail-stat-value { font-size: 1.2rem; font-weight: 800; font-family: var(--font-display); color: var(--text-primary); }
        .mastery-detail-stat-label { font-size: 0.7rem; color: var(--text-secondary); }
        .mastery-detail-bar {
            height: 8px;
            background: rgba(108, 99, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 0.75rem 0;
        }
        .mastery-detail-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* ====== Reset Confirm Dialog ====== */
        .confirm-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 150;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }
        .confirm-overlay.visible { display: flex; }
        .confirm-popup {
            background: var(--bg-card-solid);
            border-radius: var(--radius-xl);
            padding: 2rem;
            text-align: center;
            max-width: 380px;
            width: 100%;
            animation: achievementSlideIn 0.35s ease;
            border: var(--space-border-glow);
            box-shadow: var(--shadow-lg);
        }
        .confirm-popup-icon { font-size: 3.5rem; margin-bottom: 0.75rem; }
        .confirm-popup-title { font-size: 1.15rem; font-weight: 800; margin-bottom: 0.5rem; font-family: var(--font-display); letter-spacing: 1px; color: var(--text-primary); }
        .confirm-popup-desc { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.5; }
        .confirm-buttons { display: flex; gap: 0.75rem; }
        .confirm-buttons .btn { flex: 1; }
        .btn-danger {
            background: linear-gradient(135deg, var(--color-error), #FF1744);
            color: white;
            box-shadow: 0 0 15px rgba(255, 82, 82, 0.3);
            border-color: rgba(255, 82, 82, 0.5);
        }

        /* Settings toggle row */
        .settings-toggle-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding: 0.75rem 1rem;
            background: rgba(108, 99, 255, 0.08);
            border-radius: 12px;
            border: 1px solid rgba(108, 99, 255, 0.15);
        }
        .settings-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 600;
        }
        .toggle-group {
            display: flex;
            gap: 0;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(108, 99, 255, 0.3);
        }
        .toggle-option {
            padding: 0.4rem 1rem;
            font-size: 0.85rem;
            font-weight: 700;
            font-family: var(--font-family);
            border: none;
            cursor: pointer;
            transition: all 0.25s ease;
            background: rgba(15, 15, 40, 0.6);
            color: var(--text-secondary);
        }
        .toggle-option:first-child {
            border-right: 1px solid rgba(108, 99, 255, 0.2);
        }
        .toggle-option.active {
            background: var(--gradient-cosmic);
            color: #fff;
            text-shadow: 0 0 8px rgba(0, 229, 255, 0.5);
            box-shadow: 0 0 12px rgba(108, 99, 255, 0.3);
        }
        .toggle-option:hover:not(.active) {
            background: rgba(108, 99, 255, 0.15);
            color: var(--text-primary);
        }

        .reset-trigger {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(108, 99, 255, 0.15);
            text-align: center;
        }
        .reset-link {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-family: var(--font-family);
            font-size: 0.8rem;
            cursor: pointer;
            text-decoration: underline;
            opacity: 0.4;
            transition: opacity 0.2s;
        }
        .reset-link:hover { opacity: 0.8; }

        /* ====== Genius Mode ====== */
        .btn-genius {
            background: linear-gradient(135deg, #FFD700, #FFA500, #FF6347);
            color: #1a0a2e;
            font-weight: 800;
            font-size: 1.1rem;
            border: 2px solid #FFD700;
            text-shadow: 0 1px 2px rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3), 0 4px 15px rgba(255, 165, 0, 0.2);
            animation: geniusBtnPulse 2s ease-in-out infinite;
        }
        .btn-genius:hover {
            box-shadow: 0 0 35px rgba(255, 215, 0, 0.6), 0 8px 25px rgba(255, 165, 0, 0.5), inset 0 0 15px rgba(255,255,255,0.15);
            transform: translateY(-4px) scale(1.03);
            filter: brightness(1.15) saturate(1.2);
        }
        @keyframes geniusBtnPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.3), 0 4px 15px rgba(255, 165, 0, 0.2); }
            50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.5), 0 4px 20px rgba(255, 165, 0, 0.4); }
        }

        .genius-mode .card {
            border: 2px solid rgba(255, 215, 0, 0.4);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.15), 0 0 60px rgba(255, 165, 0, 0.08);
            animation: geniusCardEntry 0.6s ease-out 1.8s both;
        }
        @keyframes geniusCardEntry {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .genius-mode .question-text {
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 165, 0, 0.3);
        }
        .genius-mode .practice-timer-fill {
            background: linear-gradient(90deg, #FFD700, #FFA500, #FF6347) !important;
        }

        /* Genius title bar */
        #genius-title-bar {
            text-align: center;
            margin-bottom: 0.75rem;
            position: relative;
            padding: 0.5rem 0;
        }
        .genius-title-text {
            font-family: var(--font-display);
            font-size: 1.6rem;
            font-weight: 900;
            color: #FFD700;
            text-shadow:
                0 0 10px rgba(255, 215, 0, 0.8),
                0 0 20px rgba(255, 215, 0, 0.6),
                0 0 40px rgba(255, 165, 0, 0.4),
                0 0 60px rgba(255, 100, 0, 0.2);
            animation: neonFlicker 3s ease-in-out infinite;
            letter-spacing: 0.05em;
        }
        @keyframes neonFlicker {
            0%, 100% {
                text-shadow:
                    0 0 10px rgba(255, 215, 0, 0.8),
                    0 0 20px rgba(255, 215, 0, 0.6),
                    0 0 40px rgba(255, 165, 0, 0.4),
                    0 0 60px rgba(255, 100, 0, 0.2);
            }
            50% {
                text-shadow:
                    0 0 15px rgba(255, 215, 0, 1),
                    0 0 30px rgba(255, 215, 0, 0.8),
                    0 0 50px rgba(255, 165, 0, 0.6),
                    0 0 80px rgba(255, 100, 0, 0.3);
            }
        }

        /* Sparkles container */
        .genius-sparkles {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            overflow: hidden;
        }
        .genius-sparkle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            animation: sparkleFloat 0.8s ease-out forwards;
        }
        .genius-sparkle::before, .genius-sparkle::after {
            content: '';
            position: absolute;
            background: inherit;
            border-radius: 50%;
        }
        .genius-sparkle::before {
            width: 100%; height: 2px;
            top: 50%; left: 0;
            transform: translateY(-50%);
        }
        .genius-sparkle::after {
            width: 2px; height: 100%;
            top: 0; left: 50%;
            transform: translateX(-50%);
        }
        @keyframes sparkleFloat {
            0% {
                opacity: 1;
                transform: scale(0) translateY(0);
            }
            50% {
                opacity: 1;
                transform: scale(1.5) translateY(-10px);
            }
            100% {
                opacity: 0;
                transform: scale(0.5) translateY(-25px);
            }
        }

        /* Correct answer flash on genius title */
        .genius-title-flash {
            animation: titleFlash 0.5s ease-out;
        }
        @keyframes titleFlash {
            0% {
                color: #fff;
                text-shadow:
                    0 0 20px rgba(255, 255, 255, 1),
                    0 0 40px rgba(255, 215, 0, 1),
                    0 0 60px rgba(255, 215, 0, 0.8),
                    0 0 80px rgba(255, 165, 0, 0.6),
                    0 0 100px rgba(255, 100, 0, 0.4);
                transform: scale(1.1);
            }
            100% {
                color: #FFD700;
                text-shadow:
                    0 0 10px rgba(255, 215, 0, 0.8),
                    0 0 20px rgba(255, 215, 0, 0.6),
                    0 0 40px rgba(255, 165, 0, 0.4),
                    0 0 60px rgba(255, 100, 0, 0.2);
                transform: scale(1);
            }
        }

        /* Warp entry overlay */
        .warp-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9999;
            background: #000;
            pointer-events: none;
            animation: warpFade 2.4s ease-in forwards;
        }
        @keyframes warpFade {
            0% { opacity: 1; }
            75% { opacity: 1; }
            100% { opacity: 0; }
        }
        .warp-overlay canvas {
            width: 100%;
            height: 100%;
        }

        /* Genius summary */
        .genius-summary-score {
            font-size: 3rem;
            font-weight: 900;
            color: #FFD700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 165, 0, 0.3);
            font-family: var(--font-display);
            margin: 0.5rem 0;
        }
        .genius-summary-label {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        .genius-highscore {
            font-size: 0.9rem;
            color: #FFA500;
            margin-top: 0.25rem;
        }

        /* Genius sound controls */
        .genius-sound-controls {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.35rem;
        }
        .genius-sound-btn {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 0.2rem 0.6rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .genius-sound-btn:hover {
            background: rgba(255, 215, 0, 0.2);
        }
        .genius-sound-btn.muted {
            opacity: 0.35;
            border-color: rgba(255, 255, 255, 0.15);
        }

        /* Genius high score displays */
        .genius-highscore-welcome {
            font-size: 0.85rem;
            color: #FFA500;
            font-weight: 700;
            margin-top: 0.25rem;
            text-shadow: 0 0 8px rgba(255, 165, 0, 0.3);
        }
        .genius-hs-inline {
            display: inline-block;
            font-size: 0.75em;
            background: rgba(0,0,0,0.25);
            padding: 0.15em 0.5em;
            border-radius: 1em;
            margin-right: 0.4em;
            vertical-align: middle;
        }
        .genius-record-line {
            font-size: 0.85rem;
            color: #FFA500;
            font-weight: 600;
            margin-top: 0.15rem;
            text-shadow: 0 0 8px rgba(255, 165, 0, 0.3);
            transition: all 0.3s ease;
        }
        .genius-record-line.new-record {
            color: #FFD700;
            font-size: 1rem;
            animation: newRecordPop 0.6s ease-out;
            text-shadow: 0 0 12px rgba(255, 215, 0, 0.6), 0 0 24px rgba(255, 165, 0, 0.3);
        }
        @keyframes newRecordPop {
            0% { transform: scale(1); }
            40% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        /* ====== Responsive ====== */
        @media (max-width: 480px) {
            html { font-size: 14px; }
            .card { padding: 1.5rem 1rem; }
            .number-grid { grid-template-columns: repeat(3, 1fr); gap: 0.6rem; }
            .avatar-grid { grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
            .question-text { font-size: 2.2rem; }
            .title-hero { font-size: 1.9rem; }
            .stats-bar { gap: 1rem; }
            .itamar-photo-welcome { width: 100px; height: 100px; }
            .itamar-photo-practice { width: 40px; height: 40px; }
            .itamar-photo-summary { width: 90px; height: 90px; }
            .practice-bubble { left: 55px; font-size: 0.6rem; }
            .mastery-cell { min-width: 26px; min-height: 26px; font-size: 0.5rem; }
            .mastery-grid { gap: 2px; min-width: 380px; }
            .mastery-header { font-size: 0.6rem; }
        }
        @media (min-width: 768px) {
            html { font-size: 18px; }
        }

        /* ====== NEW: Question Type Styles ====== */
        .q-label-small {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .answer-btn-tf {
            font-size: 1.3rem !important;
            font-weight: 800 !important;
            padding: 1.2rem 0.5rem !important;
            min-height: 70px;
        }
        .answer-btn-tf.tf-true { border-color: rgba(0, 230, 118, 0.3); }
        .answer-btn-tf.tf-false { border-color: rgba(255, 82, 82, 0.3); }
        .answer-btn-compare { font-size: 1.1rem !important; font-weight: 700 !important; }
        .vs-badge {
            display: inline-block;
            background: var(--gradient-plasma);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 800;
            font-family: var(--font-display);
            margin: 0 0.3rem;
            vertical-align: middle;
        }
        .seq-display {
            font-family: var(--font-display);
            font-size: 1.5rem;
            letter-spacing: 2px;
            color: var(--color-neon-blue);
        }

        /* ====== NEW: Practice Mode Badge ====== */
        .practice-mode-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            background: var(--gradient-cosmic);
            color: white;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        /* ====== NEW: Daily Boost Button ====== */
        .btn-daily-boost {
            background: linear-gradient(135deg, #FF6D00 0%, #FFD740 50%, #FF9100 100%) !important;
            color: #1a1a3e !important;
            font-weight: 800 !important;
            border: none !important;
            position: relative;
            text-shadow: none !important;
            box-shadow: 0 0 20px rgba(255, 109, 0, 0.3), 0 0 40px rgba(255, 215, 64, 0.15);
        }
        .btn-daily-boost:hover {
            box-shadow: 0 0 35px rgba(255, 109, 0, 0.6), 0 8px 25px rgba(255, 215, 64, 0.4), inset 0 0 15px rgba(255,255,255,0.15);
            transform: translateY(-4px) scale(1.03);
            filter: brightness(1.15) saturate(1.2);
        }
        .daily-boost-badge {
            display: inline-block;
            background: rgba(0,0,0,0.2);
            color: white;
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            font-size: 0.65rem;
            margin-right: 0.3rem;
            vertical-align: middle;
        }

        /* ====== NEW: Mission Card ====== */
        .mission-card {
            background: var(--bg-card);
            border: var(--space-border);
            border-radius: var(--radius-md);
            padding: 0.75rem 1rem;
            margin-top: 1rem;
        }
        .mission-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.3rem; }
        .mission-icon { font-size: 1.2rem; }
        .mission-title { font-weight: 700; font-size: 0.85rem; color: var(--color-warning); }
        .mission-desc { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .mission-progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.3rem;
        }
        .mission-progress-fill {
            height: 100%;
            background: var(--gradient-solar);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        .mission-status { font-size: 0.7rem; color: var(--text-secondary); text-align: left; }

        /* ====== NEW: Hint Overlay ====== */
        .hint-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .hint-overlay.visible { opacity: 1; pointer-events: all; }
        .hint-popup {
            background: var(--bg-card-solid);
            border: var(--space-border-glow);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            max-width: 90vw;
            text-align: center;
        }
        .hint-visual { margin-bottom: 1rem; }
        .hint-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 0.75rem; color: var(--color-neon-blue); }
        .hint-array { display: inline-flex; flex-direction: column; gap: 4px; margin: 0.5rem 0; }
        .hint-row { display: flex; gap: 4px; justify-content: center; }
        .hint-dot {
            width: 18px; height: 18px;
            border-radius: 50%;
            background: var(--gradient-aurora);
            box-shadow: 0 0 6px rgba(0, 229, 255, 0.4);
        }
        .hint-count { font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem; }

        /* ====== NEW: Encouragement Flash ====== */
        .encouragement-flash {
            animation: encouragePulse 0.6s ease-in-out 3;
        }
        @keyframes encouragePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); color: var(--color-neon-blue); }
        }

        /* ====== NEW: Progress Messages ====== */
        .progress-messages { text-align: center; }
        .progress-msg {
            font-size: 0.85rem;
            color: var(--color-success-light);
            padding: 0.2rem 0;
            font-weight: 600;
        }
    </style>
</head>
<body>

<!-- Background Decorations -->
<div class="bg-decorations" id="bg-decorations"></div>

<!-- ====== SCREEN: Avatar Selection ====== -->
<div id="screen-avatar" class="screen">
    <div class="card text-center">
        <div class="title-lg mb-1">שלום איתמר!</div>
        <div class="subtitle mb-2">בחר דמות שתלווה אותך</div>
        <div class="avatar-grid" id="avatar-grid"></div>
        <button class="btn btn-primary btn-lg btn-block mt-2" id="btn-avatar-continue" disabled>יאללה!</button>
    </div>
</div>

<!-- ====== SCREEN: Welcome ====== -->
<div id="screen-welcome" class="screen">
    <div class="card text-center">
        <img src="images/welcome.jpg" alt="איתמר" class="itamar-photo-welcome" id="welcome-photo" onerror="this.style.display='none';document.getElementById('welcome-avatar-fallback').style.display=''">
        <div style="font-size: 3.5rem; margin-bottom: 0.25rem; display:none;" id="welcome-avatar-fallback"></div>
        <div class="title-hero mb-1" id="welcome-greeting">שלום איתמר!</div>
        <div class="subtitle" id="welcome-subtitle">בוא ננצח את לוח הכפל! 💪</div>
        <div style="font-size:0.6rem;opacity:0.3;margin-top:2px;">v3.0-genius</div>

        <div class="level-bar mt-2" id="welcome-level-bar">
            <div class="level-badge" id="welcome-level-badge">מתחיל</div>
            <div class="level-progress">
                <div class="level-progress-fill" id="welcome-level-fill" style="width:0%"></div>
            </div>
        </div>

        <div class="stats-bar mt-2" id="welcome-stats">
            <div class="stat-item"><span class="stat-icon">⭐</span><span id="welcome-stars">0</span></div>
            <div class="stat-item"><span class="stat-icon">🪙</span><span id="welcome-coins">0</span></div>
            <div class="stat-item"><span class="stat-icon">🔥</span><span id="welcome-streak">0</span></div>
        </div>

        <div class="week-calendar mt-2" id="welcome-calendar"></div>

        <!-- Daily Mission Card -->
        <div class="mission-card" id="mission-card" style="display:none;">
            <div class="mission-header">
                <span class="mission-icon" id="mission-icon"></span>
                <span class="mission-title">משימת היום</span>
            </div>
            <div class="mission-desc" id="mission-desc"></div>
            <div class="mission-progress-bar"><div class="mission-progress-fill" id="mission-progress-fill" style="width:0%"></div></div>
            <div class="mission-status" id="mission-status"></div>
        </div>

        <div class="flex-col gap-1 mt-3">
            <button class="btn btn-daily-boost btn-lg btn-block" id="btn-daily-boost">☀️  החימום של היום <span class="daily-boost-badge" id="daily-boost-badge"></span></button>
            <button class="btn btn-genius btn-block" id="btn-genius">🧠  אלוף המחוננים <span class="genius-hs-inline" id="genius-highscore-welcome" style="display:none;">🏆 <span id="genius-highscore-val">0</span></span></button>
            <button class="btn btn-primary btn-lg btn-block" id="btn-start-practice">🎯  תרגול חדש</button>
            <button class="btn btn-outline btn-block" id="btn-focus-mode">🎯  תרגול חולשות חכם</button>
            <button class="btn btn-outline btn-block" id="btn-review-mistakes">🔄  חזרה על טעויות</button>
            <button class="btn btn-outline btn-block" id="btn-challenge">⏱️  מצב אתגר</button>
            <button class="btn btn-outline btn-block" id="btn-achievements">🏆  הישגים</button>
            <button class="btn btn-outline btn-block" id="btn-mastery">📊  לוח השליטה שלי</button>
        </div>
        <!-- Settings Toggles -->
        <div class="settings-toggle-row">
            <span class="settings-label">טווח כפל:</span>
            <div class="toggle-group">
                <button class="toggle-option" data-max="10" id="toggle-max-10">עד 10</button>
                <button class="toggle-option" data-max="12" id="toggle-max-12">עד 12</button>
            </div>
        </div>
        <div class="settings-toggle-row">
            <span class="settings-label">מס׳ תשובות:</span>
            <div class="toggle-group">
                <button class="toggle-option" data-answers="4" id="toggle-ans-4">4</button>
                <button class="toggle-option" data-answers="6" id="toggle-ans-6">6</button>
                <button class="toggle-option" data-answers="8" id="toggle-ans-8">8</button>
            </div>
        </div>

        <div class="reset-trigger">
            <button class="reset-link" id="btn-test-sound" style="margin-bottom:8px;color:#00E5FF;">🔊 בדיקת סאונד</button>
            <div id="sound-debug" style="font-size:0.7rem;color:#00E5FF;margin-bottom:8px;min-height:1.2em;"></div>
            <button class="reset-link" id="btn-reset-data">🗑️ איפוס כל הנתונים</button>
        </div>
    </div>
</div>

<!-- ====== SCREEN: Number Selection ====== -->
<div id="screen-numbers" class="screen">
    <div class="card text-center">
        <div class="title-lg mb-1">בחר מספרים לתרגול</div>
        <div class="subtitle">אפשר לבחור כמה שרוצים!</div>
        <div class="number-grid" id="number-grid"></div>
        <button class="btn btn-outline btn-block mt-1" id="btn-select-all">✅  בחר הכל</button>
        <button class="btn btn-success btn-lg btn-block mt-1" id="btn-start-session" disabled>▶  התחל!</button>
        <button class="btn btn-outline btn-block mt-1" id="btn-back-to-welcome">←  חזרה</button>
    </div>
</div>

<!-- ====== SCREEN: Difficulty ====== -->
<div id="screen-difficulty" class="screen">
    <div class="card text-center">
        <div class="title-lg mb-1">בחר רמת קושי</div>
        <div class="difficulty-grid" id="difficulty-grid">
            <button class="difficulty-btn" data-diff="easy">
                <div class="difficulty-icon">😊</div>
                <div class="difficulty-info">
                    <div class="difficulty-name">קל</div>
                    <div class="difficulty-desc">10 שאלות, תשובות רחוקות</div>
                </div>
            </button>
            <button class="difficulty-btn" data-diff="normal">
                <div class="difficulty-icon">💪</div>
                <div class="difficulty-info">
                    <div class="difficulty-name">רגיל</div>
                    <div class="difficulty-desc">15 שאלות, תשובות מעורבות</div>
                </div>
            </button>
            <button class="difficulty-btn" data-diff="hard">
                <div class="difficulty-icon">🔥</div>
                <div class="difficulty-info">
                    <div class="difficulty-name">קשה</div>
                    <div class="difficulty-desc">20 שאלות, תשובות קרובות</div>
                </div>
            </button>
            <button class="difficulty-btn" data-diff="challenge">
                <div class="difficulty-icon">⏱️</div>
                <div class="difficulty-info">
                    <div class="difficulty-name">אתגר עם טיימר!</div>
                    <div class="difficulty-desc">כמה שאפשר ב-60 שניות</div>
                </div>
            </button>
        </div>
        <button class="btn btn-outline btn-block mt-1" id="btn-diff-back">←  חזרה</button>
    </div>
</div>

<!-- ====== SCREEN: Practice ====== -->
<div id="screen-practice" class="screen">
    <div class="card" style="position:relative;">
        <img src="images/practice.jpg" alt="איתמר" class="itamar-photo-practice" id="practice-photo" onerror="this.style.display='none';document.getElementById('practice-bubble')&&(document.getElementById('practice-bubble').style.display='none')">
        <div class="practice-bubble" id="practice-bubble">קדימה!</div>
        <!-- Genius title (genius mode only) -->
        <div id="genius-title-bar" style="display:none;">
            <div class="genius-title-text" id="genius-title-text">🧠 אלוף המחוננים 🧠</div>
            <div class="genius-record-line" id="genius-record-line">🏆 שיא: <span id="genius-record-val">0</span></div>
            <div class="genius-sound-controls">
                <button class="genius-sound-btn" id="btn-toggle-music" title="מוזיקה">🎵</button>
                <button class="genius-sound-btn" id="btn-toggle-sfx" title="אפקטים">🔊</button>
            </div>
            <div class="genius-sparkles" id="genius-sparkles"></div>
        </div>
        <!-- Timer (challenge mode only) -->
        <div id="practice-timer-section" style="display:none;">
            <div class="timer-display" id="practice-timer-display">1:00</div>
            <div class="timer-container">
                <div class="timer-fill" id="practice-timer-fill" style="width:100%"></div>
            </div>
        </div>

        <!-- Mode badge + Progress -->
        <div id="practice-mode-badge" class="practice-mode-badge" style="display:none;"></div>
        <div class="flex-row" style="justify-content:space-between; margin-bottom:0.25rem;">
            <span id="practice-question-num" style="font-size:0.9rem; font-weight:600; color:var(--text-secondary);">1 / 15</span>
            <div class="stats-bar" style="padding:0; gap:1rem;">
                <div class="stat-item"><span class="stat-icon">⭐</span><span id="practice-stars">0</span></div>
                <div class="stat-item"><span class="stat-icon">🔥</span><span id="practice-streak">0</span></div>
            </div>
        </div>
        <div class="progress-container">
            <div class="progress-fill" id="practice-progress" style="width:0%"></div>
        </div>

        <!-- Question -->
        <div class="question-display">
            <div class="question-label">כמה זה?</div>
            <div class="question-text" id="practice-question">7 &times; 8 = ?</div>
        </div>

        <!-- Answer Options -->
        <div class="answer-grid" id="practice-answers"></div>
    </div>
</div>

<!-- ====== SCREEN: Summary ====== -->
<div id="screen-summary" class="screen">
    <div class="card text-center">
        <img src="images/correct.jpg" alt="איתמר" class="itamar-photo-summary" id="summary-photo" onerror="this.style.display='none'">
        <div id="summary-icon" style="font-size:4rem;"></div>
        <div class="title-lg" id="summary-title"></div>
        <div class="subtitle" id="summary-subtitle"></div>

        <div class="summary-stats" id="summary-stats"></div>

        <div id="summary-achievements" class="mt-2"></div>

        <div class="flex-col gap-1 mt-3">
            <button class="btn btn-primary btn-lg btn-block" id="btn-play-again">🎯  תרגול נוסף</button>
            <button class="btn btn-outline btn-block" id="btn-review-after-summary">🔄  חזרה על טעויות</button>
            <button class="btn btn-outline btn-block" id="btn-summary-home">🏠  מסך ראשי</button>
        </div>
    </div>
</div>

<!-- ====== SCREEN: Review Mistakes ====== -->
<div id="screen-review" class="screen">
    <div class="card text-center">
        <div class="title-lg mb-1">🔄 חזרה על טעויות</div>
        <div class="subtitle" id="review-subtitle"></div>
        <div class="mistakes-list" id="review-mistakes-list"></div>
        <div class="flex-col gap-1 mt-2" id="review-actions"></div>
    </div>
</div>

<!-- ====== SCREEN: Achievements ====== -->
<div id="screen-achievements" class="screen">
    <div class="card">
        <div class="title-lg mb-2">🏆 הישגים</div>
        <div class="achievement-list" id="achievements-list"></div>
        <button class="btn btn-outline btn-block mt-2" id="btn-ach-back">←  חזרה</button>
    </div>
</div>

<!-- ====== SCREEN: Mastery Board ====== -->
<div id="screen-mastery" class="screen">
    <div class="mastery-container">
        <div class="card">
            <div class="title-lg mb-1">📊 לוח השליטה של איתמר</div>
            <div class="subtitle mb-2">לחץ על תא כדי לראות פרטים</div>

            <div class="mastery-legend">
                <div class="mastery-legend-item">
                    <div class="mastery-legend-dot" style="background:#C6F6D5;"></div>
                    <span>שולט</span>
                </div>
                <div class="mastery-legend-item">
                    <div class="mastery-legend-dot" style="background:#FEFCBF;"></div>
                    <span>בינוני</span>
                </div>
                <div class="mastery-legend-item">
                    <div class="mastery-legend-dot" style="background:#FEB2B2;"></div>
                    <span>צריך חיזוק</span>
                </div>
                <div class="mastery-legend-item">
                    <div class="mastery-legend-dot" style="background:#E2E8F0;"></div>
                    <span>לא תורגל</span>
                </div>
            </div>

            <div class="mastery-filter-bar" id="mastery-filters">
                <button class="mastery-filter-btn active" data-filter="all">הכל</button>
                <button class="mastery-filter-btn" data-filter="low">🔴 צריך חיזוק</button>
                <button class="mastery-filter-btn" data-filter="mid">🟡 בינוני</button>
                <button class="mastery-filter-btn" data-filter="none">⬜ לא תורגל</button>
            </div>

            <div class="mastery-grid-wrapper">
                <div class="mastery-grid" id="mastery-grid"></div>
            </div>

            <div id="mastery-summary" class="mt-2 text-center subtitle"></div>

            <button class="btn btn-outline btn-block mt-2" id="btn-mastery-back">←  חזרה</button>
        </div>
    </div>
</div>

<!-- ====== Mastery Detail Modal ====== -->
<div class="mastery-detail-overlay" id="mastery-detail-overlay">
    <div class="mastery-detail-popup">
        <div class="mastery-detail-fact" id="mastery-detail-fact">7 × 8 = 56</div>
        <div class="mastery-detail-stats" id="mastery-detail-stats"></div>
        <div class="mastery-detail-bar">
            <div class="mastery-detail-bar-fill" id="mastery-detail-bar-fill"></div>
        </div>
        <div id="mastery-detail-level" style="font-weight:700; margin-bottom:1rem;"></div>
        <button class="btn btn-primary" id="mastery-detail-close">👍 הבנתי</button>
    </div>
</div>

<!-- ====== Hint Overlay (Focus Mode) ====== -->
<div class="hint-overlay" id="hint-overlay">
    <div class="hint-popup">
        <div id="hint-content"></div>
        <button class="btn btn-primary" id="hint-dismiss">הבנתי! 👍</button>
    </div>
</div>

<!-- ====== Photo Feedback Container ====== -->
<div class="feedback-photo-container" id="feedback-photo-container">
    <img src="" alt="איתמר" class="feedback-photo" id="feedback-photo">
    <div class="feedback-text" id="feedback-text"></div>
</div>

<!-- ====== Reward Popup Overlay ====== -->
<div class="reward-overlay" id="reward-overlay">
    <div class="reward-popup">
        <div class="reward-popup-icon" id="reward-icon"></div>
        <div class="reward-popup-title" id="reward-title"></div>
        <div class="reward-popup-desc" id="reward-desc"></div>
        <button class="btn btn-primary" id="reward-dismiss">👍  יופי!</button>
    </div>
</div>

<!-- ====== Reset Confirmation Dialog ====== -->
<div class="confirm-overlay" id="reset-confirm-overlay">
    <div class="confirm-popup">
        <div class="confirm-popup-icon">🔒</div>
        <div class="confirm-popup-title">למחוק את כל הנתונים?</div>
        <div class="confirm-popup-desc">כל ההתקדמות, הכוכבים, המטבעות וההישגים ימחקו לצמיתות.<br>הכנס קוד אישור כדי למחוק:</div>
        <input type="text" id="reset-code-input" placeholder="הכנס קוד..." style="width:100%; padding:0.75rem 1rem; border:1px solid rgba(108,99,255,0.3); border-radius:var(--radius-md); font-family:var(--font-display); font-size:1.1rem; text-align:center; font-weight:700; letter-spacing:3px; margin-bottom:0.5rem; direction:ltr; background:rgba(108,99,255,0.08); color:var(--text-primary);" autocomplete="off">
        <div id="reset-code-error" style="color:var(--color-error); font-size:0.85rem; font-weight:700; min-height:1.5rem; margin-bottom:0.5rem;"></div>
        <div class="confirm-buttons">
            <button class="btn btn-danger" id="btn-reset-confirm">🗑️ מחק</button>
            <button class="btn btn-outline" id="btn-reset-cancel">ביטול</button>
        </div>
    </div>
</div>

<!-- Confetti Container -->
<div id="confetti-container"></div>

<script>
/* ====================================================================
   MULTIPLICATION PRACTICE APP FOR ITAMAR
   ==================================================================== */

// ====== CONSTANTS ======
const AVATARS = [
    { id: 'astronaut', emoji: '\uD83D\uDE80', name: 'אסטרונאוט' },
    { id: 'ninja', emoji: '\uD83E\uDD77', name: "נינג'ה" },
    { id: 'wizard', emoji: '\uD83E\uDDD9', name: 'קוסם' },
    { id: 'robot', emoji: '\uD83E\uDD16', name: 'רובוט' },
    { id: 'dragon', emoji: '\uD83D\uDC09', name: 'דרקון' },
    { id: 'superhero', emoji: '\uD83E\uDDB8', name: 'גיבור על' },
    { id: 'scientist', emoji: '\uD83E\uDDD1\u200D\uD83D\uDD2C', name: 'מדען' },
    { id: 'athlete', emoji: '\uD83C\uDFC6', name: 'אלוף' }
];

const LEVELS = [
    { level: 1, name: 'מתחיל', minPoints: 0, color: '#4CAF50' },
    { level: 2, name: 'לומד', minPoints: 100, color: '#2196F3' },
    { level: 3, name: 'מתרגל', minPoints: 300, color: '#9C27B0' },
    { level: 4, name: 'מתקדם', minPoints: 600, color: '#FF9800' },
    { level: 5, name: 'מומחה', minPoints: 1000, color: '#F44336' },
    { level: 6, name: 'אלוף', minPoints: 2000, color: '#FFD700' },
    { level: 7, name: 'מלך הכפל', minPoints: 5000, color: '#E91E63' }
];

const ACHIEVEMENTS = [
    { id: 'first_star', icon: '\u2B50', name: 'כוכב ראשון', desc: 'ענית נכון על שאלה ראשונה' },
    { id: 'ten_correct', icon: '\uD83C\uDF1F', name: 'עשר נכונות', desc: 'ענית נכון על 10 שאלות' },
    { id: 'fifty_correct', icon: '\uD83C\uDFC5', name: 'חמישים!', desc: 'ענית נכון על 50 שאלות' },
    { id: 'hundred_correct', icon: '\uD83D\uDC51', name: 'מאה!', desc: 'ענית נכון על 100 שאלות' },
    { id: 'streak_5', icon: '\uD83D\uDD25', name: 'רצף חם', desc: '5 תשובות נכונות ברצף' },
    { id: 'streak_10', icon: '\uD83C\uDF0B', name: '!להבה', desc: '10 תשובות נכונות ברצף' },
    { id: 'streak_20', icon: '\uD83C\uDF0B', name: '!הר געש', desc: '20 תשובות נכונות ברצף' },
    { id: 'speed_demon', icon: '\u26A1', name: '!בזק', desc: 'ענית נכון תוך שנייה' },
    { id: 'master_table', icon: '\uD83E\uDD47', name: 'מומחה לטבלה', desc: 'שלטת בלוח כפל של מספר' },
    { id: 'comeback', icon: '\u2764\uFE0F', name: 'לא מוותר', desc: 'תיקנת טעות ישנה' },
    { id: 'daily_3', icon: '\uD83D\uDCC5', name: 'שלושה ימים', desc: 'תרגלת 3 ימים' },
    { id: 'daily_7', icon: '\uD83D\uDCC5', name: '!שבוע שלם', desc: 'תרגלת 7 ימים' },
    { id: 'perfect_session', icon: '\uD83D\uDCAF', name: '!מושלם', desc: 'תרגול ללא אף טעות' },
    { id: 'challenge_complete', icon: '\u23F1\uFE0F', name: '!אתגר', desc: 'סיימת אתגר עם טיימר' },
    { id: 'two_hundred', icon: '\uD83D\uDE80', name: '!מאתיים', desc: 'ענית נכון על 200 שאלות' },
    { id: 'five_hundred', icon: '\uD83D\uDC8E', name: '!חמש מאות', desc: 'ענית נכון על 500 שאלות' },
    { id: 'genius_20', icon: '\uD83E\uDDE0', name: 'מחונן!', desc: 'ענית על 20+ שאלות במצב מחוננים' },
    { id: 'focus_5', icon: '\uD83C\uDFAF', name: 'מתמקד!', desc: 'סיימת 5 תרגולי חולשות' },
    { id: 'daily_streak_3', icon: '\u2600\uFE0F', name: '3 ימים רצופים', desc: '3 חימומים יומיים ברצף' },
    { id: 'daily_streak_7', icon: '\uD83D\uDD25', name: 'שבוע של חימום!', desc: '7 חימומים יומיים ברצף' },
    { id: 'mastery_upgrade', icon: '\uD83D\uDCC8', name: 'שיפור!', desc: 'שיפרת צבע של תרגיל' },
    { id: 'all_green', icon: '\uD83C\uDF1F', name: 'הכל ירוק!', desc: 'כל לוח הכפל ירוק' },
    { id: 'genius_variety', icon: '\uD83E\uDDE9', name: 'מגוון!', desc: '5 סוגי שאלות שונים במצב מחוננים' }
];

const DIFFICULTY_CONFIG = {
    easy:      { questions: 10, distractorMode: 'far', multiplier: 1,   timer: false, showCorrect: true,  retryWrong: true },
    normal:    { questions: 15, distractorMode: 'mixed', multiplier: 1.5, timer: false, showCorrect: true,  retryWrong: true },
    hard:      { questions: 20, distractorMode: 'close', multiplier: 2,   timer: false, showCorrect: 'brief', retryWrong: false },
    challenge: { questions: 999, distractorMode: 'close', multiplier: 3,  timer: 60,   showCorrect: false, retryWrong: false },
    genius:    { questions: 999, distractorMode: 'close', multiplier: 4,  timer: 180,  showCorrect: false, retryWrong: false }
};

// ====== GENIUS QUESTION TYPE CONFIG ======
const GENIUS_QTYPE_CONFIG = {
    weights: {
        standard:     0.35,
        reverse:      0.20,
        trueFalse:    0.15,
        comparison:   0.10,
        reverseMatch: 0.10,
        sequence:     0.05,
        commutative:  0.05
    },
    maxConsecutiveSameType: 3,
    difficultyAdjust: {
        errorsToTrigger: 2,
        streakToTrigger: 5,
        boostStandardBy: 0.15,
        redFactBoost: 2.0
    }
};

// ====== SCORING CONFIG ======
const SCORING_CONFIG = {
    basePoints: 10,
    questionTypeMultipliers: {
        standard: 1.0, reverse: 1.2, trueFalse: 0.9,
        comparison: 1.1, reverseMatch: 1.2, sequence: 1.1, commutative: 1.0
    },
    difficultyMultipliers: {
        easy: 1.0, normal: 1.2, hard: 1.5, challenge: 1.8, genius: 1.8
    },
    masteryZoneMultipliers: {
        high: 1.0, mid: 1.25, low: 1.6, none: 1.15
    },
    speedBonus: {
        fast:   { threshold: 2000, multiplier: 1.5 },
        medium: { threshold: 4000, multiplier: 1.2 }
    },
    sessionBonuses: { accuracy90: 50, accuracy80: 30, accuracy70: 15 },
    improvementBonuses: { redToYellow: 40, yellowToGreen: 60 },
    frustrationShield: {
        errorPenalty: -2,
        normalErrorPenalty: 0,
        consecutiveErrorsForHelp: 3
    },
    streakBonuses: {
        five:  { stars: 3, coins: 5, points: 50 },
        ten:   { stars: 5, coins: 10, points: 100 }
    }
};

// ====== FOCUS MODE CONFIG ======
const FOCUS_CONFIG = {
    maxQuestions: 20,
    minQuestions: 10,
    maxTimeMinutes: 5,
    hintsAfterWrongCount: 2
};

// ====== DAILY BOOST CONFIG ======
const DAILY_BOOST_CONFIG = {
    questionCount: 12,
    maxTimeMinutes: 4,
    mix: { strong: 0.60, medium: 0.30, weak: 0.10 },
    bonuses: { firstDaily: 100, streak3: 50, streak7: 150, streak14: 300 },
    subsequentBonusRatio: 0.3
};

// ====== DAILY MISSION TEMPLATES ======
const MISSION_TEMPLATES = [
    { id: 'turn_reds', desc: 'הפוך 2 אדומים לצהובים', icon: '🔴➡️🟡', target: 2, checkField: 'redsImproved' },
    { id: 'genius_10', desc: '10 נכונות במצב מחוננים', icon: '🧠', target: 10, checkField: 'geniusCorrect' },
    { id: 'streak_7', desc: 'רצף של 7 תשובות נכונות', icon: '🔥', target: 7, checkField: 'bestStreakToday' },
    { id: 'practice_20', desc: 'ענה על 20 שאלות', icon: '📝', target: 20, checkField: 'questionsToday' },
    { id: 'daily_boost', desc: 'השלם את החימום היומי', icon: '☀️', target: 1, checkField: 'dailyBoostDone' },
    { id: 'perfect_mini', desc: 'סיים תרגול בלי טעויות', icon: '💯', target: 1, checkField: 'perfectSession' }
];

const DEFAULT_DATA = {
    version: 2,
    profile: { name: 'איתמר', avatar: null, createdAt: null },
    stats: {
        totalQuestions: 0, totalCorrect: 0, totalWrong: 0,
        totalStars: 0, totalCoins: 0, totalPoints: 0,
        currentStreak: 0, bestStreak: 0, totalSessions: 0,
        dailyBoostStreak: 0, lastDailyBoostDate: null,
        focusModeSessions: 0, dailyBoostSessions: 0
    },
    facts: {},
    currentSession: null,
    achievements: { unlocked: [] },
    daily: {},
    dailyMissions: {},
    settings: { soundEnabled: true, maxMultiplier: 12, answerCount: 4, geniusHighScore: 0 }
};

// ====== STORAGE ======
const Storage = {
    _cache: null,
    STORAGE_KEY: 'itamar_math_app',

    load() {
        if (this._cache) return this._cache;
        try {
            const raw = localStorage.getItem(this.STORAGE_KEY);
            this._cache = raw ? JSON.parse(raw) : JSON.parse(JSON.stringify(DEFAULT_DATA));
        } catch (e) {
            this._cache = JSON.parse(JSON.stringify(DEFAULT_DATA));
        }
        return this._cache;
    },

    save() {
        try {
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this._cache));
        } catch (e) { /* ignore quota errors */ }
    },

    update(mutator) {
        const data = this.load();
        mutator(data);
        this.save();
        return data;
    }
};

// ====== DATA MIGRATION ======
const DataMigration = {
    run() {
        const data = Storage.load();
        if (!data.version || data.version < 2) {
            this._migrateV1toV2(data);
        }
    },
    _migrateV1toV2(data) {
        data.version = 2;
        // Stats
        if (!data.stats.dailyBoostStreak) data.stats.dailyBoostStreak = 0;
        if (!data.stats.lastDailyBoostDate) data.stats.lastDailyBoostDate = null;
        if (!data.stats.focusModeSessions) data.stats.focusModeSessions = 0;
        if (!data.stats.dailyBoostSessions) data.stats.dailyBoostSessions = 0;
        // Settings
        if (!data.settings) data.settings = {};
        if (!data.settings.geniusHighScore) data.settings.geniusHighScore = 0;
        // Daily missions
        if (!data.dailyMissions) data.dailyMissions = {};
        // Upgrade existing daily entries
        Object.keys(data.daily).forEach(dk => {
            const d = data.daily[dk];
            if (d.dailyBoostCompleted === undefined) d.dailyBoostCompleted = false;
            if (!d.dailyBoostCount) d.dailyBoostCount = 0;
            if (!d.factsImproved) d.factsImproved = [];
            if (!d.masteryChanges) d.masteryChanges = [];
        });
        Storage.save();
    }
};

function getMaxMultiplier() {
    const data = Storage.load();
    return (data.settings && data.settings.maxMultiplier) || 12;
}

function getAnswerCount() {
    const data = Storage.load();
    return (data.settings && data.settings.answerCount) || 4;
}

// ====== SOUND ENGINE (Video-Game Style) ======
const SoundEngine = {
    ctx: null,
    _enabled: true,
    _debugEl: null,

    _getCtx() {
        // Always create fresh or resume existing
        try {
            if (!this.ctx || this.ctx.state === 'closed') {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (this.ctx.state === 'suspended') {
                this.ctx.resume();
            }
            return this.ctx;
        } catch(e) {
            console.error('AudioContext error:', e);
            return null;
        }
    },

    init() {
        this._getCtx();
    },

    ensureResumed() {
        this._getCtx();
    },

    // Core tone with envelope
    _tone(ctx, freq, start, dur, type = 'square', vol = 0.18) {
        const t = ctx.currentTime + start;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0, t);
        gain.gain.linearRampToValueAtTime(vol, t + 0.01);
        gain.gain.linearRampToValueAtTime(vol * 0.8, t + dur * 0.6);
        gain.gain.linearRampToValueAtTime(0, t + dur);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(t);
        osc.stop(t + dur + 0.05);
    },

    // Frequency sweep (laser/power-up effects)
    _sweep(ctx, startFreq, endFreq, start, dur, type = 'square', vol = 0.12) {
        const t = ctx.currentTime + start;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(startFreq, t);
        osc.frequency.exponentialRampToValueAtTime(Math.max(endFreq, 20), t + dur);
        gain.gain.setValueAtTime(vol, t);
        gain.gain.linearRampToValueAtTime(0, t + dur);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(t);
        osc.stop(t + dur + 0.05);
    },

    // Noise burst (for percussion/impact)
    _noise(ctx, start, dur, vol = 0.08) {
        const t = ctx.currentTime + start;
        const sampleRate = ctx.sampleRate;
        const bufferSize = Math.max(1, Math.floor(sampleRate * dur));
        const buffer = ctx.createBuffer(1, bufferSize, sampleRate);
        const channelData = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
            channelData[i] = (Math.random() * 2 - 1) * Math.max(0, 1 - i / bufferSize);
        }
        const source = ctx.createBufferSource();
        source.buffer = buffer;
        const gain = ctx.createGain();
        gain.gain.setValueAtTime(vol, t);
        gain.gain.linearRampToValueAtTime(0, t + dur);
        source.connect(gain);
        gain.connect(ctx.destination);
        source.start(t);
    },

    play(name) {
        try {
            // Check if sound is disabled
            const data = Storage.load();
            if (data.settings && data.settings.soundEnabled === false) return;

            // Get or create AudioContext
            if (!this.ctx || this.ctx.state === 'closed') {
                try {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                } catch(e) { return; }
            }

            const ctx = this.ctx;
            const self = this;

            if (ctx.state === 'running') {
                // Context is running, play immediately
                self._play(ctx, name);
            } else if (ctx.state === 'suspended') {
                // Resume and play AFTER resume completes
                ctx.resume().then(function() {
                    self._play(ctx, name);
                }).catch(function() {});
                // Also try playing immediately (works on some browsers)
                try { self._play(ctx, name); } catch(e) {}
            }
        } catch(e) {
            console.error('SoundEngine.play error:', name, e);
        }
    },

    _correctSoundIndex: 0,

    _play(ctx, name) {
        const T = (f, s, d, tp, v) => this._tone(ctx, f, s, d, tp, v);
        const S = (sf, ef, s, d, tp, v) => this._sweep(ctx, sf, ef, s, d, tp, v);
        const N = (s, d, v) => this._noise(ctx, s, d, v);

        switch (name) {

        // ===== CORRECT: 15 rotating sounds =====
        case 'correct': {
            const variant = this._correctSoundIndex % 15;
            this._correctSoundIndex++;
            switch (variant) {
            case 0: // Plasma cannon hit
                S(400, 1800, 0, 0.1, 'sine', 0.30);
                S(600, 2400, 0.02, 0.1, 'triangle', 0.15);
                T(1800, 0.08, 0.12, 'sine', 0.32);
                T(2400, 0.10, 0.08, 'sine', 0.20);
                T(1200, 0.12, 0.25, 'sine', 0.22);
                S(2000, 5000, 0.10, 0.2, 'sine', 0.10);
                N(0, 0.04, 0.08);
                break;
            case 1: // Photon torpedo impact
                S(200, 1200, 0, 0.08, 'sawtooth', 0.18);
                T(880, 0.06, 0.15, 'sine', 0.30);
                T(1320, 0.08, 0.12, 'sine', 0.25);
                T(1760, 0.12, 0.10, 'sine', 0.20);
                S(1500, 4000, 0.12, 0.18, 'sine', 0.08);
                N(0, 0.05, 0.10);
                S(800, 3000, 0.15, 0.2, 'sine', 0.06);
                break;
            case 2: // Shield power-up
                T(330, 0, 0.08, 'sine', 0.22);
                T(440, 0.06, 0.08, 'sine', 0.25);
                T(660, 0.12, 0.08, 'sine', 0.28);
                T(880, 0.18, 0.15, 'sine', 0.32);
                S(880, 2200, 0.22, 0.2, 'sine', 0.15);
                T(1100, 0.25, 0.2, 'sine', 0.12);
                S(2000, 5000, 0.28, 0.15, 'sine', 0.05);
                break;
            case 3: // Quantum teleport
                S(2000, 400, 0, 0.06, 'sine', 0.20);
                S(400, 2500, 0.06, 0.12, 'sine', 0.28);
                T(2500, 0.12, 0.08, 'sine', 0.30);
                T(1800, 0.15, 0.15, 'sine', 0.18);
                S(1200, 4500, 0.15, 0.2, 'sine', 0.08);
                N(0.05, 0.03, 0.06);
                T(2200, 0.20, 0.12, 'sine', 0.10);
                break;
            case 4: // Star collector chime
                T(523, 0, 0.06, 'sine', 0.25);
                T(784, 0.05, 0.06, 'sine', 0.28);
                T(1047, 0.10, 0.08, 'sine', 0.30);
                T(1319, 0.15, 0.12, 'sine', 0.28);
                S(1319, 3000, 0.18, 0.15, 'sine', 0.10);
                T(1047, 0.22, 0.15, 'sine', 0.12);
                N(0.15, 0.03, 0.04);
                break;
            case 5: // Nebula burst
                S(300, 900, 0, 0.12, 'sine', 0.22);
                S(500, 1500, 0.04, 0.10, 'triangle', 0.18);
                T(1200, 0.10, 0.15, 'sine', 0.28);
                S(900, 3500, 0.12, 0.20, 'sine', 0.12);
                T(1800, 0.18, 0.10, 'sine', 0.15);
                N(0.02, 0.06, 0.06);
                break;
            case 6: // Asteroid dodge
                S(1500, 600, 0, 0.05, 'sawtooth', 0.15);
                S(600, 2000, 0.05, 0.10, 'sine', 0.25);
                T(2000, 0.10, 0.08, 'sine', 0.30);
                T(1600, 0.14, 0.12, 'sine', 0.20);
                S(1800, 4000, 0.16, 0.15, 'sine', 0.08);
                N(0, 0.04, 0.07);
                break;
            case 7: // Gravity slingshot
                S(200, 800, 0, 0.15, 'sine', 0.20);
                S(800, 2200, 0.10, 0.12, 'sine', 0.28);
                T(2200, 0.18, 0.10, 'sine', 0.32);
                S(2200, 3800, 0.22, 0.15, 'sine', 0.15);
                T(1500, 0.28, 0.15, 'sine', 0.10);
                N(0.10, 0.05, 0.05);
                break;
            case 8: // Comet trail sparkle
                T(1047, 0, 0.04, 'sine', 0.20);
                T(1319, 0.03, 0.04, 'sine', 0.22);
                T(1568, 0.06, 0.04, 'sine', 0.24);
                T(2093, 0.09, 0.06, 'sine', 0.26);
                T(2637, 0.12, 0.08, 'sine', 0.22);
                S(2637, 5000, 0.15, 0.15, 'sine', 0.08);
                N(0.12, 0.03, 0.03);
                break;
            case 9: // Wormhole entry
                S(2500, 300, 0, 0.08, 'sine', 0.18);
                S(300, 1800, 0.08, 0.15, 'sine', 0.26);
                T(1800, 0.18, 0.12, 'sine', 0.30);
                S(1800, 3200, 0.22, 0.12, 'sine', 0.12);
                T(2400, 0.26, 0.15, 'sine', 0.10);
                N(0.04, 0.05, 0.08);
                break;
            case 10: // Solar flare
                S(150, 600, 0, 0.10, 'sawtooth', 0.15);
                S(600, 2000, 0.06, 0.12, 'sine', 0.25);
                T(2000, 0.12, 0.08, 'sine', 0.30);
                S(1500, 4500, 0.14, 0.18, 'sine', 0.10);
                T(2800, 0.18, 0.12, 'sine', 0.15);
                N(0, 0.08, 0.10);
                break;
            case 11: // Space whale song
                T(220, 0, 0.20, 'sine', 0.22);
                T(330, 0.10, 0.20, 'sine', 0.25);
                S(330, 550, 0.20, 0.15, 'sine', 0.20);
                T(440, 0.30, 0.20, 'sine', 0.28);
                S(440, 880, 0.40, 0.10, 'sine', 0.12);
                break;
            case 12: // Crystal resonance
                T(880, 0, 0.12, 'sine', 0.22);
                T(1109, 0.04, 0.12, 'sine', 0.24);
                T(1319, 0.08, 0.12, 'sine', 0.26);
                T(1760, 0.12, 0.18, 'sine', 0.28);
                S(1760, 3500, 0.20, 0.15, 'sine', 0.10);
                T(1319, 0.25, 0.15, 'sine', 0.12);
                break;
            case 13: // Pulsar ping
                T(2400, 0, 0.03, 'sine', 0.28);
                T(2400, 0.06, 0.03, 'sine', 0.24);
                T(2400, 0.12, 0.03, 'sine', 0.20);
                S(2400, 4800, 0.15, 0.10, 'sine', 0.15);
                T(1200, 0.18, 0.15, 'sine', 0.22);
                T(1800, 0.22, 0.12, 'sine', 0.12);
                N(0, 0.02, 0.04);
                break;
            case 14: // Supernova flash
                N(0, 0.03, 0.12);
                S(200, 3000, 0, 0.15, 'sine', 0.25);
                S(400, 4000, 0.02, 0.12, 'triangle', 0.15);
                T(3000, 0.10, 0.12, 'sine', 0.30);
                T(2400, 0.15, 0.15, 'sine', 0.20);
                S(2000, 6000, 0.15, 0.20, 'sine', 0.08);
                T(1600, 0.22, 0.18, 'sine', 0.12);
                break;
            }
            break;
        }

        // ===== WRONG: Shield down / hull breach =====
        case 'wrong':
            S(600, 120, 0, 0.3, 'sawtooth', 0.22);
            T(150, 0.05, 0.25, 'triangle', 0.25);
            T(90, 0.15, 0.3, 'sawtooth', 0.12);
            N(0, 0.15, 0.18);
            S(400, 100, 0.1, 0.25, 'sine', 0.10);
            break;

        // ===== STREAK: Warp drive charging up =====
        case 'streak':
            S(200, 600, 0, 0.08, 'sine', 0.25);
            S(300, 900, 0.06, 0.08, 'sine', 0.28);
            S(400, 1200, 0.12, 0.08, 'sine', 0.30);
            S(500, 1800, 0.18, 0.10, 'sine', 0.32);
            S(600, 2800, 0.24, 0.14, 'sine', 0.35);
            T(2800, 0.32, 0.2, 'sine', 0.22);
            S(1000, 5000, 0.30, 0.15, 'sine', 0.08);
            N(0.30, 0.08, 0.10);
            break;

        // ===== ACHIEVEMENT: Signal received from deep space =====
        case 'achievement':
            T(523, 0, 0.15, 'sine', 0.28);
            T(659, 0.12, 0.15, 'sine', 0.30);
            T(784, 0.24, 0.15, 'sine', 0.32);
            T(1047, 0.38, 0.3, 'sine', 0.35);
            S(800, 3000, 0.38, 0.25, 'sine', 0.10);
            T(784, 0.56, 0.2, 'sine', 0.18);
            N(0.38, 0.05, 0.06);
            break;

        // ===== LEVEL UP: Hyperdrive jump =====
        case 'levelUp':
            S(100, 400, 0, 0.15, 'sawtooth', 0.20);
            S(400, 1200, 0.10, 0.12, 'sine', 0.28);
            S(1200, 3500, 0.18, 0.10, 'sine', 0.32);
            T(3500, 0.25, 0.3, 'sine', 0.30);
            T(2800, 0.25, 0.3, 'sine', 0.15);
            S(2000, 5000, 0.30, 0.25, 'sine', 0.08);
            N(0.20, 0.15, 0.10);
            break;

        // ===== CLICK: UI scan blip =====
        case 'click':
            S(1500, 2500, 0, 0.04, 'sine', 0.12);
            break;

        // ===== COUNTDOWN: Proximity alert beep =====
        case 'countdown':
            T(1200, 0, 0.06, 'sine', 0.22);
            T(1200, 0, 0.06, 'triangle', 0.08);
            S(1200, 1600, 0, 0.06, 'sine', 0.05);
            break;

        // ===== TIME UP: Emergency power failure =====
        case 'timeUp':
            S(800, 200, 0, 0.5, 'sawtooth', 0.18);
            T(400, 0, 0.15, 'sine', 0.22);
            T(300, 0.15, 0.15, 'sine', 0.20);
            T(200, 0.30, 0.15, 'sine', 0.18);
            T(120, 0.45, 0.35, 'sine', 0.15);
            N(0.10, 0.25, 0.08);
            S(2000, 200, 0.05, 0.6, 'sine', 0.06);
            break;

        // ===== PERFECT: Full fleet salute =====
        case 'perfect':
            S(200, 800, 0, 0.15, 'sine', 0.25);
            T(784, 0.12, 0.12, 'sine', 0.30);
            T(988, 0.22, 0.12, 'sine', 0.32);
            T(1175, 0.32, 0.12, 'sine', 0.34);
            T(1568, 0.44, 0.35, 'sine', 0.38);
            T(1175, 0.44, 0.35, 'sine', 0.15);
            S(1000, 6000, 0.50, 0.3, 'sine', 0.08);
            S(500, 4000, 0.55, 0.25, 'sine', 0.06);
            N(0.44, 0.08, 0.08);
            break;

        // ===== WELCOME: Space station boot-up melody =====
        case 'welcome':
            S(80, 200, 0, 0.3, 'sine', 0.12);
            T(440, 0.15, 0.08, 'sine', 0.18);
            T(554, 0.25, 0.08, 'sine', 0.20);
            T(659, 0.35, 0.08, 'sine', 0.22);
            T(880, 0.45, 0.12, 'sine', 0.25);
            T(880, 0.58, 0.35, 'sine', 0.28);
            T(1109, 0.58, 0.35, 'sine', 0.18);
            T(1319, 0.58, 0.35, 'sine', 0.12);
            S(2000, 5000, 0.65, 0.3, 'sine', 0.06);
            S(1500, 3500, 0.70, 0.25, 'sine', 0.04);
            N(0.58, 0.04, 0.04);
            break;

        // ===== NAVIGATE: Warp jump between screens =====
        case 'navigate':
            S(300, 1200, 0, 0.12, 'sine', 0.18);
            T(1200, 0.08, 0.1, 'sine', 0.12);
            S(2000, 4000, 0.05, 0.1, 'sine', 0.05);
            N(0, 0.03, 0.04);
            break;

        // ===== LAUNCH: Going to practice (countdown to launch) =====
        case 'launch':
            S(100, 300, 0, 0.15, 'sawtooth', 0.15);
            T(400, 0.08, 0.06, 'sine', 0.20);
            T(600, 0.15, 0.06, 'sine', 0.22);
            T(800, 0.22, 0.06, 'sine', 0.24);
            S(400, 2000, 0.28, 0.2, 'sine', 0.28);
            T(2000, 0.35, 0.25, 'sine', 0.18);
            S(1000, 4000, 0.35, 0.2, 'sine', 0.06);
            N(0.28, 0.1, 0.08);
            break;
        }
    }
};

// ====== SPACE MUSIC (Background ambient for Genius mode) ======
const SpaceMusic = {
    ctx: null,
    playing: false,
    _loopTimer: null,

    start() {
        if (this.playing) return;
        try {
            // Share SoundEngine's AudioContext to avoid browser limits and conflicts
            if (SoundEngine.ctx && SoundEngine.ctx.state !== 'closed') {
                this.ctx = SoundEngine.ctx;
            } else {
                SoundEngine.init();
                this.ctx = SoundEngine.ctx;
            }
            if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume();
            this.playing = true;
            this._scheduleLoop();
        } catch(e) {
            console.error('SpaceMusic error:', e);
        }
    },

    _note(freq, start, dur, type, vol) {
        if (!this.ctx || !this.playing) return;
        const ctx = this.ctx;
        const t = ctx.currentTime + start;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0, t);
        gain.gain.linearRampToValueAtTime(vol, t + 0.01);
        gain.gain.setValueAtTime(vol, t + dur * 0.7);
        gain.gain.linearRampToValueAtTime(0, t + dur);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(t);
        osc.stop(t + dur + 0.02);
    },

    _kick(start) {
        if (!this.ctx || !this.playing) return;
        const ctx = this.ctx;
        const t = ctx.currentTime + start;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(160, t);
        osc.frequency.exponentialRampToValueAtTime(35, t + 0.10);
        gain.gain.setValueAtTime(0.14, t);
        gain.gain.linearRampToValueAtTime(0, t + 0.14);
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start(t);
        osc.stop(t + 0.16);
        // Click transient for punch
        const click = ctx.createOscillator();
        const cg = ctx.createGain();
        click.type = 'square';
        click.frequency.value = 1200;
        cg.gain.setValueAtTime(0.06, t);
        cg.gain.linearRampToValueAtTime(0, t + 0.008);
        click.connect(cg);
        cg.connect(ctx.destination);
        click.start(t);
        click.stop(t + 0.01);
    },

    _snare(start) {
        if (!this.ctx || !this.playing) return;
        const ctx = this.ctx;
        const t = ctx.currentTime + start;
        // Noise burst
        const buf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * 0.08), ctx.sampleRate);
        const d = buf.getChannelData(0);
        for (let i = 0; i < d.length; i++) d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / d.length, 1.5);
        const src = ctx.createBufferSource();
        src.buffer = buf;
        const gain = ctx.createGain();
        gain.gain.setValueAtTime(0.09, t);
        gain.gain.linearRampToValueAtTime(0, t + 0.07);
        src.connect(gain);
        gain.connect(ctx.destination);
        src.start(t);
        // Tonal body
        const osc = ctx.createOscillator();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(220, t);
        osc.frequency.exponentialRampToValueAtTime(90, t + 0.04);
        const og = ctx.createGain();
        og.gain.setValueAtTime(0.07, t);
        og.gain.linearRampToValueAtTime(0, t + 0.05);
        osc.connect(og);
        og.connect(ctx.destination);
        osc.start(t);
        osc.stop(t + 0.08);
    },

    _hihat(start, open) {
        if (!this.ctx || !this.playing) return;
        const ctx = this.ctx;
        const t = ctx.currentTime + start;
        const dur = open ? 0.08 : 0.03;
        const buf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * dur), ctx.sampleRate);
        const d = buf.getChannelData(0);
        for (let i = 0; i < d.length; i++) d[i] = (Math.random() * 2 - 1) * (1 - i / d.length);
        const src = ctx.createBufferSource();
        src.buffer = buf;
        const gain = ctx.createGain();
        gain.gain.setValueAtTime(open ? 0.055 : 0.04, t);
        gain.gain.linearRampToValueAtTime(0, t + dur);
        // Bandpass to make it brighter
        const filter = ctx.createBiquadFilter();
        filter.type = 'highpass';
        filter.frequency.value = 7000;
        src.connect(filter);
        filter.connect(gain);
        gain.connect(ctx.destination);
        src.start(t);
    },

    _scheduleLoop() {
        if (!this.playing) return;
        const N = this._note.bind(this);
        const K = this._kick.bind(this);
        const SN = this._snare.bind(this);
        const H = (s, open) => this._hihat(s, open);
        const BPM = 125;
        const beat = 60 / BPM;         // 0.48s
        const eighth = beat / 2;
        const sixteenth = beat / 4;
        const bar = beat * 4;           // ~1.92s
        const loopLen = bar * 4;        // 4 bars = ~7.68s

        // ---- DRUMS: modern funky groove ----
        for (let b = 0; b < 4; b++) {
            const o = b * bar;
            // Kick: 1, 2-and, 4-and (syncopated bounce)
            K(o);
            K(o + beat * 1 + eighth);
            K(o + beat * 2);
            if (b % 2 === 1) K(o + beat * 3 + eighth); // extra groove every other bar
            // Snare: 2 and 4 (backbeat)
            SN(o + beat);
            SN(o + beat * 3);
            // Hi-hats: sixteenth swing with accents
            for (let e = 0; e < 16; e++) {
                const isOpen = (e === 4 || e === 12);   // open on off-beats
                const isGhost = (e % 2 === 1);
                if (!isGhost || Math.random() > 0.3) {
                    H(o + e * sixteenth, isOpen);
                }
            }
        }

        // ---- BASS: groovy synth bass in G major ----
        // Syncopated funky pattern: G2-.-B2-. | D3-C3-B2-. | G2-.-A2-B2 | C3-B2-A2-G2
        const bassPattern = [
            // [freq, beatOffset, duration]
            [98.0,  0,           0.6],   // G2
            [123.5, 1 + 0.5,    0.4],   // B2 syncopated
            [146.8, 2,           0.4],   // D3
            [130.8, 2.5,         0.35],  // C3
            [123.5, 3,           0.4],   // B2
            [98.0,  4,           0.6],   // G2
            [110.0, 5 + 0.5,    0.4],   // A2 syncopated
            [123.5, 6,           0.4],   // B2
            [130.8, 6.5,         0.5],   // C3
            [98.0,  8,           0.6],   // G2
            [123.5, 9 + 0.5,    0.4],   // B2
            [146.8, 10,          0.5],   // D3
            [164.8, 10.5,        0.4],   // E3
            [146.8, 11,          0.3],   // D3
            [130.8, 12,          0.5],   // C3
            [123.5, 12.5,        0.4],   // B2
            [110.0, 13,          0.4],   // A2
            [98.0,  14,          0.8],   // G2
        ];
        for (const [freq, beatOff, dur] of bassPattern) {
            N(freq, beatOff * beat, dur * beat, 'square', 0.065);
        }

        // ---- LEAD: catchy bright melody (sine + triangle) ----
        // G major pentatonic earworm: G4-A4-B4-D5 | E5-D5-B4-A4 | B4-D5-E5-G5 | E5-D5-B4-G4
        const melodyPattern = [
            // [freq, beatOffset, duration]
            [392.0, 0,     0.4],   // G4
            [440.0, 0.5,   0.4],   // A4
            [493.9, 1,     0.5],   // B4
            [587.3, 2,     0.8],   // D5 (hold)
            [659.3, 4,     0.5],   // E5
            [587.3, 4.75,  0.4],   // D5
            [493.9, 5.5,   0.4],   // B4
            [440.0, 6,     0.8],   // A4 (hold)
            [493.9, 8,     0.4],   // B4
            [587.3, 8.5,   0.4],   // D5
            [659.3, 9,     0.5],   // E5
            [784.0, 10,    0.8],   // G5 (hold — high point!)
            [659.3, 12,    0.5],   // E5
            [587.3, 12.75, 0.4],   // D5
            [493.9, 13.5,  0.4],   // B4
            [392.0, 14,    1.0],   // G4 (resolve)
        ];
        for (const [freq, beatOff, dur] of melodyPattern) {
            N(freq, beatOff * beat + sixteenth, dur * beat, 'triangle', 0.055);
            // Double with quiet sine an octave up for shimmer
            N(freq * 2, beatOff * beat + sixteenth, dur * beat * 0.6, 'sine', 0.018);
        }

        // ---- CHORDS: bright stab hits on 1 and 3 ----
        const chords = [
            // bar 0: Gmaj (G4, B4, D5)
            [[392, 493.9, 587.3], 0],
            // bar 1: Cmaj (C4, E4, G4)
            [[261.6, 329.6, 392], 4],
            // bar 2: Dmaj (D4, F#4, A4)
            [[293.7, 370, 440], 8],
            // bar 3: Em (E4, G4, B4)
            [[329.6, 392, 493.9], 12],
        ];
        for (const [notes, beatOff] of chords) {
            for (const f of notes) {
                N(f, beatOff * beat, beat * 0.3, 'sine', 0.025);
                N(f, (beatOff + 2) * beat, beat * 0.25, 'sine', 0.02);
            }
        }

        // ---- SPARKLE: quick arp bursts every 2 bars ----
        const sparkle = [784, 988, 1175, 1319, 1568];
        for (let s = 0; s < sparkle.length; s++) {
            N(sparkle[s], bar * 2 + beat * 3 + s * sixteenth * 0.8, sixteenth * 0.7, 'sine', 0.025);
        }

        // Schedule next loop
        this._loopTimer = setTimeout(() => {
            this._scheduleLoop();
        }, loopLen * 1000 - 100);
    },

    stop() {
        this.playing = false;
        if (this._loopTimer) { clearTimeout(this._loopTimer); this._loopTimer = null; }
        // Don't close the shared AudioContext — just release our reference
        this.ctx = null;
    }
};

// ====== SOUND TEST (temporary debug - remove later) ======
function testSound() {
    try {
        const ac = new (window.AudioContext || window.webkitAudioContext)();
        const stateMsg = 'AudioContext created, state: ' + ac.state;
        ac.resume().then(() => {
            const o = ac.createOscillator();
            const g = ac.createGain();
            o.type = 'sine';
            o.frequency.value = 440;
            g.gain.value = 0.5;
            o.connect(g);
            g.connect(ac.destination);
            o.start();
            o.stop(ac.currentTime + 0.5);
            // Show debug info
            const el = document.getElementById('sound-debug');
            if (el) el.textContent = '✅ Sound OK! state=' + ac.state;
        }).catch(err => {
            const el = document.getElementById('sound-debug');
            if (el) el.textContent = '❌ Resume failed: ' + err.message;
        });
    } catch(e) {
        const el = document.getElementById('sound-debug');
        if (el) el.textContent = '❌ Error: ' + e.message;
        alert('Sound error: ' + e.message);
    }
}

// ====== SPACED REPETITION ======
const SR = {
    factKey(a, b) {
        return a <= b ? `${a}\u00D7${b}` : `${b}\u00D7${a}`;
    },

    parseFact(key) {
        const [a, b] = key.split('\u00D7').map(Number);
        return { a, b };
    },

    getFact(key) {
        const data = Storage.load();
        if (!data.facts[key]) {
            data.facts[key] = {
                ef: 2.5, interval: 0, reps: 0,
                nextReview: null, lastReview: null,
                attempts: 0, correct: 0, wrong: 0,
                history: []
            };
            Storage.save();
        }
        return data.facts[key];
    },

    quality(correct, responseMs) {
        if (!correct) return 0;
        if (responseMs < 2000) return 5;
        if (responseMs < 4000) return 4;
        return 3;
    },

    updateFact(key, q, responseMs) {
        Storage.update(data => {
            const f = data.facts[key];
            if (!f) return;

            f.ef = Math.max(1.3, f.ef + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02)));
            if (q >= 3) {
                if (f.reps === 0) f.interval = 1;
                else if (f.reps === 1) f.interval = 3;
                else f.interval = Math.ceil(f.interval * f.ef);
                f.reps++;
                f.correct++;
            } else {
                f.reps = 0;
                f.interval = 0;
                f.wrong++;
            }
            f.attempts++;
            f.nextReview = new Date(Date.now() + f.interval * 86400000).toISOString();
            f.lastReview = new Date().toISOString();
            f.history.push({ correct: q >= 3, ms: responseMs, date: Date.now() });
            if (f.history.length > 10) f.history.shift();
        });
    },

    generateQuestions(selectedNumbers, count) {
        const allFacts = [];
        const seen = new Set();
        const maxN = getMaxMultiplier();
        for (const n of selectedNumbers) {
            for (let i = 1; i <= maxN; i++) {
                const key = this.factKey(n, i);
                if (seen.has(key)) continue;
                seen.add(key);
                const fact = this.getFact(key);
                allFacts.push({ key, a: n, b: i, fact });
            }
        }

        const weighted = allFacts.map(f => {
            let w = 1;
            if (f.fact.attempts === 0) w = 3;
            else if (f.fact.nextReview && new Date(f.fact.nextReview) <= new Date()) w = 5;
            if (f.fact.wrong > 0) {
                w += (f.fact.wrong / f.fact.attempts) * 10;
            }
            if (f.fact.ef < 2.0) w += 3;
            if (f.fact.history.length > 0 && !f.fact.history[f.fact.history.length - 1].correct) w += 8;
            return { ...f, weight: w };
        });

        const selected = [];
        const pool = [...weighted];
        const targetCount = Math.min(count, pool.length * 2);

        for (let i = 0; i < targetCount; i++) {
            const totalW = pool.reduce((s, p) => s + p.weight, 0);
            let r = Math.random() * totalW;
            for (const item of pool) {
                r -= item.weight;
                if (r <= 0) {
                    selected.push(item);
                    item.weight = Math.max(0.5, item.weight * 0.3);
                    break;
                }
            }
        }
        return selected;
    },

    getFactsNeedingReview() {
        const data = Storage.load();
        return Object.entries(data.facts)
            .filter(([, f]) => f.wrong > 0 && (f.reps < 3 || f.ef < 2.0))
            .sort((a, b) => (b[1].wrong / b[1].attempts) - (a[1].wrong / a[1].attempts))
            .map(([key, fact]) => {
                const { a, b: bNum } = this.parseFact(key);
                return { key, a, b: bNum, fact };
            });
    }
};

// ====== QUESTION GENERATOR ======
const QGen = {
    generate(factKey, difficulty = 'normal') {
        const parsed = SR.parseFact(factKey);
        if (!parsed || isNaN(parsed.a) || isNaN(parsed.b)) {
            return { factKey, a: 2, b: 2, correct: 4, options: [4, 3, 5, 6], correctIdx: 0 };
        }
        const { a, b } = parsed;
        const [da, db] = Math.random() > 0.5 ? [a, b] : [b, a];
        const correct = da * db;
        const numAnswers = getAnswerCount();
        const numDistractors = numAnswers - 1;

        // Build distractors
        const distractors = this._buildDistractors(a, b, correct, difficulty, numDistractors);

        // Build options: correct + distractors, then shuffle
        const optionsArr = [correct, ...distractors.slice(0, numDistractors)];
        this.shuffle(optionsArr);

        // FINAL ASSERT: correct MUST be in options
        if (!optionsArr.includes(correct)) {
            console.error('BUG: correct not in options!', { factKey, a, b, da, db, correct, optionsArr, distractors });
            optionsArr[0] = correct;
            this.shuffle(optionsArr);
        }

        const result = {
            factKey,
            a: da,
            b: db,
            correct,
            options: optionsArr,
            correctIdx: optionsArr.indexOf(correct)
        };

        // Double-check everything is consistent
        if (result.a * result.b !== result.correct) {
            console.error('BUG: a*b !== correct!', result);
            result.correct = result.a * result.b;
            result.options[result.correctIdx] = result.correct;
        }

        return result;
    },

    _buildDistractors(a, b, correct, difficulty, count = 3) {
        const mode = DIFFICULTY_CONFIG[difficulty]?.distractorMode || 'mixed';
        const candidates = new Set();
        const maxN = getMaxMultiplier();

        // Adjacent table entries
        if (b > 1) candidates.add(a * (b - 1));
        if (b < maxN) candidates.add(a * (b + 1));
        if (a > 1) candidates.add((a - 1) * b);
        if (a < maxN) candidates.add((a + 1) * b);
        // Off by operand
        candidates.add(correct + a); candidates.add(correct - a);
        candidates.add(correct + b); candidates.add(correct - b);
        // Digit swap
        if (correct >= 10 && correct < 100) {
            const sw = parseInt(String(correct).split('').reverse().join(''));
            if (sw !== correct && sw > 0) candidates.add(sw);
        }
        // Off by 1/10
        candidates.add(correct + 1); candidates.add(correct - 1);
        candidates.add(correct + 10); candidates.add(correct - 10);

        // Remove correct and invalid values
        candidates.delete(correct);
        let pool = [...candidates].filter(v => v > 0 && v <= 144 && v !== correct);

        // Sort based on difficulty mode
        if (mode === 'far') {
            pool.sort((x, y) => Math.abs(y - correct) - Math.abs(x - correct));
        } else if (mode === 'close') {
            pool.sort((x, y) => Math.abs(x - correct) - Math.abs(y - correct));
        } else {
            this.shuffle(pool);
        }

        // Pick unique distractors
        const picked = [];
        for (const v of pool) {
            if (v !== correct && !picked.includes(v)) {
                picked.push(v);
                if (picked.length >= count) break;
            }
        }

        // Fill remaining slots with random values if needed
        let attempts = 0;
        while (picked.length < count && attempts < 100) {
            attempts++;
            const range = Math.max(20, count * 5);
            const r = Math.max(1, correct + Math.floor(Math.random() * range) - Math.floor(range / 2));
            if (r !== correct && !picked.includes(r) && r > 0 && r <= 144) {
                picked.push(r);
            }
        }

        // Absolute fallback
        while (picked.length < count) {
            const fallback = picked.length + 2;
            if (fallback !== correct && !picked.includes(fallback)) picked.push(fallback);
            else picked.push(correct + picked.length + 1);
        }

        return picked;
    },

    shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }
};

// ====== GENIUS QUESTION GENERATOR ======
const GeniusQGen = {
    _usedQuestions: new Set(),
    _typeHistory: [],
    _consecutiveErrors: 0,
    _currentStreak: 0,
    _adjustedWeights: null,
    _geniusTypesUsed: new Set(),

    reset() {
        this._usedQuestions.clear();
        this._typeHistory = [];
        this._consecutiveErrors = 0;
        this._currentStreak = 0;
        this._adjustedWeights = null;
        this._geniusTypesUsed = new Set();
    },

    recordAnswer(correct) {
        if (correct) { this._consecutiveErrors = 0; this._currentStreak++; }
        else { this._consecutiveErrors++; this._currentStreak = 0; }
        this._recalcWeights();
    },

    _recalcWeights() {
        const cfg = GENIUS_QTYPE_CONFIG;
        const w = { ...cfg.weights };
        if (this._consecutiveErrors >= cfg.difficultyAdjust.errorsToTrigger) {
            w.standard += cfg.difficultyAdjust.boostStandardBy;
            w.reverse += 0.05;
            w.trueFalse = Math.max(0, w.trueFalse - 0.05);
            w.comparison = Math.max(0, w.comparison - 0.05);
            w.reverseMatch = Math.max(0, w.reverseMatch - 0.05);
            w.sequence = Math.max(0, w.sequence - 0.03);
            w.commutative = Math.max(0, w.commutative - 0.02);
        }
        if (this._currentStreak >= cfg.difficultyAdjust.streakToTrigger) {
            w.standard = Math.max(0.10, w.standard - 0.10);
            w.trueFalse += 0.03; w.comparison += 0.03;
            w.reverseMatch += 0.02; w.sequence += 0.01; w.commutative += 0.01;
        }
        this._adjustedWeights = w;
    },

    _pickType() {
        const cfg = GENIUS_QTYPE_CONFIG;
        const w = this._adjustedWeights || cfg.weights;
        const types = Object.keys(w);
        // Enforce max consecutive same type
        const lastTypes = this._typeHistory.slice(-cfg.maxConsecutiveSameType);
        let blockedType = null;
        if (lastTypes.length >= cfg.maxConsecutiveSameType && lastTypes.every(t => t === lastTypes[0])) {
            blockedType = lastTypes[0];
        }
        const filtered = {};
        let total = 0;
        for (const t of types) {
            if (t === blockedType) continue;
            filtered[t] = w[t];
            total += w[t];
        }
        let r = Math.random() * total;
        for (const [type, weight] of Object.entries(filtered)) {
            r -= weight;
            if (r <= 0) { this._typeHistory.push(type); this._geniusTypesUsed.add(type); return type; }
        }
        this._typeHistory.push('standard');
        return 'standard';
    },

    _pickFactPair() {
        const maxN = getMaxMultiplier();
        const data = Storage.load();
        // Bias toward red/weak facts
        const redFacts = [];
        for (let i = 1; i <= maxN; i++) {
            for (let j = i; j <= maxN; j++) {
                const key = SR.factKey(i, j);
                const fact = data.facts[key];
                if (fact && getMasteryLevel(fact) === 'low') redFacts.push({ a: i, b: j });
            }
        }
        let a, b;
        if (redFacts.length > 0 && Math.random() < 0.3) {
            const pick = redFacts[Math.floor(Math.random() * redFacts.length)];
            a = pick.a; b = pick.b;
        } else {
            let attempts = 0;
            do {
                a = Math.floor(Math.random() * maxN) + 1;
                b = Math.floor(Math.random() * maxN) + 1;
                attempts++;
            } while (this._usedQuestions.has(a + 'x' + b) && attempts < 50);
        }
        if (Math.random() > 0.5) [a, b] = [b, a];
        this._usedQuestions.add(a + 'x' + b);
        return { a, b };
    },

    generate() {
        const type = this._pickType();
        const { a, b } = this._pickFactPair();
        const maxN = getMaxMultiplier();
        switch (type) {
            case 'standard':    return this._genStandard(a, b, maxN);
            case 'reverse':     return this._genReverse(a, b, maxN);
            case 'trueFalse':   return this._genTrueFalse(a, b, maxN);
            case 'comparison':  return this._genComparison(a, b, maxN);
            case 'reverseMatch':return this._genReverseMatch(a, b, maxN);
            case 'sequence':    return this._genSequence(a, b, maxN);
            case 'commutative': return this._genCommutative(a, b, maxN);
            default:            return this._genStandard(a, b, maxN);
        }
    },

    _genStandard(a, b, maxN) {
        const correct = a * b;
        const distractors = QGen._buildDistractors(a, b, correct, 'genius', 7);
        const options = [correct, ...distractors.slice(0, 7)];
        QGen.shuffle(options);
        return { type: 'standard', factKey: SR.factKey(a, b), a, b, correct, options, correctIdx: options.indexOf(correct) };
    },

    _genReverse(a, b, maxN) {
        const result = a * b;
        const correct = b;
        const distractors = this._buildReverseDistractors(correct, maxN);
        const options = [correct, ...distractors.slice(0, 7)];
        QGen.shuffle(options);
        return { type: 'reverse', factKey: SR.factKey(a, b), a, b, displayA: a, displayResult: result, correct, options, correctIdx: options.indexOf(correct) };
    },

    _genTrueFalse(a, b, maxN) {
        const correct = a * b;
        const isTrue = Math.random() > 0.4;
        let displayedResult;
        if (isTrue) {
            displayedResult = correct;
        } else {
            const offsets = [a, b, -a, -b, 1, -1, 10, -10].filter(o => correct + o > 0 && correct + o !== correct);
            displayedResult = offsets.length > 0 ? correct + offsets[Math.floor(Math.random() * offsets.length)] : correct + 1;
        }
        // Build follow-up options for when "false" is answered correctly
        let followUpOptions = null;
        if (!isTrue) {
            const fuDistractors = QGen._buildDistractors(a, b, correct, 'mixed', 5);
            const fuOpts = [correct, ...fuDistractors.slice(0, 5)];
            QGen.shuffle(fuOpts);
            followUpOptions = { options: fuOpts, correctIdx: fuOpts.indexOf(correct), correct };
        }
        return {
            type: 'trueFalse', factKey: SR.factKey(a, b), a, b, displayedResult, isTrue,
            correct: isTrue, correctValue: correct,
            options: ['נכון', 'לא נכון'], correctIdx: isTrue ? 0 : 1,
            followUpOptions
        };
    },

    _genComparison(a, b, maxN) {
        let a2, b2, attempts = 0;
        do {
            a2 = Math.floor(Math.random() * maxN) + 1;
            b2 = Math.floor(Math.random() * maxN) + 1;
            attempts++;
        } while (a2 * b2 === a * b && attempts < 30);
        const r1 = a * b, r2 = a2 * b2;
        // Display is LTR: a×b on LEFT, a2×b2 on RIGHT
        // RTL grid buttons: [ימין(right), שווים(center), שמאל(left)]
        let correctAnswer;
        if (r1 > r2) correctAnswer = 2;       // שמאל — left-side expr is bigger
        else if (r2 > r1) correctAnswer = 0;   // ימין — right-side expr is bigger
        else correctAnswer = 1;                 // שווים
        const labels = ['ימין', 'שווים', 'שמאל'];
        return { type: 'comparison', factKey: SR.factKey(a, b), a, b, a2, b2, result1: r1, result2: r2, correct: correctAnswer, options: labels, correctIdx: correctAnswer };
    },

    _genReverseMatch(a, b, maxN) {
        const target = a * b;
        const correctExpr = { a, b, label: `${a}×${b}` };
        const expressions = [correctExpr];
        const used = new Set([`${a}x${b}`, `${b}x${a}`]);
        let attempts = 0;
        while (expressions.length < 4 && attempts < 50) {
            const ra = Math.floor(Math.random() * maxN) + 1;
            const rb = Math.floor(Math.random() * maxN) + 1;
            if (ra * rb !== target && !used.has(`${ra}x${rb}`)) {
                expressions.push({ a: ra, b: rb, label: `${ra}×${rb}` });
                used.add(`${ra}x${rb}`);
            }
            attempts++;
        }
        QGen.shuffle(expressions);
        const opts = expressions.map(e => e.label);
        return { type: 'reverseMatch', factKey: SR.factKey(a, b), a, b, targetResult: target, correct: 0, expressions, options: opts, correctIdx: expressions.findIndex(e => e.a === a && e.b === b) };
    },

    _genSequence(a, b, maxN) {
        const base = Math.max(a, b);
        const seqLen = 4;
        const missingIdx = 1 + Math.floor(Math.random() * 2); // hide 2nd or 3rd
        const sequence = [];
        for (let i = 1; i <= seqLen; i++) sequence.push(base * i);
        const correct = sequence[missingIdx];
        const displayed = sequence.map((v, i) => i === missingIdx ? '___' : v);
        const distVals = [correct + base, correct - base, correct + 1, correct - 1, correct + 2 * base, correct - 2 * base]
            .filter(v => v > 0 && v !== correct);
        const opts = [correct, ...distVals.slice(0, 5)];
        QGen.shuffle(opts);
        return { type: 'sequence', factKey: SR.factKey(base, missingIdx + 1), a: base, b: missingIdx + 1, base, displayedSequence: displayed, correct, options: opts, correctIdx: opts.indexOf(correct) };
    },

    _genCommutative(a, b, maxN) {
        // Ensure a != b for meaningful commutative question
        if (a === b) { b = (a % maxN) + 1; }
        const correctLabel = `${b}×${a}`;
        const distractors = [];
        const used = new Set([correctLabel, `${a}×${b}`]);
        let attempts = 0;
        while (distractors.length < 3 && attempts < 30) {
            const ra = Math.floor(Math.random() * maxN) + 1;
            const rb = Math.floor(Math.random() * maxN) + 1;
            const label = `${ra}×${rb}`;
            if (!used.has(label) && ra * rb !== a * b) {
                distractors.push(label);
                used.add(label);
            }
            attempts++;
        }
        const opts = [correctLabel, ...distractors];
        QGen.shuffle(opts);
        return { type: 'commutative', factKey: SR.factKey(a, b), a, b, correct: correctLabel, correctValue: a * b, options: opts, correctIdx: opts.indexOf(correctLabel) };
    },

    _buildReverseDistractors(correct, maxN) {
        const candidates = new Set();
        for (let d = -3; d <= 3; d++) { if (d !== 0) candidates.add(correct + d); }
        for (let i = 0; i < 15; i++) { candidates.add(Math.floor(Math.random() * maxN) + 1); }
        candidates.delete(correct);
        let pool = [...candidates].filter(v => v >= 1 && v <= maxN);
        pool.sort((x, y) => Math.abs(x - correct) - Math.abs(y - correct));
        const picked = [];
        for (const v of pool) {
            if (!picked.includes(v) && v !== correct) { picked.push(v); if (picked.length >= 7) break; }
        }
        let val = 1;
        while (picked.length < 7) {
            if (val !== correct && !picked.includes(val) && val <= maxN) picked.push(val);
            val++; if (val > maxN) break;
        }
        return picked;
    }
};

// ====== FOCUS MODE ======
const FocusMode = {
    _wrongCountPerFact: {},

    getWeakFacts() {
        const data = Storage.load();
        const maxN = getMaxMultiplier();
        const weak = [];
        for (let i = 1; i <= maxN; i++) {
            for (let j = i; j <= maxN; j++) {
                const key = SR.factKey(i, j);
                const fact = data.facts[key];
                const level = getMasteryLevel(fact);
                if (level === 'low') weak.push({ key, a: i, b: j, level, priority: 1 });
                else if (level === 'mid') weak.push({ key, a: i, b: j, level, priority: 2 });
            }
        }
        weak.sort((a, b) => a.priority - b.priority);
        return weak;
    },

    start() {
        this._wrongCountPerFact = {};
        const weak = this.getWeakFacts();
        App.isFocusMode = true;
        App.isDailyBoost = false;
        App.isChallenge = false;
        App.isGenius = false;
        App.sessionDifficulty = 'normal';
        App.focusModeFactsBefore = {};
        App.focusModeImproved = [];

        let selectedFacts;
        if (weak.length === 0) {
            // No weak facts - use mixed practice
            const maxN = getMaxMultiplier();
            const allFacts = [];
            for (let i = 1; i <= maxN; i++) {
                for (let j = i; j <= maxN; j++) { allFacts.push({ key: SR.factKey(i, j), a: i, b: j }); }
            }
            QGen.shuffle(allFacts);
            selectedFacts = allFacts.slice(0, FOCUS_CONFIG.minQuestions);
        } else {
            const count = Math.min(FOCUS_CONFIG.maxQuestions, Math.max(FOCUS_CONFIG.minQuestions, weak.length));
            selectedFacts = weak.slice(0, count);
        }

        // Snapshot mastery levels before session
        selectedFacts.forEach(f => { App.focusModeFactsBefore[f.key] = getMasteryLevel(SR.getFact(f.key)); });

        App.selectedNumbers = [...new Set(selectedFacts.flatMap(f => [f.a, f.b]))];
        App.sessionQuestions = selectedFacts.map(f => QGen.generate(f.key, 'normal'));
        QGen.shuffle(App.sessionQuestions);
        App.sessionIndex = 0;
        App.sessionResults = [];
        App.sessionStars = 0;
        App.sessionCoins = 0;
        App.currentStreak = 0;
        App.isProcessing = false;

        // Timer
        const timerSection = document.getElementById('practice-timer-section');
        if (timerSection) timerSection.style.display = '';
        App.timerRemaining = FOCUS_CONFIG.maxTimeMinutes * 60;
        updateTimerDisplay();
        startTimer();

        // Show mode badge
        const badge = document.getElementById('practice-mode-badge');
        if (badge) { badge.textContent = '🎯 תרגול חולשות'; badge.style.display = ''; }

        SoundEngine.play('launch');
        App.navigateTo('screen-practice');
        showQuestion();
    },

    generateHint(a, b) {
        const product = a * b;
        const maxDots = Math.min(a, 10);
        const maxCols = Math.min(b, 10);
        let html = `<div class="hint-visual">`;
        html += `<div class="hint-title">${a} × ${b} = ?</div>`;
        html += `<div class="hint-array">`;
        for (let r = 0; r < maxDots; r++) {
            html += `<div class="hint-row">`;
            for (let c = 0; c < maxCols; c++) { html += `<div class="hint-dot"></div>`; }
            html += `</div>`;
        }
        html += `</div>`;
        html += `<div class="hint-count">${a} שורות × ${b} בכל שורה = <strong>${product}</strong></div>`;
        html += `</div>`;
        return html;
    }
};

// ====== DAILY BOOST ======
const DailyBoost = {
    isFirstToday() {
        const data = Storage.load();
        const dk = todayKey();
        return !(data.daily[dk] && data.daily[dk].dailyBoostCompleted);
    },

    start() {
        const data = Storage.load();
        const maxN = getMaxMultiplier();
        ensureToday();

        App.isDailyBoost = true;
        App.isFocusMode = false;
        App.isChallenge = false;
        App.isGenius = false;
        App.sessionDifficulty = 'normal';

        // Categorize facts by mastery
        const strong = [], medium = [], weak = [];
        for (let i = 1; i <= maxN; i++) {
            for (let j = i; j <= maxN; j++) {
                const key = SR.factKey(i, j);
                const fact = data.facts[key];
                const level = getMasteryLevel(fact);
                const entry = { key, a: i, b: j };
                if (level === 'high') strong.push(entry);
                else if (level === 'mid') medium.push(entry);
                else weak.push(entry);
            }
        }

        const cfg = DAILY_BOOST_CONFIG;
        const total = cfg.questionCount;
        const strongCount = Math.round(total * cfg.mix.strong);
        const mediumCount = Math.round(total * cfg.mix.medium);
        const weakCount = total - strongCount - mediumCount;

        const pickRandom = (arr, n) => { const s = [...arr]; QGen.shuffle(s); return s.slice(0, n); };
        const selected = [
            ...pickRandom(strong, Math.min(strongCount, strong.length)),
            ...pickRandom(medium, Math.min(mediumCount, medium.length)),
            ...pickRandom(weak, Math.min(weakCount, weak.length))
        ];
        // Fill remaining
        const all = [...strong, ...medium, ...weak];
        while (selected.length < total && all.length > 0) {
            const pick = all[Math.floor(Math.random() * all.length)];
            if (pick && !selected.find(s => s.key === pick.key)) selected.push(pick);
            else break;
        }

        App.selectedNumbers = [...new Set(selected.flatMap(f => [f.a, f.b]))];
        App.sessionQuestions = selected.map(f => QGen.generate(f.key, 'normal'));
        QGen.shuffle(App.sessionQuestions);
        App.sessionIndex = 0;
        App.sessionResults = [];
        App.sessionStars = 0;
        App.sessionCoins = 0;
        App.currentStreak = 0;
        App.isProcessing = false;

        // Timer
        const timerSection = document.getElementById('practice-timer-section');
        if (timerSection) timerSection.style.display = '';
        App.timerRemaining = cfg.maxTimeMinutes * 60;
        updateTimerDisplay();
        startTimer();

        // Show mode badge
        const badge = document.getElementById('practice-mode-badge');
        if (badge) { badge.textContent = '☀️ החימום של היום'; badge.style.display = ''; }

        SoundEngine.play('launch');
        App.navigateTo('screen-practice');
        showQuestion();
    },

    awardBonuses() {
        const data = Storage.load();
        const dk = todayKey();
        const isFirst = this.isFirstToday();
        const cfg = DAILY_BOOST_CONFIG;
        let bonusCoins = 0, bonusPoints = 0;

        if (isFirst) {
            bonusCoins = cfg.bonuses.firstDaily;
            bonusPoints = cfg.bonuses.firstDaily;
            Storage.update(d => {
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                const yKey = yesterday.toISOString().split('T')[0];
                if (d.stats.lastDailyBoostDate === yKey) { d.stats.dailyBoostStreak++; }
                else if (d.stats.lastDailyBoostDate !== dk) { d.stats.dailyBoostStreak = 1; }
                d.stats.lastDailyBoostDate = dk;
                if (d.daily[dk]) { d.daily[dk].dailyBoostCompleted = true; d.daily[dk].dailyBoostCount++; }
            });
            const streak = Storage.load().stats.dailyBoostStreak;
            if (streak >= 14) { bonusCoins += cfg.bonuses.streak14; bonusPoints += cfg.bonuses.streak14; }
            else if (streak >= 7) { bonusCoins += cfg.bonuses.streak7; bonusPoints += cfg.bonuses.streak7; }
            else if (streak >= 3) { bonusCoins += cfg.bonuses.streak3; bonusPoints += cfg.bonuses.streak3; }
        } else {
            bonusCoins = Math.round(cfg.bonuses.firstDaily * cfg.subsequentBonusRatio);
            bonusPoints = bonusCoins;
            Storage.update(d => { if (d.daily[dk]) d.daily[dk].dailyBoostCount++; });
        }

        Storage.update(d => {
            d.stats.totalCoins += bonusCoins;
            d.stats.totalPoints += bonusPoints;
            d.stats.dailyBoostSessions++;
        });
        return { bonusCoins, bonusPoints, isFirst, streak: Storage.load().stats.dailyBoostStreak };
    }
};

// ====== DAILY MISSION ======
const DailyMission = {
    getTodayMission() {
        const data = Storage.load();
        const dk = todayKey();
        if (!data.dailyMissions) data.dailyMissions = {};
        if (data.dailyMissions[dk]) return data.dailyMissions[dk];
        const dayNum = Math.floor(new Date().getTime() / 86400000);
        const template = MISSION_TEMPLATES[dayNum % MISSION_TEMPLATES.length];
        const mission = { id: template.id, desc: template.desc, icon: template.icon, target: template.target, checkField: template.checkField, progress: 0, completed: false };
        Storage.update(d => { if (!d.dailyMissions) d.dailyMissions = {}; d.dailyMissions[dk] = mission; });
        return mission;
    },

    updateProgress(ctx) {
        const dk = todayKey();
        const data = Storage.load();
        if (!data.dailyMissions || !data.dailyMissions[dk]) return;
        const mission = data.dailyMissions[dk];
        if (mission.completed) return;
        const val = ctx[mission.checkField] || 0;
        mission.progress = Math.min(val, mission.target);
        if (mission.progress >= mission.target) {
            mission.completed = true;
            Storage.update(d => {
                d.dailyMissions[dk] = mission;
                d.stats.totalCoins += 50;
                d.stats.totalPoints += 50;
            });
            showRewardPopup('🎯', 'משימה הושלמה!', mission.desc);
        } else {
            Storage.update(d => { d.dailyMissions[dk] = mission; });
        }
    }
};

// ====== ACHIEVEMENT SYSTEM ======
const AchSys = {
    check(ctx = {}) {
        const data = Storage.load();
        const s = data.stats;
        const newlyUnlocked = [];

        const conditions = {
            first_star: () => s.totalCorrect >= 1,
            ten_correct: () => s.totalCorrect >= 10,
            fifty_correct: () => s.totalCorrect >= 50,
            hundred_correct: () => s.totalCorrect >= 100,
            two_hundred: () => s.totalCorrect >= 200,
            five_hundred: () => s.totalCorrect >= 500,
            streak_5: () => s.bestStreak >= 5,
            streak_10: () => s.bestStreak >= 10,
            streak_20: () => s.bestStreak >= 20,
            speed_demon: () => ctx.responseMs < 1000 && ctx.correct,
            master_table: () => ctx.tableMastered,
            comeback: () => ctx.correctedMistake,
            daily_3: () => Object.keys(data.daily).filter(k => data.daily[k].questionsAnswered > 0).length >= 3,
            daily_7: () => Object.keys(data.daily).filter(k => data.daily[k].questionsAnswered > 0).length >= 7,
            perfect_session: () => ctx.perfectSession,
            challenge_complete: () => ctx.challengeComplete,
            genius_20: () => ctx.geniusScore >= 20,
            focus_5: () => (ctx.focusModeSessions || 0) >= 5,
            daily_streak_3: () => (ctx.dailyBoostStreak || 0) >= 3,
            daily_streak_7: () => (ctx.dailyBoostStreak || 0) >= 7,
            mastery_upgrade: () => {
                const dk = todayKey();
                const d = Storage.load().daily[dk];
                return d && d.factsImproved && d.factsImproved.length > 0;
            },
            all_green: () => {
                const maxN = getMaxMultiplier();
                for (let i = 1; i <= maxN; i++) {
                    for (let j = i; j <= maxN; j++) {
                        const fact = Storage.load().facts[SR.factKey(i, j)];
                        if (getMasteryLevel(fact) !== 'high') return false;
                    }
                }
                return true;
            },
            genius_variety: () => (ctx.geniusTypesUsed || 0) >= 5
        };

        for (const ach of ACHIEVEMENTS) {
            if (data.achievements.unlocked.some(u => u.id === ach.id)) continue;
            const fn = conditions[ach.id];
            if (fn && fn()) {
                data.achievements.unlocked.push({ id: ach.id, at: new Date().toISOString() });
                newlyUnlocked.push(ach);
            }
        }

        if (newlyUnlocked.length > 0) Storage.save();
        return newlyUnlocked;
    }
};

// ====== SCORER MODULE ======
const Scorer = {
    calcPoints(questionType, difficulty, masteryLevel, responseMs, isCorrect) {
        if (!isCorrect) {
            if (difficulty === 'challenge' || difficulty === 'genius') return SCORING_CONFIG.frustrationShield.errorPenalty;
            return SCORING_CONFIG.frustrationShield.normalErrorPenalty;
        }
        let points = SCORING_CONFIG.basePoints;
        points *= (SCORING_CONFIG.questionTypeMultipliers[questionType] || 1.0);
        points *= (SCORING_CONFIG.difficultyMultipliers[difficulty] || 1.0);
        points *= (SCORING_CONFIG.masteryZoneMultipliers[masteryLevel] || 1.0);
        if (responseMs < SCORING_CONFIG.speedBonus.fast.threshold) {
            points *= SCORING_CONFIG.speedBonus.fast.multiplier;
        } else if (responseMs < SCORING_CONFIG.speedBonus.medium.threshold) {
            points *= SCORING_CONFIG.speedBonus.medium.multiplier;
        }
        return Math.round(points);
    },
    calcSessionBonus(accuracy) {
        if (accuracy >= 90) return SCORING_CONFIG.sessionBonuses.accuracy90;
        if (accuracy >= 80) return SCORING_CONFIG.sessionBonuses.accuracy80;
        if (accuracy >= 70) return SCORING_CONFIG.sessionBonuses.accuracy70;
        return 0;
    },
    calcImprovementBonus(fromLevel, toLevel) {
        let bonus = 0;
        if (fromLevel === 'low' && (toLevel === 'mid' || toLevel === 'high')) bonus += SCORING_CONFIG.improvementBonuses.redToYellow;
        if ((fromLevel === 'mid' || fromLevel === 'low') && toLevel === 'high') bonus += SCORING_CONFIG.improvementBonuses.yellowToGreen;
        return bonus;
    },
    getFactMasteryLevel(factKey) {
        const fact = SR.getFact(factKey);
        return getMasteryLevel(fact);
    }
};

// ====== APP STATE ======
const App = {
    currentScreen: null,
    selectedNumbers: [],
    sessionQuestions: [],
    sessionIndex: 0,
    sessionResults: [],
    sessionDifficulty: 'normal',
    sessionStars: 0,
    sessionCoins: 0,
    currentStreak: 0,
    isProcessing: false,
    questionStartTime: 0,
    timerInterval: null,
    timerRemaining: 0,
    isChallenge: false,
    isGenius: false,
    geniusScore: 0,
    isFocusMode: false,
    isDailyBoost: false,
    focusModeFactsBefore: {},
    focusModeImproved: [],
    selectedAvatar: null,

    navigateTo(screenId) {
        const hadPrevious = !!this.currentScreen;
        if (this.currentScreen) {
            const cur = document.getElementById(this.currentScreen);
            if (cur) {
                cur.classList.add('screen-exit');
                cur.addEventListener('animationend', () => {
                    cur.classList.remove('screen-active', 'screen-exit');
                }, { once: true });
            }
        }
        this.currentScreen = screenId;
        const el = document.getElementById(screenId);
        if (el) {
            const delay = hadPrevious ? 50 : 0;
            setTimeout(() => {
                el.scrollTop = 0;
                el.classList.add('screen-active', 'screen-enter');
                el.addEventListener('animationend', () => {
                    el.classList.remove('screen-enter');
                }, { once: true });
            }, delay);
        }
    }
};

// ====== HELPERS ======
function getLevel(points) {
    for (let i = LEVELS.length - 1; i >= 0; i--) {
        if (points >= LEVELS[i].minPoints) {
            const cur = LEVELS[i];
            const next = LEVELS[i + 1];
            const progress = next ? (points - cur.minPoints) / (next.minPoints - cur.minPoints) : 1;
            return { ...cur, progress: Math.min(progress, 1), next };
        }
    }
    return { ...LEVELS[0], progress: 0, next: LEVELS[1] };
}

function todayKey() {
    return new Date().toISOString().split('T')[0];
}

function ensureToday() {
    Storage.update(data => {
        const key = todayKey();
        if (!data.daily[key]) {
            data.daily[key] = {
                questionsAnswered: 0, correctAnswers: 0, sessionsCompleted: 0,
                dailyBoostCompleted: false, dailyBoostCount: 0,
                factsImproved: [], masteryChanges: []
            };
        } else {
            const d = data.daily[key];
            if (d.dailyBoostCompleted === undefined) d.dailyBoostCompleted = false;
            if (!d.dailyBoostCount) d.dailyBoostCount = 0;
            if (!d.factsImproved) d.factsImproved = [];
            if (!d.masteryChanges) d.masteryChanges = [];
        }
    });
}

function showFloatingReward(emoji, x, y) {
    const el = document.createElement('div');
    el.className = 'float-reward';
    el.textContent = emoji;
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    document.body.appendChild(el);
    el.addEventListener('animationend', () => el.remove());
}

function showConfetti() {
    const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96E6A1', '#FFD93D', '#FF8B94', '#C3B1E1', '#6C63FF'];
    const container = document.getElementById('confetti-container');
    container.innerHTML = '';
    for (let i = 0; i < 60; i++) {
        const p = document.createElement('div');
        p.className = 'confetti-piece';
        p.style.cssText = `
            left:${Math.random()*100}%;
            background:${colors[Math.floor(Math.random()*colors.length)]};
            animation-delay:${Math.random()*2}s;
            animation-duration:${2+Math.random()*3}s;
            width:${6+Math.random()*8}px;
            height:${6+Math.random()*8}px;
            border-radius:${Math.random()>0.5?'50%':'2px'};
        `;
        container.appendChild(p);
    }
    setTimeout(() => { container.innerHTML = ''; }, 5500);
}

function showRewardPopup(icon, title, desc) {
    document.getElementById('reward-icon').textContent = icon;
    document.getElementById('reward-title').textContent = title;
    document.getElementById('reward-desc').textContent = desc;
    document.getElementById('reward-overlay').classList.add('visible');
    SoundEngine.play('achievement');
}

function hideRewardPopup() {
    document.getElementById('reward-overlay').classList.remove('visible');
}

function renderBgDecorations() {
    const symbols = ['\u2605', '\u2736', '\u2737', '\u25C6', '\u2B50', '\u00D7', '=', '+', '\u2022', '\u2726'];
    const container = document.getElementById('bg-decorations');
    container.innerHTML = '';
    for (let i = 0; i < 15; i++) {
        const el = document.createElement('div');
        el.className = 'bg-symbol';
        el.textContent = symbols[Math.floor(Math.random() * symbols.length)];
        el.style.left = Math.random() * 100 + '%';
        el.style.top = Math.random() * 100 + '%';
        el.style.fontSize = (1.5 + Math.random() * 2) + 'rem';
        el.style.animationDelay = (Math.random() * 5) + 's';
        el.style.animationDuration = (6 + Math.random() * 6) + 's';
        container.appendChild(el);
    }
}

// ====== SCREEN: AVATAR ======
function renderAvatarScreen() {
    const grid = document.getElementById('avatar-grid');
    grid.innerHTML = '';
    AVATARS.forEach(av => {
        const btn = document.createElement('button');
        btn.className = 'avatar-btn';
        btn.dataset.avatar = av.id;
        btn.innerHTML = `<div class="avatar-emoji">${av.emoji}</div><div class="avatar-name">${av.name}</div>`;
        grid.appendChild(btn);
    });
}

function handleAvatarClick(e) {
    const btn = e.target.closest('[data-avatar]');
    if (!btn) return;
    SoundEngine.play('click');
    document.querySelectorAll('.avatar-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    App.selectedAvatar = btn.dataset.avatar;
    document.getElementById('btn-avatar-continue').disabled = false;
}

function confirmAvatar() {
    if (!App.selectedAvatar) return;
    Storage.update(data => {
        data.profile.avatar = App.selectedAvatar;
        data.profile.createdAt = new Date().toISOString();
    });
    SoundEngine.play('achievement');
    showWelcomeScreen();
}

// ====== SCREEN: WELCOME ======
function showWelcomeScreen() {
    // Reset all mode flags
    SpaceMusic.stop();
    App.isGenius = false;
    App.geniusScore = 0;
    App.isFocusMode = false;
    App.isDailyBoost = false;
    App.focusModeFactsBefore = {};
    App.focusModeImproved = [];
    document.getElementById('screen-practice').classList.remove('genius-mode');
    document.getElementById('genius-title-bar').style.display = 'none';
    const modeBadge = document.getElementById('practice-mode-badge');
    if (modeBadge) modeBadge.style.display = 'none';

    const data = Storage.load();
    ensureToday();

    const avatar = AVATARS.find(a => a.id === data.profile.avatar);
    const fallback = document.getElementById('welcome-avatar-fallback');
    if (fallback) fallback.textContent = avatar ? avatar.emoji : '\uD83D\uDE0A';
    document.getElementById('welcome-greeting').textContent = `\u05E9\u05DC\u05D5\u05DD ${data.profile.name}!`;

    // Level
    const lvl = getLevel(data.stats.totalPoints);
    const badge = document.getElementById('welcome-level-badge');
    badge.textContent = lvl.name;
    badge.style.background = lvl.color;
    const fill = document.getElementById('welcome-level-fill');
    fill.style.width = (lvl.progress * 100) + '%';
    fill.style.background = lvl.color;

    // Stats
    document.getElementById('welcome-stars').textContent = data.stats.totalStars;
    document.getElementById('welcome-coins').textContent = data.stats.totalCoins;
    document.getElementById('welcome-streak').textContent = data.stats.bestStreak;

    // Calendar
    renderWeekCalendar();

    // Subtitle
    const today = data.daily[todayKey()];
    if (today && today.questionsAnswered > 0) {
        document.getElementById('welcome-subtitle').textContent = `\u05D4\u05D9\u05D5\u05DD \u05E2\u05E0\u05D9\u05EA \u05E2\u05DC ${today.questionsAnswered} \u05E9\u05D0\u05DC\u05D5\u05EA!`;
    } else {
        document.getElementById('welcome-subtitle').textContent = '\u05D1\u05D5\u05D0 \u05E0\u05EA\u05E8\u05D2\u05DC \u05DB\u05E4\u05DC!';
    }

    // Review button visibility
    const mistakes = SR.getFactsNeedingReview();
    document.getElementById('btn-review-mistakes').style.display = mistakes.length > 0 ? '' : 'none';

    // Max multiplier toggle state
    const maxM = getMaxMultiplier();
    document.getElementById('toggle-max-10').classList.toggle('active', maxM === 10);
    document.getElementById('toggle-max-12').classList.toggle('active', maxM === 12);

    // Answer count toggle state
    const ansC = getAnswerCount();
    document.getElementById('toggle-ans-4').classList.toggle('active', ansC === 4);
    document.getElementById('toggle-ans-6').classList.toggle('active', ansC === 6);
    document.getElementById('toggle-ans-8').classList.toggle('active', ansC === 8);

    // Genius high score inside button
    const gHS = data.settings.geniusHighScore || 0;
    const hsWelcome = document.getElementById('genius-highscore-welcome');
    if (gHS > 0) {
        hsWelcome.style.display = 'inline-block';
        document.getElementById('genius-highscore-val').textContent = gHS;
    } else {
        hsWelcome.style.display = 'none';
    }

    // Daily Boost button state
    const dbBadge = document.getElementById('daily-boost-badge');
    if (dbBadge) {
        const isFirst = DailyBoost.isFirstToday();
        const streak = data.stats.dailyBoostStreak || 0;
        if (isFirst) {
            dbBadge.textContent = streak > 0 ? `🔥${streak}` : 'חדש!';
            dbBadge.style.display = '';
        } else {
            dbBadge.textContent = `✅ ${streak}`;
            dbBadge.style.display = '';
        }
    }

    // Focus mode button visibility (show only if there are weak facts)
    const weakFacts = FocusMode.getWeakFacts();
    document.getElementById('btn-focus-mode').style.display = weakFacts.length > 0 ? '' : 'none';

    // Daily Mission card
    const missionCard = document.getElementById('mission-card');
    if (missionCard) {
        const mission = DailyMission.getTodayMission();
        document.getElementById('mission-icon').textContent = mission.icon;
        document.getElementById('mission-desc').textContent = mission.desc;
        const pct = mission.target > 0 ? Math.min(100, (mission.progress / mission.target) * 100) : 0;
        document.getElementById('mission-progress-fill').style.width = pct + '%';
        document.getElementById('mission-status').textContent = mission.completed ? '✅ הושלמה!' : `${mission.progress}/${mission.target}`;
        missionCard.style.display = '';
    }

    App.navigateTo('screen-welcome');
    if (SoundEngine.ctx && SoundEngine.ctx.state === 'running') {
        SoundEngine.play('welcome');
    }
}

function renderWeekCalendar() {
    const data = Storage.load();
    const cal = document.getElementById('welcome-calendar');
    cal.innerHTML = '';
    const dayNames = ['\u05D0', '\u05D1', '\u05D2', '\u05D3', '\u05D4', '\u05D5', '\u05E9'];
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const key = d.toISOString().split('T')[0];
        const practiced = data.daily[key] && data.daily[key].questionsAnswered > 0;
        const isToday = i === 0;
        const dayEl = document.createElement('div');
        dayEl.className = 'week-day';
        dayEl.innerHTML = `
            <div class="week-day-name">${dayNames[d.getDay()]}</div>
            <div class="week-day-dot ${practiced ? 'active' : ''} ${isToday ? 'today' : ''}">
                ${practiced ? '\u2713' : ''}
            </div>
        `;
        cal.appendChild(dayEl);
    }
}

// ====== SCREEN: NUMBER SELECTION ======
function showNumberScreen() {
    App.selectedNumbers = [];
    const grid = document.getElementById('number-grid');
    grid.innerHTML = '';
    const maxN = getMaxMultiplier();
    for (let n = 1; n <= maxN; n++) {
        const btn = document.createElement('button');
        btn.className = 'number-btn';
        btn.dataset.num = n;
        btn.textContent = n;
        grid.appendChild(btn);
    }
    // Adjust grid columns: 4 columns for 12, 5 columns for 10
    grid.style.gridTemplateColumns = maxN <= 10 ? 'repeat(5, 1fr)' : 'repeat(4, 1fr)';
    document.getElementById('btn-start-session').disabled = true;
    App.navigateTo('screen-numbers');
}

function handleNumberClick(e) {
    const btn = e.target.closest('[data-num]');
    if (!btn) return;
    SoundEngine.play('click');
    const num = parseInt(btn.dataset.num);
    const idx = App.selectedNumbers.indexOf(num);
    if (idx >= 0) {
        App.selectedNumbers.splice(idx, 1);
        btn.classList.remove('selected');
    } else {
        App.selectedNumbers.push(num);
        btn.classList.add('selected');
    }
    document.getElementById('btn-start-session').disabled = App.selectedNumbers.length === 0;
}

// ====== SCREEN: DIFFICULTY ======
function showDifficultyScreen() {
    App.navigateTo('screen-difficulty');
}

function handleDifficultyClick(e) {
    const btn = e.target.closest('[data-diff]');
    if (!btn) return;
    SoundEngine.play('click');
    App.sessionDifficulty = btn.dataset.diff;
    App.isChallenge = btn.dataset.diff === 'challenge';
    startPractice();
}

// ====== GENIUS MODE ======
function triggerGeniusSparkles() {
    const titleEl = document.getElementById('genius-title-text');
    const sparklesEl = document.getElementById('genius-sparkles');
    if (!titleEl || !sparklesEl) return;

    // Flash the title
    titleEl.classList.remove('genius-title-flash');
    void titleEl.offsetWidth;
    titleEl.classList.add('genius-title-flash');
    setTimeout(() => titleEl.classList.remove('genius-title-flash'), 600);

    // Create sparkle particles
    const colors = ['#FFD700', '#FFA500', '#FFEC8B', '#FFE4B5', '#fff'];
    for (let i = 0; i < 8; i++) {
        const spark = document.createElement('div');
        spark.className = 'genius-sparkle';
        spark.style.background = colors[Math.floor(Math.random() * colors.length)];
        spark.style.left = (10 + Math.random() * 80) + '%';
        spark.style.top = (20 + Math.random() * 60) + '%';
        spark.style.animationDelay = (Math.random() * 0.2) + 's';
        spark.style.width = spark.style.height = (4 + Math.random() * 5) + 'px';
        sparklesEl.appendChild(spark);
        setTimeout(() => spark.remove(), 1000);
    }
}

function playWarpEntry() {
    const overlay = document.createElement('div');
    overlay.className = 'warp-overlay';
    const canvas = document.createElement('canvas');
    overlay.appendChild(canvas);
    document.body.appendChild(overlay);

    const ctx = canvas.getContext('2d');
    const W = canvas.width = window.innerWidth;
    const H = canvas.height = window.innerHeight;
    const cx = W / 2;
    const cy = H / 2;

    // Create stars
    const stars = [];
    for (let i = 0; i < 200; i++) {
        stars.push({
            x: (Math.random() - 0.5) * W * 2,
            y: (Math.random() - 0.5) * H * 2,
            z: Math.random() * 1500 + 100,
            speed: Math.random() * 30 + 15
        });
    }

    const startTime = performance.now();
    const duration = 2200;

    function drawFrame(now) {
        const elapsed = now - startTime;
        const progress = Math.min(elapsed / duration, 1);
        // Accelerating speed
        const accel = 1 + progress * progress * 25;

        ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
        ctx.fillRect(0, 0, W, H);

        for (const star of stars) {
            star.z -= star.speed * accel;
            if (star.z <= 1) {
                star.x = (Math.random() - 0.5) * W * 2;
                star.y = (Math.random() - 0.5) * H * 2;
                star.z = 1500;
            }

            const sx = cx + star.x / star.z * 300;
            const sy = cy + star.y / star.z * 300;
            // Previous position for streak
            const pz = star.z + star.speed * accel;
            const px = cx + star.x / pz * 300;
            const py = cy + star.y / pz * 300;

            const brightness = Math.min(1, (1500 - star.z) / 800);
            const streakLen = Math.min(1, progress * 2);
            const goldMix = progress;
            const r = Math.round(200 + 55 * goldMix);
            const g = Math.round(200 + 15 * goldMix);
            const b = Math.round(255 * (1 - goldMix * 0.7));
            const alpha = brightness * (0.5 + streakLen * 0.5);

            ctx.strokeStyle = `rgba(${r},${g},${b},${alpha})`;
            ctx.lineWidth = Math.max(0.5, brightness * 2 * (1 + progress));
            ctx.beginPath();
            ctx.moveTo(px + (px - sx) * (1 - streakLen), py + (py - sy) * (1 - streakLen));
            ctx.lineTo(sx, sy);
            ctx.stroke();
        }

        // Central glow at end
        if (progress > 0.6) {
            const glowAlpha = (progress - 0.6) / 0.4 * 0.4;
            const grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, W * 0.5);
            grad.addColorStop(0, `rgba(255, 215, 0, ${glowAlpha})`);
            grad.addColorStop(0.5, `rgba(255, 165, 0, ${glowAlpha * 0.3})`);
            grad.addColorStop(1, 'rgba(0, 0, 0, 0)');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, W, H);
        }

        if (progress < 1) {
            requestAnimationFrame(drawFrame);
        }
    }

    requestAnimationFrame(drawFrame);

    // Remove overlay after animation
    setTimeout(() => {
        overlay.remove();
    }, 2500);
}

function startGeniusMode() {
    const maxN = getMaxMultiplier();
    App.selectedNumbers = Array.from({length: maxN}, (_, i) => i + 1);
    App.sessionDifficulty = 'genius';
    App.isChallenge = false;
    App.isGenius = true;
    App.geniusScore = 0;

    GeniusQGen.reset();
    // Pre-generate 100 questions
    App.sessionQuestions = [];
    for (let i = 0; i < 100; i++) {
        App.sessionQuestions.push(GeniusQGen.generate());
    }
    App.sessionIndex = 0;
    App.sessionResults = [];
    App.sessionStars = 0;
    App.sessionCoins = 0;
    App.currentStreak = 0;
    App.isProcessing = false;

    // Setup timer display but don't start yet (wait for warp animation)
    const timerSection = document.getElementById('practice-timer-section');
    timerSection.style.display = '';
    App.timerRemaining = 180;
    updateTimerDisplay();

    // Start background music
    SpaceMusic.start();

    // Add genius visual class + show title with high score
    document.getElementById('screen-practice').classList.add('genius-mode');
    document.getElementById('genius-title-bar').style.display = '';
    const currentHS = Storage.load().settings.geniusHighScore || 0;
    document.getElementById('genius-record-val').textContent = currentHS;
    document.getElementById('genius-record-line').classList.remove('new-record');

    SoundEngine.play('launch');
    App.navigateTo('screen-practice');

    // Play warp entry animation, then start timer + questions
    playWarpEntry();
    setTimeout(() => {
        startTimer();
        showQuestion();
    }, 2000);
}

// ====== SCREEN: PRACTICE ======
function startPractice() {
    const cfg = DIFFICULTY_CONFIG[App.sessionDifficulty];
    const count = cfg.questions === 999 ? 50 : cfg.questions;
    const questions = SR.generateQuestions(App.selectedNumbers, count);

    App.sessionQuestions = questions.map(q => QGen.generate(q.key, App.sessionDifficulty));
    App.sessionIndex = 0;
    App.sessionResults = [];
    App.sessionStars = 0;
    App.sessionCoins = 0;
    App.currentStreak = 0;
    App.isProcessing = false;

    // Timer
    const timerSection = document.getElementById('practice-timer-section');
    if (cfg.timer) {
        timerSection.style.display = '';
        App.timerRemaining = cfg.timer;
        updateTimerDisplay();
        startTimer();
    } else {
        timerSection.style.display = 'none';
        stopTimer();
    }

    SoundEngine.play('launch');
    App.navigateTo('screen-practice');
    showQuestion();
}

function showQuestion() {
    // Genius mode: auto-generate more questions when running low
    if (App.isGenius && App.sessionQuestions.length - App.sessionIndex < 5) {
        for (let i = 0; i < 20; i++) {
            App.sessionQuestions.push(GeniusQGen.generate());
        }
    }

    if (App.sessionIndex >= App.sessionQuestions.length) {
        endSession();
        return;
    }

    let q = App.sessionQuestions[App.sessionIndex];

    // Validation: skip for new question types that don't follow a*b=correct pattern
    const skipValidation = ['reverse', 'trueFalse', 'comparison', 'reverseMatch', 'sequence', 'commutative'];
    if (!App.isGenius && !skipValidation.includes(q.type)) {
        const valid = q && q.a != null && q.b != null
            && q.correct === q.a * q.b
            && Array.isArray(q.options)
            && q.options.length >= 4
            && q.options.includes(q.correct);
        if (!valid) {
            console.warn('Question validation failed, regenerating:', JSON.stringify(q));
            q = QGen.generate(q.factKey, App.sessionDifficulty);
            App.sessionQuestions[App.sessionIndex] = q;
        }
    }

    const cfg = DIFFICULTY_CONFIG[App.sessionDifficulty];

    // Progress display
    if (App.isGenius) {
        document.getElementById('practice-question-num').textContent = `ניקוד: ${App.geniusScore}`;
        document.getElementById('practice-progress').style.width = '0%';
    } else {
        const total = cfg.questions === 999 ? App.sessionQuestions.length : cfg.questions;
        document.getElementById('practice-question-num').textContent = `${App.sessionIndex + 1} / ${Math.min(total, App.sessionQuestions.length)}`;
        document.getElementById('practice-progress').style.width = ((App.sessionIndex / Math.min(total, App.sessionQuestions.length)) * 100) + '%';
    }

    document.getElementById('practice-stars').textContent = App.sessionStars;
    document.getElementById('practice-streak').textContent = App.currentStreak;

    const questionEl = document.getElementById('practice-question');
    const grid = document.getElementById('practice-answers');
    grid.innerHTML = '';

    // Update the question label above the question based on type
    const questionLabel = document.querySelector('.question-label');
    if (questionLabel) {
        const labelMap = { trueFalse: 'נכון או לא נכון?', comparison: 'מי יותר גדול?', reverseMatch: 'איזה תרגיל שווה?', sequence: 'מה חסר ברצף?', commutative: 'מה שווה?', reverse: 'מה חסר?' };
        questionLabel.textContent = labelMap[q.type] || 'כמה זה?';
    }

    // Helper: wrap math in LTR block to prevent RTL text reversal
    const ltr = (html) => `<span dir="ltr" style="unicode-bidi:isolate;display:inline-block">${html}</span>`;

    // Render question text + answers based on type
    // Rule: Hebrew goes ONLY in .question-label header, math goes in questionEl wrapped in ltr()
    switch (q.type) {
        case 'trueFalse': {
            questionEl.innerHTML = ltr(q.a + ' × ' + q.b + ' = ' + q.displayedResult);
            grid.style.gridTemplateColumns = 'repeat(2, 1fr)';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn answer-btn-tf' + (i === 0 ? ' tf-true' : ' tf-false');
                btn.dataset.option = i;
                btn.dataset.index = i;
                btn.textContent = opt;
                grid.appendChild(btn);
            });
            break;
        }
        case 'comparison': {
            questionEl.innerHTML = ltr(q.a + '×' + q.b + ' <span class="vs-badge">VS</span> ' + q.a2 + '×' + q.b2);
            grid.style.gridTemplateColumns = 'repeat(3, 1fr)';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn answer-btn-compare';
                btn.dataset.option = i;
                btn.dataset.index = i;
                btn.textContent = opt;
                grid.appendChild(btn);
            });
            break;
        }
        case 'reverseMatch': {
            questionEl.innerHTML = ltr('? = ' + q.targetResult);
            grid.style.gridTemplateColumns = 'repeat(2, 1fr)';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.dataset.option = i;
                btn.dataset.index = i;
                btn.textContent = opt;
                grid.appendChild(btn);
            });
            break;
        }
        case 'sequence': {
            const seqStr = q.displayedSequence.map(v => v === '___' ? '<span style="display:inline-block;width:2ch;border-bottom:3px solid #FFD700"></span>' : v).join(' , ');
            questionEl.innerHTML = ltr('<span class="seq-display">' + seqStr + '</span>');
            grid.style.gridTemplateColumns = q.options.length > 4 ? 'repeat(3, 1fr)' : 'repeat(2, 1fr)';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.dataset.option = opt;
                btn.dataset.index = i;
                btn.textContent = opt;
                grid.appendChild(btn);
            });
            break;
        }
        case 'commutative': {
            questionEl.innerHTML = ltr(q.a + ' × ' + q.b + ' = ?');
            grid.style.gridTemplateColumns = 'repeat(2, 1fr)';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.dataset.option = opt;
                btn.dataset.index = i;
                btn.textContent = opt;
                grid.appendChild(btn);
            });
            break;
        }
        case 'reverse': {
            questionEl.innerHTML = ltr(q.displayA + ' × <span style="display:inline-block;width:2ch;border-bottom:3px solid #FFD700;vertical-align:baseline"></span> = ' + q.displayResult);
            const numOpts = q.options.length;
            grid.style.gridTemplateColumns = (App.isGenius || numOpts > 6) ? 'repeat(4, 1fr)' : numOpts <= 4 ? 'repeat(2, 1fr)' : 'repeat(3, 1fr)';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.dataset.option = opt;
                btn.dataset.index = i;
                btn.textContent = opt;
                grid.appendChild(btn);
            });
            break;
        }
        default: { // standard
            questionEl.innerHTML = ltr(q.a + ' × ' + q.b + ' = ?');
            const numOpts = q.options.length;
            grid.style.gridTemplateColumns = (App.isGenius || numOpts > 6) ? 'repeat(4, 1fr)' : numOpts <= 4 ? 'repeat(2, 1fr)' : 'repeat(3, 1fr)';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'answer-btn';
                btn.dataset.option = opt;
                btn.dataset.index = i;
                btn.textContent = opt;
                grid.appendChild(btn);
            });
            break;
        }
    }

    App.questionStartTime = Date.now();
    App.isProcessing = false;
    updatePracticeBubble();
}

function handleAnswerClick(e) {
    const btn = e.target.closest('[data-option]');
    if (!btn || App.isProcessing) return;
    App.isProcessing = true;

    const q = App.sessionQuestions[App.sessionIndex];
    if (!q) { App.isProcessing = false; return; }
    const chosenRaw = btn.dataset.option;
    const responseMs = Date.now() - App.questionStartTime;
    const cfg = DIFFICULTY_CONFIG[App.sessionDifficulty];

    // Determine correctness based on question type
    let isCorrect;
    switch (q.type) {
        case 'trueFalse':
            isCorrect = parseInt(chosenRaw) === q.correctIdx;
            break;
        case 'comparison':
            isCorrect = parseInt(chosenRaw) === q.correctIdx;
            break;
        case 'reverseMatch':
            isCorrect = parseInt(chosenRaw) === q.correctIdx;
            break;
        case 'sequence':
            isCorrect = parseInt(chosenRaw) === q.correct;
            break;
        case 'commutative':
            isCorrect = chosenRaw === q.correct;
            break;
        case 'reverse':
            isCorrect = parseInt(chosenRaw) === q.correct;
            break;
        default: { // standard
            let trueAnswer = q.a * q.b;
            if (q.correct !== trueAnswer) q.correct = trueAnswer;
            isCorrect = parseInt(chosenRaw) === trueAnswer;
            break;
        }
    }

    // Notify GeniusQGen for adaptive difficulty
    if (App.isGenius) GeniusQGen.recordAnswer(isCorrect);

    // Mark buttons
    document.querySelectorAll('.answer-btn').forEach(b => b.classList.add('disabled'));

    if (isCorrect) {
        btn.classList.add('correct');
        SoundEngine.play('correct');
        showPhotoFeedback(true);
        App.currentStreak++;

        // True/False: if answered "not true" correctly, show bonus follow-up
        if (q.type === 'trueFalse' && !q.isTrue && q.followUpOptions && !q._isFollowUp) {
            setTimeout(() => { showTrueFalseFollowUp(q); }, 600);
            return; // Don't advance yet - follow-up will handle it
        }

        if (App.isGenius) {
            App.geniusScore++;
            triggerGeniusSparkles();
            const prevHS = Storage.load().settings.geniusHighScore || 0;
            if (App.geniusScore > prevHS) {
                Storage.update(d => { d.settings.geniusHighScore = App.geniusScore; });
                document.getElementById('genius-record-val').textContent = App.geniusScore;
                const recLine = document.getElementById('genius-record-line');
                recLine.classList.remove('new-record');
                void recLine.offsetWidth;
                recLine.classList.add('new-record');
            }
        }

        // Capture mastery level BEFORE SR update for celebration tracking
        const beforeLevel = getMasteryLevel(SR.getFact(q.factKey));

        // Scoring via Scorer module
        const masteryLevel = beforeLevel;
        const qType = q.type || 'standard';
        let pointsEarned = Scorer.calcPoints(qType, App.sessionDifficulty, masteryLevel, responseMs, true);

        let starsEarned = 1;
        let coinsEarned = 1;
        if (responseMs < 2000) { starsEarned = 2; coinsEarned = 2; }

        // Streak bonuses
        if (App.currentStreak === 5) {
            starsEarned += SCORING_CONFIG.streakBonuses.five.stars;
            coinsEarned += SCORING_CONFIG.streakBonuses.five.coins;
            pointsEarned += SCORING_CONFIG.streakBonuses.five.points;
            SoundEngine.play('streak');
        } else if (App.currentStreak === 10) {
            starsEarned += SCORING_CONFIG.streakBonuses.ten.stars;
            coinsEarned += SCORING_CONFIG.streakBonuses.ten.coins;
            pointsEarned += SCORING_CONFIG.streakBonuses.ten.points;
            SoundEngine.play('streak');
        } else if (App.currentStreak > 0 && App.currentStreak % 5 === 0) {
            SoundEngine.play('streak');
        }

        App.sessionStars += starsEarned;
        App.sessionCoins += coinsEarned;

        // Float reward
        const rect = btn.getBoundingClientRect();
        showFloatingReward('\u2B50', rect.left + rect.width / 2, rect.top);

        // Update stats
        Storage.update(data => {
            data.stats.totalCorrect++;
            data.stats.totalQuestions++;
            data.stats.totalStars += starsEarned;
            data.stats.totalCoins += coinsEarned;
            data.stats.totalPoints += pointsEarned;
            data.stats.currentStreak = App.currentStreak;
            if (App.currentStreak > data.stats.bestStreak) data.stats.bestStreak = App.currentStreak;
            const dk = todayKey();
            if (data.daily[dk]) { data.daily[dk].questionsAnswered++; data.daily[dk].correctAnswers++; }
        });

        // SR update
        const quality = SR.quality(true, responseMs);
        SR.updateFact(q.factKey, quality, responseMs);

        // Mastery color change celebration
        const afterLevel = getMasteryLevel(SR.getFact(q.factKey));
        if (beforeLevel !== afterLevel && afterLevel !== 'none' && beforeLevel !== 'none') {
            const impBonus = Scorer.calcImprovementBonus(beforeLevel, afterLevel);
            if (impBonus > 0) {
                Storage.update(d => {
                    d.stats.totalPoints += impBonus;
                    d.stats.totalCoins += Math.round(impBonus / 2);
                    const dk = todayKey();
                    if (d.daily[dk]) {
                        d.daily[dk].masteryChanges.push({ key: q.factKey, from: beforeLevel, to: afterLevel, at: Date.now() });
                        if (!d.daily[dk].factsImproved.includes(q.factKey)) d.daily[dk].factsImproved.push(q.factKey);
                    }
                });
                showMasteryUpgrade(q.factKey, beforeLevel, afterLevel);
                SoundEngine.play('achievement');
            }
        }

        // Check achievements
        const wasMistake = SR.getFact(q.factKey).wrong > 0;
        AchSys.check({ correct: true, responseMs, correctedMistake: wasMistake && quality >= 3 });

    } else {
        btn.classList.add('wrong');
        SoundEngine.play('wrong');
        showPhotoFeedback(false);

        // Show correct answer for standard/reverse types
        if (cfg.showCorrect && (q.type === 'standard' || q.type === 'reverse' || !q.type)) {
            let foundCorrectBtn = false;
            const correctVal = q.type === 'reverse' ? q.correct : (q.a * q.b);
            document.querySelectorAll('.answer-btn').forEach(b => {
                if (parseInt(b.dataset.option) === correctVal) {
                    b.classList.add('reveal-correct');
                    foundCorrectBtn = true;
                }
            });
            if (!foundCorrectBtn) {
                const correctDisplay = document.createElement('div');
                correctDisplay.style.cssText = 'text-align:center;margin-top:0.5rem;font-size:1.5rem;font-weight:800;color:var(--color-success);font-family:var(--font-display);text-shadow:0 0 15px rgba(0,230,118,0.4)';
                correctDisplay.textContent = `${q.a} \u00D7 ${q.b} = ${q.a * q.b}`;
                document.getElementById('practice-answers').appendChild(correctDisplay);
            }
        }

        // Frustration shield penalty
        const penalty = Scorer.calcPoints(q.type || 'standard', App.sessionDifficulty, 'none', responseMs, false);
        if (penalty < 0) {
            Storage.update(data => { data.stats.totalPoints = Math.max(0, data.stats.totalPoints + penalty); });
        }

        App.currentStreak = 0;

        Storage.update(data => {
            data.stats.totalWrong++;
            data.stats.totalQuestions++;
            data.stats.currentStreak = 0;
            const dk = todayKey();
            if (data.daily[dk]) data.daily[dk].questionsAnswered++;
        });

        SR.updateFact(q.factKey, 0, responseMs);

        // Focus mode: track wrong count per fact for hints
        if (App.isFocusMode && typeof FocusMode !== 'undefined') {
            if (!FocusMode._wrongCountPerFact[q.factKey]) FocusMode._wrongCountPerFact[q.factKey] = 0;
            FocusMode._wrongCountPerFact[q.factKey]++;
            if (FocusMode._wrongCountPerFact[q.factKey] >= FOCUS_CONFIG.hintsAfterWrongCount) {
                const { a: ha, b: hb } = SR.parseFact(q.factKey);
                showHintOverlay(FocusMode.generateHint(ha, hb));
            }
        }

        // Frustration shield: 3 consecutive errors -> encouragement
        const recentErrors = App.sessionResults.slice(-(SCORING_CONFIG.frustrationShield.consecutiveErrorsForHelp - 1));
        if (recentErrors.length >= SCORING_CONFIG.frustrationShield.consecutiveErrorsForHelp - 1 && recentErrors.every(r => !r.correct)) {
            showEncouragementBubble();
        }

        // Re-insert question later in session
        if (cfg.retryWrong) {
            const reinsertAt = App.sessionIndex + 3 + Math.floor(Math.random() * 3);
            const insertIdx = Math.min(reinsertAt, App.sessionQuestions.length);
            App.sessionQuestions.splice(insertIdx, 0, QGen.generate(q.factKey, App.sessionDifficulty));
        }

        AchSys.check({ correct: false, responseMs });
    }

    App.sessionResults.push({ factKey: q.factKey, correct: isCorrect, responseMs, chosen: chosenRaw });

    // Next question after delay
    const delay = App.isGenius ? (isCorrect ? 500 : 1000) : (isCorrect ? 800 : (cfg.showCorrect === 'brief' ? 1200 : 1500));
    setTimeout(() => {
        App.sessionIndex++;
        showQuestion();
    }, delay);
}

// True/False follow-up bonus question
function showTrueFalseFollowUp(originalQ) {
    const fu = originalQ.followUpOptions;
    const questionEl = document.getElementById('practice-question');
    const grid = document.getElementById('practice-answers');
    questionEl.innerHTML = `<span class="q-label-small">בונוס! מה התשובה הנכונה?</span><br>${originalQ.a} &times; ${originalQ.b} = ?`;
    grid.innerHTML = '';
    grid.style.gridTemplateColumns = fu.options.length > 4 ? 'repeat(3, 1fr)' : 'repeat(2, 1fr)';
    fu.options.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn';
        btn.dataset.option = opt;
        btn.dataset.index = i;
        btn.textContent = opt;
        grid.appendChild(btn);
    });
    // Replace question with standard type for answer handling
    App.sessionQuestions[App.sessionIndex] = {
        ...originalQ, _isFollowUp: true, type: 'standard',
        correct: fu.correct, options: fu.options, correctIdx: fu.correctIdx
    };
    App.questionStartTime = Date.now();
    App.isProcessing = false;
}

// Mastery upgrade celebration
function showMasteryUpgrade(factKey, from, to) {
    const colorMap = { low: '🔴', mid: '🟡', high: '🟢', none: '⬜' };
    showFloatingReward(`${colorMap[from]}➡️${colorMap[to]}`, window.innerWidth / 2, window.innerHeight / 3);
}

// Encouragement bubble (frustration shield)
function showEncouragementBubble() {
    const msgs = ['לא נורא, בוא ננסה שוב! 💪', 'אתה יכול! קדימה! 🚀', 'טעויות זה חלק מהלמידה! 🌟', 'בפעם הבאה יהיה יותר קל! ✨'];
    const bubble = document.getElementById('practice-bubble');
    if (bubble) {
        bubble.textContent = msgs[Math.floor(Math.random() * msgs.length)];
        bubble.classList.add('encouragement-flash');
        setTimeout(() => bubble.classList.remove('encouragement-flash'), 2000);
    }
}

// Hint overlay for Focus Mode
function showHintOverlay(html) {
    const overlay = document.getElementById('hint-overlay');
    if (overlay) {
        document.getElementById('hint-content').innerHTML = html;
        overlay.classList.add('visible');
    }
}
function hideHintOverlay() {
    const overlay = document.getElementById('hint-overlay');
    if (overlay) overlay.classList.remove('visible');
}

// ====== TIMER ======
function startTimer() {
    stopTimer();
    App.timerInterval = setInterval(() => {
        App.timerRemaining--;
        updateTimerDisplay();
        const countdownAt = App.isGenius ? 15 : 10;
        if (App.timerRemaining <= countdownAt && App.timerRemaining > 0) SoundEngine.play('countdown');
        if (App.timerRemaining <= 0) {
            stopTimer();
            SoundEngine.play('timeUp');
            endSession('timeout');
        }
    }, 1000);
}

function stopTimer() {
    if (App.timerInterval) { clearInterval(App.timerInterval); App.timerInterval = null; }
}

function updateTimerDisplay() {
    const m = Math.floor(App.timerRemaining / 60);
    const s = App.timerRemaining % 60;
    document.getElementById('practice-timer-display').textContent = `${m}:${String(s).padStart(2, '0')}`;
    const cfg = DIFFICULTY_CONFIG[App.sessionDifficulty];
    const pct = cfg.timer ? (App.timerRemaining / cfg.timer * 100) : 100;
    const fill = document.getElementById('practice-timer-fill');
    fill.style.width = pct + '%';
    fill.classList.remove('warning', 'danger');
    const dangerAt = App.isGenius ? 15 : 10;
    const warnAt = App.isGenius ? 30 : 20;
    if (App.timerRemaining <= dangerAt) fill.classList.add('danger');
    else if (App.timerRemaining <= warnAt) fill.classList.add('warning');
}

// ====== SCREEN: SUMMARY ======
function endSession(reason) {
    stopTimer();

    // Stop genius mode visuals & music
    if (App.isGenius) {
        SpaceMusic.stop();
        document.getElementById('screen-practice').classList.remove('genius-mode');
        document.getElementById('genius-title-bar').style.display = 'none';
    }

    const results = App.sessionResults;
    const correct = results.filter(r => r.correct).length;
    const wrong = results.filter(r => !r.correct).length;
    const total = results.length;
    const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
    const isPerfect = wrong === 0 && total > 0;
    const cfg = DIFFICULTY_CONFIG[App.sessionDifficulty];

    // Update session count
    Storage.update(data => {
        data.stats.totalSessions++;
        const dk = todayKey();
        if (data.daily[dk]) data.daily[dk].sessionsCompleted++;
    });

    // Session completion bonuses via Scorer
    let sessionBonusPoints = 0;
    if (total > 0) {
        let bonusStars = 5;
        let bonusCoins = 10;
        sessionBonusPoints = Scorer.calcSessionBonus(accuracy);
        if (isPerfect) { bonusStars += 10; bonusCoins += 25; sessionBonusPoints += 200; }

        // Focus mode: calculate improvement bonuses
        let focusImprovementBonus = 0;
        if (App.isFocusMode && App.focusModeFactsBefore) {
            const improved = [];
            Object.entries(App.focusModeFactsBefore).forEach(([key, beforeLevel]) => {
                const afterLevel = getMasteryLevel(SR.getFact(key));
                if (afterLevel !== beforeLevel) {
                    focusImprovementBonus += Scorer.calcImprovementBonus(beforeLevel, afterLevel);
                    improved.push({ key, from: beforeLevel, to: afterLevel });
                }
            });
            App.focusModeImproved = improved;
            Storage.update(d => { d.stats.focusModeSessions++; });
        }

        // Daily Boost bonuses
        let dailyBoostResult = null;
        if (App.isDailyBoost) {
            dailyBoostResult = DailyBoost.awardBonuses();
        }

        Storage.update(data => {
            data.stats.totalStars += bonusStars;
            data.stats.totalCoins += bonusCoins;
            data.stats.totalPoints += sessionBonusPoints + focusImprovementBonus;
        });
    }

    // Update daily mission progress
    const dk = todayKey();
    const dailyData = Storage.load().daily[dk] || {};
    DailyMission.updateProgress({
        redsImproved: (dailyData.masteryChanges || []).filter(c => c.from === 'low').length,
        geniusCorrect: App.isGenius ? App.geniusScore : 0,
        bestStreakToday: Storage.load().stats.bestStreak,
        questionsToday: dailyData.questionsAnswered || 0,
        dailyBoostDone: dailyData.dailyBoostCompleted ? 1 : 0,
        perfectSession: isPerfect && total >= 5 ? 1 : 0
    });

    // Check achievements
    const newAch = AchSys.check({
        perfectSession: isPerfect && total >= 5,
        challengeComplete: App.isChallenge,
        geniusScore: App.isGenius ? App.geniusScore : 0,
        focusModeSessions: Storage.load().stats.focusModeSessions,
        dailyBoostStreak: Storage.load().stats.dailyBoostStreak,
        geniusTypesUsed: App.isGenius ? GeniusQGen._geniusTypesUsed.size : 0
    });

    // Render summary
    const icon = document.getElementById('summary-icon');
    const title = document.getElementById('summary-title');
    const subtitle = document.getElementById('summary-subtitle');
    const summaryPhoto = document.getElementById('summary-photo');
    // Show the correct/happy photo for good results, wrong/encourage photo for poor results
    if (summaryPhoto) {
        summaryPhoto.src = accuracy >= 50 ? 'images/correct.jpg' : 'images/wrong.jpg';
        summaryPhoto.style.display = '';
        // Re-trigger animation
        summaryPhoto.style.animation = 'none';
        summaryPhoto.offsetHeight;
        summaryPhoto.style.animation = '';
    }

    if (App.isGenius) {
        // Genius mode summary
        icon.textContent = '\uD83E\uDDE0';
        if (App.geniusScore >= 30) {
            title.textContent = 'אלוף המחוננים!';
            subtitle.textContent = 'תוצאה מדהימה!';
            showConfetti();
            SoundEngine.play('perfect');
        } else if (App.geniusScore >= 20) {
            title.textContent = 'מחונן אמיתי!';
            subtitle.textContent = 'כל הכבוד!';
            SoundEngine.play('achievement');
        } else if (App.geniusScore >= 10) {
            title.textContent = 'יפה מאוד!';
            subtitle.textContent = 'ממשיכים להתאמן!';
            SoundEngine.play('correct');
        } else {
            title.textContent = 'ניסיון טוב!';
            subtitle.textContent = 'נסה שוב!';
            SoundEngine.play('correct');
        }
        if (reason === 'timeout') {
            subtitle.textContent = 'נגמר הזמן!';
        }

        // Save genius high score
        const data = Storage.load();
        if (!data.settings.geniusHighScore || App.geniusScore > data.settings.geniusHighScore) {
            Storage.update(d => { d.settings.geniusHighScore = App.geniusScore; });
        }
        const highScore = Math.max(App.geniusScore, data.settings.geniusHighScore || 0);

        // Genius stats grid
        const statsGrid = document.getElementById('summary-stats');
        statsGrid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center;">
                <div class="genius-summary-label">ניקוד</div>
                <div class="genius-summary-score">\uD83E\uDDE0 ${App.geniusScore}</div>
                <div class="genius-highscore">\uD83C\uDFC6 שיא: ${highScore}</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value" style="color:var(--color-success)">${correct}</div>
                <div class="summary-stat-label">נכון</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value" style="color:var(--color-error)">${wrong}</div>
                <div class="summary-stat-label">לא נכון</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value" style="color:var(--color-primary)">${accuracy}%</div>
                <div class="summary-stat-label">הצלחה</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value" style="color:var(--color-star)">\u2B50 ${App.sessionStars}</div>
                <div class="summary-stat-label">כוכבים</div>
            </div>
        `;
    } else {
        if (isPerfect && total >= 5) {
            icon.textContent = '\uD83C\uDF89';
            title.textContent = 'מושלם!';
            subtitle.textContent = 'בלי אף טעות אחת!';
            showConfetti();
            SoundEngine.play('perfect');
        } else if (accuracy >= 80) {
            icon.textContent = '\uD83C\uDF1F';
            title.textContent = 'כל הכבוד!';
            subtitle.textContent = `${accuracy}% הצלחה`;
            SoundEngine.play('achievement');
        } else if (accuracy >= 50) {
            icon.textContent = '\uD83D\uDCAA';
            title.textContent = 'יפה מאוד!';
            subtitle.textContent = 'תמשיך לתרגל!';
            SoundEngine.play('correct');
        } else {
            icon.textContent = '\uD83D\uDE0A';
            title.textContent = 'לא נורא!';
            subtitle.textContent = 'תרגול עושה את המושלם';
            SoundEngine.play('correct');
        }

        if (reason === 'timeout') {
            subtitle.textContent = 'נגמר הזמן!';
        }

        // Stats grid
        const statsGrid = document.getElementById('summary-stats');
        statsGrid.innerHTML = `
            <div class="summary-stat">
                <div class="summary-stat-value" style="color:var(--color-success)">${correct}</div>
                <div class="summary-stat-label">נכון</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value" style="color:var(--color-error)">${wrong}</div>
                <div class="summary-stat-label">לא נכון</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value" style="color:var(--color-primary)">${accuracy}%</div>
                <div class="summary-stat-label">הצלחה</div>
            </div>
            <div class="summary-stat">
                <div class="summary-stat-value" style="color:var(--color-star)">\u2B50 ${App.sessionStars}</div>
                <div class="summary-stat-label">כוכבים</div>
            </div>
        `;
    }

    // New achievements
    const achDiv = document.getElementById('summary-achievements');
    achDiv.innerHTML = '';
    if (newAch.length > 0) {
        achDiv.innerHTML = '<div class="title-md mt-2">\uD83C\uDFC6 \u05D4\u05D9\u05E9\u05D2\u05D9\u05DD \u05D7\u05D3\u05E9\u05D9\u05DD!</div>';
        newAch.forEach(a => {
            achDiv.innerHTML += `
                <div class="achievement-card unlocked mt-1">
                    <div class="achievement-icon">${a.icon}</div>
                    <div class="achievement-info">
                        <div class="achievement-name">${a.name}</div>
                        <div class="achievement-desc">${a.desc}</div>
                    </div>
                </div>
            `;
        });
    }

    // Progress messages
    const progressMsgs = generateProgressMessages(results);
    if (progressMsgs.length > 0) {
        achDiv.innerHTML += `<div class="progress-messages mt-2">${progressMsgs.map(m => `<div class="progress-msg">${m}</div>`).join('')}</div>`;
    }

    // Focus mode improved facts
    if (App.isFocusMode && App.focusModeImproved.length > 0) {
        const colorMap = { low: '🔴', mid: '🟡', high: '🟢', none: '⬜' };
        achDiv.innerHTML += `<div class="title-md mt-2">📈 תרגילים שהשתפרו:</div>`;
        App.focusModeImproved.forEach(imp => {
            const { a, b } = SR.parseFact(imp.key);
            achDiv.innerHTML += `<div class="progress-msg">${a}×${b}: ${colorMap[imp.from]} ➡️ ${colorMap[imp.to]}</div>`;
        });
    }

    // Review button
    const mistakes = SR.getFactsNeedingReview();
    document.getElementById('btn-review-after-summary').style.display = mistakes.length > 0 ? '' : 'none';

    App.navigateTo('screen-summary');
}

function generateProgressMessages(results) {
    const messages = [];
    const data = Storage.load();
    const dk = todayKey();
    const daily = data.daily[dk];

    // Facts improved today
    if (daily && daily.factsImproved && daily.factsImproved.length > 0) {
        messages.push(`📈 שיפרת ${daily.factsImproved.length} תרגילים היום!`);
    }
    // Genius high score
    if (App.isGenius) {
        const hs = data.settings.geniusHighScore || 0;
        if (App.geniusScore >= hs && App.geniusScore > 0) messages.push('🏆 שיא חדש!');
    }
    // Best table
    const tableStrengths = {};
    results.filter(r => r.correct).forEach(r => {
        if (!r.factKey) return;
        const { a } = SR.parseFact(r.factKey);
        tableStrengths[a] = (tableStrengths[a] || 0) + 1;
    });
    const best = Object.entries(tableStrengths).sort((a, b) => b[1] - a[1])[0];
    if (best && best[1] >= 3) messages.push(`💪 הלוח של ${best[0]} מתחזק!`);
    // Daily boost streak
    if (App.isDailyBoost) {
        const streak = data.stats.dailyBoostStreak || 0;
        if (streak >= 3) messages.push(`🔥 רצף של ${streak} ימים!`);
    }
    return messages;
}

// ====== SCREEN: REVIEW MISTAKES ======
function showReviewScreen() {
    const mistakes = SR.getFactsNeedingReview();
    const subtitle = document.getElementById('review-subtitle');
    const list = document.getElementById('review-mistakes-list');
    const actions = document.getElementById('review-actions');
    list.innerHTML = '';
    actions.innerHTML = '';

    if (mistakes.length === 0) {
        subtitle.textContent = 'אין טעויות - מעולה!';
        actions.innerHTML = '<button class="btn btn-primary btn-block" id="btn-review-home">\uD83C\uDFE0 \u05D7\u05D6\u05E8\u05D4</button>';
    } else {
        subtitle.textContent = `${mistakes.length} \u05EA\u05E8\u05D2\u05D9\u05DC\u05D9\u05DD \u05DC\u05D7\u05D6\u05E8\u05D4`;
        mistakes.forEach(m => {
            const acc = m.fact.attempts > 0 ? Math.round((m.fact.correct / m.fact.attempts) * 100) : 0;
            let accClass = 'low';
            if (acc >= 70) accClass = 'high';
            else if (acc >= 40) accClass = 'mid';
            const item = document.createElement('div');
            item.className = 'mistake-item';
            item.innerHTML = `
                <span class="mistake-fact">${m.a} \u00D7 ${m.b} = ${m.a * m.b}</span>
                <span class="mistake-accuracy ${accClass}">${acc}%</span>
            `;
            list.appendChild(item);
        });
        actions.innerHTML = `
            <button class="btn btn-success btn-lg btn-block" id="btn-start-review">\u25B6 \u05D4\u05EA\u05D7\u05DC \u05D7\u05D6\u05E8\u05D4</button>
            <button class="btn btn-outline btn-block" id="btn-review-home">\u2190 \u05D7\u05D6\u05E8\u05D4</button>
        `;
    }

    App.navigateTo('screen-review');
}

function startReviewPractice() {
    const mistakes = SR.getFactsNeedingReview();
    if (mistakes.length === 0) return;

    // Use mistake facts as selected numbers (extract unique numbers)
    const nums = new Set();
    mistakes.forEach(m => { nums.add(m.a); nums.add(m.b); });
    App.selectedNumbers = [...nums];
    App.sessionDifficulty = 'normal';
    App.isChallenge = false;

    // Generate questions specifically from mistake facts
    App.sessionQuestions = mistakes.slice(0, 15).map(m => QGen.generate(m.key, 'normal'));
    QGen.shuffle(App.sessionQuestions);
    App.sessionIndex = 0;
    App.sessionResults = [];
    App.sessionStars = 0;
    App.sessionCoins = 0;
    App.currentStreak = 0;
    App.isProcessing = false;

    document.getElementById('practice-timer-section').style.display = 'none';
    stopTimer();

    SoundEngine.play('launch');
    App.navigateTo('screen-practice');
    showQuestion();
}

// ====== SCREEN: ACHIEVEMENTS ======
function showAchievementsScreen() {
    const data = Storage.load();
    const list = document.getElementById('achievements-list');
    list.innerHTML = '';

    ACHIEVEMENTS.forEach(ach => {
        const unlocked = data.achievements.unlocked.find(u => u.id === ach.id);
        const card = document.createElement('div');
        card.className = `achievement-card ${unlocked ? 'unlocked' : 'locked'}`;
        card.innerHTML = `
            <div class="achievement-icon">${unlocked ? ach.icon : '\uD83D\uDD12'}</div>
            <div class="achievement-info">
                <div class="achievement-name">${ach.name}</div>
                <div class="achievement-desc">${ach.desc}</div>
            </div>
        `;
        list.appendChild(card);
    });

    App.navigateTo('screen-achievements');
}

// ====== PHOTO FEEDBACK ======
const ENCOURAGEMENTS_CORRECT = ['אלוף!', 'מדהים!', 'יופי!', 'נהדר!', 'כל הכבוד!', 'וואו!', 'מעולה!'];
const ENCOURAGEMENTS_WRONG = ['לא נורא!', 'בפעם הבאה!', 'ממשיכים!', 'אפשר לתקן!', 'נסה שוב!'];
const PRACTICE_BUBBLES = ['קדימה!', 'אתה יכול!', 'בוא!', 'יאללה!', 'קל!'];

function showPhotoFeedback(correct) {
    const container = document.getElementById('feedback-photo-container');
    const photo = document.getElementById('feedback-photo');
    const text = document.getElementById('feedback-text');

    photo.src = correct ? 'images/correct.jpg' : 'images/wrong.jpg';
    photo.onerror = function() {
        container.classList.remove('visible', 'correct-feedback', 'wrong-feedback');
    };
    photo.className = correct ? 'feedback-photo' : 'feedback-photo wrong-photo';
    text.className = correct ? 'feedback-text' : 'feedback-text wrong-text';

    const msgs = correct ? ENCOURAGEMENTS_CORRECT : ENCOURAGEMENTS_WRONG;
    text.textContent = msgs[Math.floor(Math.random() * msgs.length)];

    // Remove old starbursts
    container.querySelectorAll('.feedback-starburst').forEach(el => el.remove());

    // Add starburst rings for correct answers
    if (correct) {
        for (let i = 0; i < 2; i++) {
            const burst = document.createElement('div');
            burst.className = 'feedback-starburst';
            container.insertBefore(burst, photo);
        }
    }

    container.classList.remove('visible', 'correct-feedback', 'wrong-feedback');
    // Force reflow to restart animation
    void container.offsetWidth;
    container.classList.add('visible', correct ? 'correct-feedback' : 'wrong-feedback');

    setTimeout(() => {
        container.classList.remove('visible', 'correct-feedback', 'wrong-feedback');
        container.querySelectorAll('.feedback-starburst').forEach(el => el.remove());
    }, correct ? 750 : 1300);
}

function updatePracticeBubble() {
    const bubble = document.getElementById('practice-bubble');
    if (bubble) {
        bubble.textContent = PRACTICE_BUBBLES[Math.floor(Math.random() * PRACTICE_BUBBLES.length)];
    }
}

// ====== SCREEN: MASTERY BOARD ======
function getMasteryLevel(fact) {
    if (!fact || fact.attempts === 0) return 'none';
    const accuracy = fact.correct / fact.attempts;
    // Also consider recent streak: if last 3 are correct, boost the rating
    const recentHistory = fact.history || [];
    const last3 = recentHistory.slice(-3);
    const recentCorrect = last3.filter(h => h.correct).length;

    if (accuracy >= 0.8 && recentCorrect >= 2) return 'high';
    if (accuracy >= 0.8) return 'high';
    if (accuracy >= 0.5) return 'mid';
    return 'low';
}

function getMasteryColor(level) {
    switch (level) {
        case 'high': return { bg: '#C6F6D5', text: '#276749' };
        case 'mid': return { bg: '#FEFCBF', text: '#975A16' };
        case 'low': return { bg: '#FEB2B2', text: '#9B2C2C' };
        default: return { bg: '#E2E8F0', text: '#A0AEC0' };
    }
}

let currentMasteryFilter = 'all';

function showMasteryScreen() {
    currentMasteryFilter = 'all';
    // Reset filter buttons
    document.querySelectorAll('.mastery-filter-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.filter === 'all');
    });
    renderMasteryGrid();
    App.navigateTo('screen-mastery');
}

function renderMasteryGrid() {
    const data = Storage.load();
    const grid = document.getElementById('mastery-grid');
    grid.innerHTML = '';
    const maxN = getMaxMultiplier();

    // Set dynamic grid columns/rows
    grid.style.gridTemplateColumns = `36px repeat(${maxN}, 1fr)`;
    grid.style.gridTemplateRows = `36px repeat(${maxN}, 1fr)`;

    // Corner cell
    const corner = document.createElement('div');
    corner.className = 'mastery-header mastery-corner';
    corner.textContent = '\u00D7';
    grid.appendChild(corner);

    // Column headers
    for (let c = 1; c <= maxN; c++) {
        const hdr = document.createElement('div');
        hdr.className = 'mastery-header';
        hdr.textContent = c;
        grid.appendChild(hdr);
    }

    let countHigh = 0, countMid = 0, countLow = 0, countNone = 0;

    // Rows
    for (let r = 1; r <= maxN; r++) {
        // Row header
        const rowHdr = document.createElement('div');
        rowHdr.className = 'mastery-header';
        rowHdr.textContent = r;
        grid.appendChild(rowHdr);

        for (let c = 1; c <= maxN; c++) {
            const key = SR.factKey(r, c);
            const fact = data.facts[key];
            const level = getMasteryLevel(fact);
            const result = r * c;

            const cell = document.createElement('div');
            cell.className = `mastery-cell mastery-${level}`;
            cell.textContent = result;
            cell.dataset.row = r;
            cell.dataset.col = c;
            cell.dataset.key = key;
            cell.dataset.level = level;

            // Apply filter
            if (currentMasteryFilter !== 'all' && currentMasteryFilter !== level) {
                cell.classList.add('mastery-hidden');
            }

            grid.appendChild(cell);

            // Count for summary
            if (level === 'high') countHigh++;
            else if (level === 'mid') countMid++;
            else if (level === 'low') countLow++;
            else countNone++;
        }
    }

    // Summary text
    const total = 144;
    const summaryEl = document.getElementById('mastery-summary');
    summaryEl.textContent = `\u2705 ${countHigh} \u05E9\u05D5\u05DC\u05D8  |  \uD83D\uDFE1 ${countMid} \u05D1\u05D9\u05E0\u05D5\u05E0\u05D9  |  \uD83D\uDD34 ${countLow} \u05DC\u05D7\u05D9\u05D6\u05D5\u05E7  |  \u2B1C ${countNone} \u05DC\u05D0 \u05EA\u05D5\u05E8\u05D2\u05DC`;
}

function showMasteryDetail(key, row, col) {
    const data = Storage.load();
    const fact = data.facts[key];
    const result = row * col;

    document.getElementById('mastery-detail-fact').textContent = `${row} \u00D7 ${col} = ${result}`;

    const statsEl = document.getElementById('mastery-detail-stats');
    const attempts = fact ? fact.attempts : 0;
    const correct = fact ? fact.correct : 0;
    const wrong = fact ? fact.wrong : 0;
    const accuracy = attempts > 0 ? Math.round((correct / attempts) * 100) : 0;

    statsEl.innerHTML = `
        <div class="mastery-detail-stat">
            <div class="mastery-detail-stat-value">${attempts}</div>
            <div class="mastery-detail-stat-label">\u05E0\u05D9\u05E1\u05D9\u05D5\u05E0\u05D5\u05EA</div>
        </div>
        <div class="mastery-detail-stat">
            <div class="mastery-detail-stat-value" style="color:var(--color-success)">${correct}</div>
            <div class="mastery-detail-stat-label">\u05E0\u05DB\u05D5\u05DF</div>
        </div>
        <div class="mastery-detail-stat">
            <div class="mastery-detail-stat-value" style="color:var(--color-error)">${wrong}</div>
            <div class="mastery-detail-stat-label">\u05DC\u05D0 \u05E0\u05DB\u05D5\u05DF</div>
        </div>
        <div class="mastery-detail-stat">
            <div class="mastery-detail-stat-value" style="color:var(--color-primary)">${accuracy}%</div>
            <div class="mastery-detail-stat-label">\u05D4\u05E6\u05DC\u05D7\u05D4</div>
        </div>
    `;

    const barFill = document.getElementById('mastery-detail-bar-fill');
    barFill.style.width = accuracy + '%';
    const level = getMasteryLevel(fact);
    const colors = getMasteryColor(level);
    barFill.style.background = level === 'none' ? '#CBD5E0' :
                               level === 'low' ? '#FC8181' :
                               level === 'mid' ? '#F6E05E' : '#68D391';

    const levelEl = document.getElementById('mastery-detail-level');
    const levelNames = { high: '\u2705 \u05E9\u05D5\u05DC\u05D8!', mid: '\uD83D\uDFE1 \u05D1\u05D9\u05E0\u05D5\u05E0\u05D9', low: '\uD83D\uDD34 \u05E6\u05E8\u05D9\u05DA \u05D7\u05D9\u05D6\u05D5\u05E7', none: '\u2B1C \u05DC\u05D0 \u05EA\u05D5\u05E8\u05D2\u05DC \u05E2\u05D3\u05D9\u05D9\u05DF' };
    levelEl.textContent = levelNames[level] || levelNames.none;
    levelEl.style.color = colors.text;

    document.getElementById('mastery-detail-overlay').classList.add('visible');
}

function hideMasteryDetail() {
    document.getElementById('mastery-detail-overlay').classList.remove('visible');
}

function handleMasteryFilter(filter) {
    currentMasteryFilter = filter;
    document.querySelectorAll('.mastery-filter-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.filter === filter);
    });
    renderMasteryGrid();
}

// ====== RESET DATA ======
const RESET_CODE = '046255618';

function showResetConfirm() {
    document.getElementById('reset-code-input').value = '';
    document.getElementById('reset-code-error').textContent = '';
    document.getElementById('reset-confirm-overlay').classList.add('visible');
    setTimeout(() => document.getElementById('reset-code-input').focus(), 100);
}

function hideResetConfirm() {
    document.getElementById('reset-confirm-overlay').classList.remove('visible');
    document.getElementById('reset-code-input').value = '';
    document.getElementById('reset-code-error').textContent = '';
}

function performReset() {
    const input = document.getElementById('reset-code-input').value.trim();
    if (input !== RESET_CODE) {
        document.getElementById('reset-code-error').textContent = 'קוד שגוי! נסה שוב.';
        document.getElementById('reset-code-input').value = '';
        document.getElementById('reset-code-input').focus();
        SoundEngine.play('wrong');
        return;
    }
    hideResetConfirm();
    Storage._cache = JSON.parse(JSON.stringify(DEFAULT_DATA));
    Storage.save();
    ensureToday();
    App.currentScreen = null;
    App.navigateTo('screen-avatar');
    renderAvatarScreen();
}

// ====== EVENT DELEGATION ======
document.addEventListener('click', (e) => {
    // Initialize sound on first click, and always try to resume (Safari needs this)
    if (!SoundEngine.ctx) {
        SoundEngine.init();
        // Play welcome sound on first interaction if we're on the welcome screen
        if (App.currentScreen === 'screen-welcome') {
            setTimeout(() => SoundEngine.play('welcome'), 100);
        }
    } else {
        SoundEngine.ensureResumed();
    }

    const id = e.target.id || e.target.closest('button')?.id;

    // Avatar screen
    if (e.target.closest('#avatar-grid')) handleAvatarClick(e);
    if (id === 'btn-avatar-continue') confirmAvatar();

    // Welcome screen
    if (id === 'btn-start-practice') { SoundEngine.play('navigate'); showNumberScreen(); }
    if (id === 'btn-review-mistakes') { SoundEngine.play('navigate'); showReviewScreen(); }
    if (id === 'btn-challenge') {
        SoundEngine.play('navigate');
        showNumberScreen();
        App.isChallenge = true;
    }
    if (id === 'btn-genius') { SoundEngine.play('navigate'); startGeniusMode(); }
    if (id === 'btn-daily-boost') { SoundEngine.play('navigate'); DailyBoost.start(); }
    if (id === 'btn-focus-mode') { SoundEngine.play('navigate'); FocusMode.start(); }
    if (id === 'btn-achievements') { SoundEngine.play('navigate'); showAchievementsScreen(); }
    if (id === 'btn-mastery') { SoundEngine.play('navigate'); showMasteryScreen(); }
    if (id === 'hint-dismiss') { hideHintOverlay(); }

    // Number selection
    if (e.target.closest('#number-grid')) handleNumberClick(e);
    if (id === 'btn-select-all') {
        SoundEngine.play('click');
        const maxN = getMaxMultiplier();
        const allSelected = App.selectedNumbers.length === maxN;
        App.selectedNumbers = allSelected ? [] : Array.from({length: maxN}, (_, i) => i + 1);
        document.querySelectorAll('.number-btn').forEach(b => {
            b.classList.toggle('selected', App.selectedNumbers.includes(parseInt(b.dataset.num)));
        });
        document.getElementById('btn-start-session').disabled = App.selectedNumbers.length === 0;
        document.getElementById('btn-select-all').textContent = allSelected ? '✅  בחר הכל' : '❌  נקה הכל';
    }
    if (id === 'btn-start-session') {
        if (App.selectedNumbers.length > 0) { SoundEngine.play('navigate'); showDifficultyScreen(); }
    }
    if (id === 'btn-back-to-welcome') showWelcomeScreen();

    // Difficulty
    if (e.target.closest('#difficulty-grid')) handleDifficultyClick(e);
    if (id === 'btn-diff-back') { SoundEngine.play('navigate'); showNumberScreen(); }

    // Practice answers
    if (e.target.closest('#practice-answers')) handleAnswerClick(e);

    // Summary
    if (id === 'btn-play-again') showNumberScreen();
    if (id === 'btn-review-after-summary') showReviewScreen();
    if (id === 'btn-summary-home') showWelcomeScreen();

    // Review
    if (id === 'btn-start-review') startReviewPractice();
    if (id === 'btn-review-home') showWelcomeScreen();

    // Achievements
    if (id === 'btn-ach-back') showWelcomeScreen();

    // Mastery board
    if (id === 'btn-mastery-back') showWelcomeScreen();
    if (id === 'mastery-detail-close') hideMasteryDetail();
    const masteryCell = e.target.closest('.mastery-cell');
    if (masteryCell && !masteryCell.classList.contains('mastery-hidden')) {
        const key = masteryCell.dataset.key;
        const row = parseInt(masteryCell.dataset.row);
        const col = parseInt(masteryCell.dataset.col);
        showMasteryDetail(key, row, col);
        SoundEngine.play('click');
    }
    const filterBtn = e.target.closest('.mastery-filter-btn');
    if (filterBtn) {
        handleMasteryFilter(filterBtn.dataset.filter);
        SoundEngine.play('click');
    }

    // Sound test
    if (id === 'btn-test-sound') {
        testSound();
        setTimeout(() => SoundEngine.play('correct'), 600);
    }

    // Genius music toggle
    if (id === 'btn-toggle-music') {
        const btn = document.getElementById('btn-toggle-music');
        if (SpaceMusic.playing) {
            SpaceMusic.stop();
            btn.classList.add('muted');
            btn.textContent = '🎵';
        } else {
            SpaceMusic.start();
            btn.classList.remove('muted');
            btn.textContent = '🎵';
        }
    }

    // Genius SFX toggle
    if (id === 'btn-toggle-sfx') {
        const btn = document.getElementById('btn-toggle-sfx');
        const data = Storage.load();
        const newState = !(data.settings.soundEnabled !== false);
        Storage.update(d => { d.settings.soundEnabled = newState; });
        btn.classList.toggle('muted', !newState);
        btn.textContent = newState ? '🔊' : '🔇';
    }

    // Max multiplier toggle
    const toggleOpt = e.target.closest('.toggle-option[data-max]');
    if (toggleOpt) {
        const newMax = parseInt(toggleOpt.dataset.max);
        SoundEngine.play('click');
        Storage.update(data => {
            if (!data.settings) data.settings = {};
            data.settings.maxMultiplier = newMax;
        });
        document.getElementById('toggle-max-10').classList.toggle('active', newMax === 10);
        document.getElementById('toggle-max-12').classList.toggle('active', newMax === 12);
    }

    // Answer count toggle
    const toggleAns = e.target.closest('.toggle-option[data-answers]');
    if (toggleAns) {
        const newCount = parseInt(toggleAns.dataset.answers);
        SoundEngine.play('click');
        Storage.update(data => {
            if (!data.settings) data.settings = {};
            data.settings.answerCount = newCount;
        });
        document.getElementById('toggle-ans-4').classList.toggle('active', newCount === 4);
        document.getElementById('toggle-ans-6').classList.toggle('active', newCount === 6);
        document.getElementById('toggle-ans-8').classList.toggle('active', newCount === 8);
    }

    // Reset data
    if (id === 'btn-reset-data') showResetConfirm();
    if (id === 'btn-reset-confirm') performReset();
    if (id === 'btn-reset-cancel') hideResetConfirm();

    // Reward popup
    if (id === 'reward-dismiss') hideRewardPopup();
});

// ====== INITIALIZATION ======
document.addEventListener('DOMContentLoaded', () => {
    Storage.load();
    DataMigration.run();
    ensureToday();
    renderBgDecorations();
    renderAvatarScreen();

    // Ensure settings field exists in stored data
    const data = Storage.load();
    if (!data.settings) {
        data.settings = { soundEnabled: true, maxMultiplier: 12 };
        Storage.save();
    }
    if (data.settings && !data.settings.maxMultiplier) {
        data.settings.maxMultiplier = 12;
        Storage.save();
    }
    if (data.settings && !data.settings.answerCount) {
        data.settings.answerCount = 4;
        Storage.save();
    }

    // Unlock audio on first touch (Safari/iOS requirement)
    const unlockAudio = () => {
        if (!SoundEngine.ctx) SoundEngine.init();
        else SoundEngine.ensureResumed();
        document.removeEventListener('touchstart', unlockAudio);
    };
    document.addEventListener('touchstart', unlockAudio, { once: true });

    if (!data.profile.avatar) {
        App.navigateTo('screen-avatar');
    } else {
        showWelcomeScreen();
    }
});
</script>
</body>
</html>
